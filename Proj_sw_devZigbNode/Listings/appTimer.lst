C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE APPTIMER
OBJECT MODULE PLACED IN .\Output\appTimer.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Usr\appTimer.c OMF2 OPTIMIZE(9,SPEED) BROWSE INCDIR(.\Usr;.\Usr_lib;.\st
                    -d_Lib;.\dataTrans;.\Actuator;.\Sensor;.\hwDriver) DEBUG PRINT(.\Listings\appTimer.lst) OBJECT(.\Output\appTimer.obj)

line level    source

   1          #include "appTimer.h"
   2          
   3          #include "STC15Fxxxx.H"
   4          
   5          #include "stdio.h"
   6          #include "string.h"
   7          
   8          #include "USART.h"
   9          
  10          #include "dataManage.h"
  11          #include "devlopeDebug.h"
  12          
  13          #include "Relay.h"
  14          #include "timerAct.h"
  15          #include "touchPad.h"
  16          #include "dataTrans.h"
  17          #include "Tips.h"
  18          #include "usrKin.h"
  19          #include "driver_I2C_HXD019D.h"
  20          #include "DS18B20.h"
  21          
  22          //***************Êý¾Ý´«Êä±äÁ¿ÒýÓÃÇø***************************/
  23          extern bit                              rxTout_count_EN;        
  24          extern u8                               rxTout_count;   //´®¿Ú½ÓÊÕ³¬Ê±¼ÆÊý
  25          extern bit                              uartRX_toutFLG;
  26          extern u8                               datsRcv_length;
  27          extern uartTout_datsRcv xdata datsRcv_ZIGB;
  28          
  29          extern u16 xdata                zigbNwkAction_counter; //zigbÍøÂçÖØÁ¬×¨ÓÃ¶¯×÷Ê±¼ä¼ÆÊý
  30          
  31          extern u16 xdata                dtReqEx_counter; //À©Õ¹ÐÍÊý¾Ý·¢ËÍ¼ä¸ô¼ÆÊ±Öµ
  32          
  33          extern bit                              heartBeatCycle_FLG;     //ÐÄÌøÖÜÆÚ´¥·¢±êÖ¾
  34          extern u8 xdata                 heartBeatCount; //ÐÄÌø¼ÆÊý
  35          extern u8 xdata                 heartBeatPeriod; //ÐÄÌøÖÜÆÚ
  36          extern u8 xdata                 heartBeatHang_timeCnt;
  37          
  38          extern u8 xdata                 colonyCtrlGet_queryCounter; 
  39          extern u8 xdata                 colonyCtrlGetHang_timeCnt;
  40          
  41          //***************°´¼üÊäÈë±äÁ¿ÒýÓÃÇø***************************/
  42          extern bit                              usrKeyCount_EN;
  43          extern u16                              usrKeyCount;
  44          
  45          extern u16 xdata                touchPadActCounter;
  46          extern u16 xdata                touchPadContinueCnt;
  47          
  48          extern u16 xdata                combinationFunFLG_3S5S_cancel_counter;
  49          
  50          //***************Tips±äÁ¿ÒýÓÃÇø***************************/
  51          extern u16 xdata                counter_tipsAct;
  52          
  53          /*-----------------------------------------------------------------------------------------------*/
  54          void appTimer0_Init(void){      //50us ÖÐ¶Ï@24.000M
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 2   

  55   1      
  56   1              AUXR |= 0x80;           
  57   1              TMOD &= 0xF0;           
  58   1              TL0   = 0x50;           
  59   1              TH0   = 0xFB;   
  60   1              TF0   = 0;      
  61   1              ET0       = 1;  //¿ªÖÐ¶Ï
  62   1              PT0   = 1;      
  63   1              
  64   1              TR0   = 1;              
  65   1      }
  66          
  67          void appTimer4_Init(void){      //50us ÖÐ¶Ï@24.000M
  68   1              
  69   1              T4T3M   |= 0x20;                
  70   1              T4L     = 0x50;         
  71   1              T4H     = 0xFB;         
  72   1              T4T3M   |= 0x80;        
  73   1      
  74   1              IE2     |= 0x40;
  75   1      }
  76          
  77          void timer0_Rountine (void) interrupt TIMER0_VECTOR{
  78   1              
  79   1      #if(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_FANS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_dIMMER)
                      {
                              
                              u8 xdata freq_periodBeatHalf = dimmer_freqParam.periodBeat_cfm / 2;
              
                              dimmer_freqParam.periodBeat_counter ++; //µçÔ´ÆµÂÊµ¥ÖÜÆÚ½ÚÅÄÊý¸üÐÂ
                              
                              if(dimmer_freqParam.pwm_actEN){         
                              
                                      dimmer_freqParam.pwm_actCounter ++;
                                      
                                      if(dimmer_freqParam.pwm_actCounter <= status_Relay && dimmer_freqParam.pwm_actCounter < freq_periodBeat
             -Half){ //Ç°°ëÖÜ
                                              
                                              PIN_PWM_OUT = 1;
                                              
                                      }else{
                                      
                                              dimmer_freqParam.pwm_actCounter = 0;
                                              dimmer_freqParam.pwm_actEN = 0;
                                              PIN_PWM_OUT = 0;
                                      }
                                      
              //                      if(dimmer_freqParam.pwm_actCounter <= freq_periodBeatHalf){
              //                      
              //                              if(dimmer_freqParam.pwm_actCounter < status_Relay){
              //                                      
              //                                      PIN_PWM_OUT = 1;
              //                                      
              //                              }else{
              //                              
              //                                      PIN_PWM_OUT = 0;
              //                              }
              //                              
              ////                            PIN_PWM_OUT = 0;
              //                      
              //                      }else
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 3   

              //                      if(dimmer_freqParam.pwm_actCounter > freq_periodBeatHalf && dimmer_freqParam.pwm_actCounter <= dimmer
             -_freqParam.periodBeat_cfm){
              //                              
              ////                            if((dimmer_freqParam.pwm_actCounter - freq_periodBeatHalf) < status_Relay){
              ////                                    
              ////                                    PIN_PWM_OUT = 1;
              ////                                    
              ////                            }else{
              ////                            
              ////                                    PIN_PWM_OUT = 0;
              ////                            }
              //                              
              //                              PIN_PWM_OUT = 0;
              
              //                      }else{
              //                      
              //                              dimmer_freqParam.pwm_actCounter = 0;
              //                              dimmer_freqParam.pwm_actEN = 0;
              //                              PIN_PWM_OUT = 0;
              //                      }
                                      
                              }else{
                              
                                      PIN_PWM_OUT = 0;
                              }
                      }
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SOCKETS)
                      u16 code period_1second = 20000;
                      static u16 counter_1second = 0; 
                      u8 code period_1second_x5 = 5;
                      static u8 counter_1second_x5 = 0; 
                      
                      if(counter_1second < period_1second)counter_1second ++; //1s
                      else{
                      
                              counter_1second = 0;
                              
                              if(counter_1second_x5 < period_1second_x5)counter_1second_x5 ++; //5s
                              else{
                              
                                      counter_1second_x5 = 0;
                                      
              //                      /*¸¡µãÊý´«Êä²âÊÔ*/
              //                      socket_eleDetParam.eleParamFun_powerFreqVal     = 111.12345F;
              //                      socket_eleDetParam.eleParam_power                               = 122.12345F;
              //                      socket_eleDetParam.ele_Consum                                   = 253.11111F;
                                      
                                      socket_eleDetParam.eleParamFun_powerFreqVal = socket_eleDetParam.eleParamFun_powerPulseCount / 5.0F; //
             -ÆµÂÊ
                                      socket_eleDetParam.eleParam_power = socket_eleDetParam.eleParamFun_powerFreqVal * (COEFFICIENT_POW - (C
             -OEFFICIENT_COMPENSATION_POW * socket_eleDetParam.eleParamFun_powerFreqVal)); //¹¦ÂÊ
                                      
                                      if(socket_eleDetParam.eleParamFun_powerFreqVal < 0.00001F)socket_eleDetParam.eleParamFun_powerFreqVal =
             - 0.00001F; //×îÐ¡ÖµÏÞ¶¨
                                      socket_eleDetParam.ele_Consum   += 1.00F * (socket_eleDetParam.eleParamFun_powerPulseCount * socket_eleDe
             -tParam.eleParam_power / (1000.00F * 3600.00F * socket_eleDetParam.eleParamFun_powerFreqVal)); //ÓÃµçÁ¿
                                      
                                      socket_eleDetParam.eleParamFun_powerPulseCount = 0.0F; //Âö³å¼ÆÊýÇåÁã
                              }
                      }
              #else
 172   1      #endif
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 4   

 173   1      }
 174          
 175          void timer4_Rountine (void) interrupt TIMER4_VECTOR{
 176   1              
 177   1              u16 code period_1second = 20000;
 178   1              static u16 counter_1second = 0; 
 179   1              
 180   1              u8 code period_1ms              = 20;
 181   1              static u8 counter_1ms   = 0; 
 182   1              
 183   1      #if(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_FANS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_dIMMER)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SOCKETS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_INFRARED)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SCENARIO)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_HEATER)
              #else
 190   1              u16 code period_200ms   = 4000; //counter_200ms¼ÆÊ±ÆµÂÊ µþ¼Ó counter5_200ms¼ÆÊ±ÆµÂÊ ¶ÔÓ¦µÄ1s¼ÆÊýÖÜÆÚ  4000
             - * 5 * 50 us = 1s
 191   1              static u16 counter_200ms = 0; 
 192   1              u8 code period5_200ms   = 5; //counter_200ms¼ÆÊ±ÆµÂÊ µþ¼Ó counter5_200ms¼ÆÊ±ÆµÂÊ ¶ÔÓ¦µÄ1s¼ÆÊýÖÜÆÚ  4000 * 
             -5 * 50 us = 1s
 193   1              static u8 counter5_200ms = 0; 
 194   1              
 195   1      #endif
 196   1              
 197   1              u8 code period_tipsColor = COLORGRAY_MAX * 3;
 198   1              static u8 counter_tipsColor = 0; 
 199   1              static color_Attr xdata cnt_relay1_Tips = {0};
 200   1              static color_Attr xdata cnt_relay2_Tips = {0};
 201   1              static color_Attr xdata cnt_relay3_Tips = {0};
 202   1              static color_Attr xdata cnt_zigbNwk_Tips = {0};
 203   1              
 204   1              static u8 xdata period_beep = 3;                //beep×¨ÓÃ
 205   1              static u8 xdata count_beep      = 0;
 206   1               
 207   1      #if(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_FANS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_dIMMER)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SOCKETS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_INFRARED)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SCENARIO)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_HEATER)
              #else
 214   1              //****************100msÌØÊâ**********************************************/
 215   1              if(counter_200ms < period_200ms)counter_200ms ++;
 216   1              else{
 217   2                      
 218   2                      counter_200ms = 0;
 219   2                      counter5_200ms ++;
 220   2              
 221   2                      /*´°Á±Âß¼­ÒµÎñ£¬°´ÕÕ¹ìµÀÊ±¼ä¶¯×÷*/
 222   2                      if(SWITCH_TYPE == SWITCH_TYPE_CURTAIN){
 223   3                      
 224   3                              switch(curtainAct_Param.act){
 225   4                              
 226   4                                      case cTact_open:{
 227   5                                              
 228   5                                              if(curtainAct_Param.act_period){ //¹ìµÀÖÜÆÚÊ±¼ä·ÇÁãÊ±²Å½øÐÐÓÐÐ§¹ìµÀÊ±¼ä¼ÆÊ±ÒµÎñ
 229   6                                              
 230   6                                                      if(curtainAct_Param.act_counter < curtainAct_Param.act_period){
 231   7                                                      
 232   7                                                              if(counter5_200ms >= period5_200ms)curtainAct_Param.act_counter ++;
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 5   

 233   7                                                              
 234   7                                                      }else{
 235   7                                                      
 236   7                                                              curtainAct_Param.act = cTact_stop;
 237   7                                                      }       
 238   6                                              }
 239   5                                              
 240   5                                      }break;
 241   4                                              
 242   4                                      case cTact_close:{
 243   5                                              
 244   5                                              if(curtainAct_Param.act_period){ //¹ìµÀÖÜÆÚÊ±¼ä·ÇÁãÊ±²Å½øÐÐÓÐÐ§¹ìµÀÊ±¼ä¼ÆÊ±ÒµÎñ
 245   6                                              
 246   6                                                      if(curtainAct_Param.act_counter > 0){
 247   7                                                      
 248   7                                                              if(counter5_200ms >= period5_200ms)curtainAct_Param.act_counter --;
 249   7                                                              
 250   7                                                      }else{
 251   7                                                      
 252   7                                                              curtainAct_Param.act = cTact_stop;
 253   7                                                      }                                               
 254   6                                              }
 255   5                                      
 256   5                                      }break;
 257   4                                              
 258   4                                      case cTact_stop:{
 259   5                                      
 260   5                                              if(status_Relay != 2){
 261   6                                              
 262   6                                                      swCommand_fromUsr.objRelay = 2;
 263   6                                                      swCommand_fromUsr.actMethod = relay_OnOff;
 264   6                                                      devActionPush_IF.push_IF = 1; //ÍÆËÍÊ¹ÄÜ
 265   6                                                      EACHCTRL_realesFLG = 1; //ÓÐÐ§»¥¿Ø´¥·¢
 266   6                                              }
 267   5                                              
 268   5                                      }break;
 269   4                                              
 270   4                                      default:{}break;
 271   4                              }
 272   3                      }
 273   2                      
 274   2                      if(counter5_200ms >= period5_200ms)counter5_200ms = 0;
 275   2              }
 276   1      #endif
 277   1              
 278   1              //****************1ms×¨ÓÃ**********************************************/
 279   1              if(counter_1ms < period_1ms)counter_1ms ++;
 280   1              else{
 281   2              
 282   2                      counter_1ms = 0;
 283   2                      
 284   2      #if(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_FANS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_dIMMER)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_INFRARED)
                              /*ºìÍâ×ª·¢×´Ì¬»ú×¨ÓÃ¶¯×÷Ê±¼ä¼ÆÊý*/
                              if(infraredAct_timeCounter)infraredAct_timeCounter --;
                              
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SOCKETS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SCENARIO)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_HEATER)
                              /*ÈÈË®Æ÷¼ÌµçÆ÷ÖÍºóÍ¬²½¼ÆÊ±¼ÆÊý*/
                              if(heater_ActParam.relayActDelay_counter != COUNTER_DISENABLE_MASK_SPECIALVAL_U16){ //ÅÐ¶Ï¼ÆÊ±ÊÇ·ñ¿ÉÓÃ£¬
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 6   

             -ÊÇ·ñÎª¼ÆÊ±Ê§Ð§ÑÚÂë
                              
                                      if(heater_ActParam.relayActDelay_counter)heater_ActParam.relayActDelay_counter --; //¼ÌµçÆ÷¶¯×÷ÖÍºóÍ¬²½
             -¼ÆÊ±ÒµÎñÂß¼­
                                      else{
                                      
                                              heater_ActParam.relayActDelay_counter = COUNTER_DISENABLE_MASK_SPECIALVAL_U16;
                                              heater_ActParam.relayActDelay_actEn = 1;
                                      }
                              }
                              
              #else
 305   2      #endif
 306   2                      
 307   2                      /*zigb×¨ÓÃ¶¯×÷Ê±¼ä¼ÆÊý*/
 308   2                      if(zigbNwkAction_counter)zigbNwkAction_counter --;
 309   2                      
 310   2                      /*ÓÃ»§°´¼ü¶¯×÷×¨ÓÃÊ±¼ä¼ÆÊý*/
 311   2                      if(usrKeyCount_EN)usrKeyCount ++;
 312   2                      else usrKeyCount = 0;
 313   2                      
 314   2                      /*´¥Ãþ°´¼ü¶¯×÷×¨ÓÃÊ±¼ä¼ÆÊý*/
 315   2                      if(touchPadActCounter)touchPadActCounter --;
 316   2                      
 317   2                      /*´¥Ãþ°´¼üÁ¬°´×¨ÓÃÊ±¼ä¼ÆÊý*/
 318   2                      if(touchPadContinueCnt)touchPadContinueCnt --;
 319   2                      
 320   2                      /*Tips¶¯×÷×¨ÓÃÊ±¼ä¼ÆÊý*/
 321   2                      if(counter_tipsAct)counter_tipsAct --;
 322   2                      
 323   2                      /*À©Õ¹ÐÔ(³ÖÐøÐÔ)Êý¾Ý·¢ËÍ¶¯×÷¼ä¸ôÊ±¼ä¼ÆÊý*/
 324   2                      if(dtReqEx_counter)dtReqEx_counter --;
 325   2                      
 326   2                      /*ÌØÊâ×éºÏ¶¯×÷°´¼ü´¥·¢ Ô¤±êÖ¾ÏÎ½ÓÊ±¼ä¼ÆÊý*/
 327   2                      if(combinationFunFLG_3S5S_cancel_counter)combinationFunFLG_3S5S_cancel_counter --;
 328   2              }
 329   1              
 330   1              //****************1s×¨ÓÃ**********************************************/
 331   1              if(counter_1second < period_1second)counter_1second ++;
 332   1              else{
 333   2              
 334   2                      counter_1second = 0;
 335   2                      
 336   2      #if(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_FANS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_dIMMER)
              //              /*µçÔ´ÆµÂÊµ¥ÖÜÆÚ½ÚÅÄÊýÍ³¼Æ*/
              //              /*>>>usr_debug<<<*/
              //              //usr_debugÊý¾ÝÌî×°
              //              dev_debugInfoLog.debugInfoData.dimmerInfo.soureFreq = dimmer_freqParam.periodBeat_cfm;
              //              //usr_debug´òÓ¡ÀàÐÍÌî×°Ìî×°
              //              dev_debugInfoLog.debugInfoType = infoType_dimmerFreq;
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_INFRARED)
                              /*ds18b20ÎÂ¶È¶ÁÈ¡ÖÜÆÚ¼ÆÊ±¼ÆÊýÒµÎñ*/
                              if(couter_ds18b20Temperature_dtPeriod)couter_ds18b20Temperature_dtPeriod --;
                              
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SOCKETS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SCENARIO)
                              /*²»Í¬³¡¾°´¥·¢°´¼üÇ¿ÖÆ¼ä¸ôÊ±¼ä¼ÆÊý*/
                              if(scenario_ActParam.scenarioKeepTrig_timeCounter != COUNTER_DISENABLE_MASK_SPECIALVAL_U8){ //ÅÐ¶Ï¼ÆÊ±ÊÇ
             -·ñ¿ÉÓÃ£¬ÊÇ·ñÎª¼ÆÊ±Ê§Ð§ÑÚÂë
                              
                                      if(scenario_ActParam.scenarioKeepTrig_timeCounter)scenario_ActParam.scenarioKeepTrig_timeCounter --;
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 7   

                                      else{
                                      
                                              scenario_ActParam.scenarioKeepTrig_timeCounter = COUNTER_DISENABLE_MASK_SPECIALVAL_U8;
              //                              scenario_ActParam.scenarioKey_currentTrig = scenarioKey_current_null; //ÔÝÊ±È¡Ïû×Ô»Ö¸´
                                      }
                              }
                              
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_HEATER)
                              /*ÈÈË®Æ÷¼ÌµçÆ÷×Ô¶¯¹Ø±ÕÄ£Ê½ÏÂ¼ÆÊ±¼ÆÊý*/
                              if(heater_ActParam.timerClose_counter != COUNTER_DISENABLE_MASK_SPECIALVAL_U16){ //ÅÐ¶Ï¼ÆÊ±ÊÇ·ñ¿ÉÓÃ£¬ÊÇ·
             -ñÎª¼ÆÊ±Ê§Ð§ÑÚÂë
                              
                                      if(heater_ActParam.timerClose_counter)heater_ActParam.timerClose_counter --; //ÈÈË®Æ÷ÑÓÊ±¹Ø±Õ¼ÆÊ±ÒµÎñÂß
             -¼­
                                      else{
                                      
                                              heater_ActParam.timerClose_counter = COUNTER_DISENABLE_MASK_SPECIALVAL_U16;
                                              
                                              if((heater_ActParam.heater_currentActMode == heaterActMode_swCloseDelay30min) || //ÑÓÊ±¹Ø±ÕÄ£Ê½ÏÂ ÒµÎñ
             -²ÅÓÐÐ§
                                                 (heater_ActParam.heater_currentActMode == heaterActMode_swCloseDelay60min)){
                                                 
                                                      swCommand_fromUsr.objRelay = 0;
                                                      swCommand_fromUsr.actMethod = relay_OnOff; //¿ª¹Ø¶¯×÷
                                                         
                                                      devActionPush_IF.push_IF = 1; //ÍÆËÍÊ¹ÄÜ
                                                      
                                                      heater_ActParam.heater_currentActMode = heaterActMode_swClose;  
                                              }
                                      }
                              }
                              
              #else
 384   2      #endif
 385   2                      /*ÐÄÌø°ü¼ÆÊ±¼ÆÊýÒµÎñ*/
 386   2                      if(!heartBeatCycle_FLG){
 387   3                      
 388   3                              if(heartBeatCount < heartBeatPeriod)heartBeatCount ++;
 389   3                              else{
 390   4                              
 391   4                                      heartBeatCount = 0;
 392   4                                      heartBeatCycle_FLG = 1;
 393   4                              }
 394   3                      }
 395   2                      
 396   2                      /*ÑÓÊ±¼ÆÊ±ÒµÎñ£¬µ½µã¶¯×÷*/
 397   2                      if(ifDelay_sw_running_FLAG & (1 << 1)){
 398   3                      
 399   3                              if(delayCnt_onoff < ((u16)delayPeriod_onoff * 60))delayCnt_onoff ++;
 400   3                              else{
 401   4                              
 402   4                                      delayPeriod_onoff = delayCnt_onoff = 0; 
 403   4                                      
 404   4                                      ifDelay_sw_running_FLAG &= ~(1 << 1);   //Ò»´ÎÐÔ±êÖ¾Çå³ý
 405   4                                      
 406   4                                      swCommand_fromUsr.actMethod = relay_OnOff; //¿ª¹Ø¶¯×÷
 407   4                                      swCommand_fromUsr.objRelay = delayUp_act;
 408   4                                      devActionPush_IF.push_IF = 1; //ÍÆËÍÊ¹ÄÜ -Ö÷¶¯ÉÏ´«
 409   4                                      dev_agingCmd_sndInitative.agingCmd_delaySetOpreat = 1; //¶ÔÓ¦Ö÷¶¯ÉÏ´«Ê±Ð§Õ¼Î»ÖÃÒ»
 410   4                                      
 411   4      #if(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_FANS)
                                              if(swCommand_fromUsr.objRelay == 4)swCommand_fromUsr.objRelay = 3; //·çÉÈÏìÓ¦ÖµÎª1¡¢2¡¢4£»Êµ¼ÊÖµÎª1¡¢2
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 8   

             -¡¢3 --×ª»»
                                              
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_dIMMER)
                                              EACHCTRL_realesFLG = 1;
                                              
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SOCKETS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_INFRARED)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SCENARIO)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_HEATER)
                                              (swCommand_fromUsr.objRelay == 0x01)?(heater_ActParam.heater_currentActMode = heaterActMode_swKeepOpen
             -):(heater_ActParam.heater_currentActMode = heaterActMode_swClose); //°´¼ü×´Ì¬Á¢Âí¸üÐÂ
                                              devHeater_actOpeartionExecute(heater_ActParam.heater_currentActMode); //¶¯×÷Ö´ÐÐ
              
              #else
 425   4                                      if(SWITCH_TYPE == SWITCH_TYPE_SWBIT1 || SWITCH_TYPE == SWITCH_TYPE_SWBIT2 || SWITCH_TYPE == SWITCH_TYP
             -E_SWBIT3)EACHCTRL_realesFLG |= (status_Relay ^ swCommand_fromUsr.objRelay); //ÓÐÐ§»¥¿Ø´¥·¢
 426   4                                      else
 427   4                                      if(SWITCH_TYPE == SWITCH_TYPE_CURTAIN)EACHCTRL_realesFLG = 1; //ÓÐÐ§»¥¿Ø´¥·¢
 428   4                                      
 429   4      #endif          
 430   4                                      /*>>>usr_debug<<<*/
 431   4                                      //usr_debugÊý¾ÝÌî×°
 432   4                                      dev_debugInfoLog.debugInfoData.delayActInfo.delayAct_Up = 1;
 433   4                                      //usr_debug´òÓ¡ÀàÐÍÌî×°Ìî×°
 434   4                                      dev_debugInfoLog.debugInfoType = infoType_delayUp;
 435   4                              }
 436   3                      }
 437   2                      
 438   2                      /*ÂÌÉ«Ä£Ê½¼ÆÊ±ÒµÎñ£¬Ñ­»·¹Ø±Õ*/
 439   2                      if((ifDelay_sw_running_FLAG & (1 << 0)) && status_Relay){
 440   3                      
 441   3                              if(delayCnt_closeLoop < ((u16)delayPeriod_closeLoop * 60))delayCnt_closeLoop ++;
 442   3                              else{
 443   4                                      
 444   4                                      delayCnt_closeLoop = 0;
 445   4                              
 446   4                                      swCommand_fromUsr.actMethod = relay_OnOff; //¿ª¹Ø¶¯×÷
 447   4                                      swCommand_fromUsr.objRelay = 0;
 448   4                                      devActionPush_IF.push_IF = 1; //ÍÆËÍÊ¹ÄÜ -Ö÷¶¯ÉÏ´«
 449   4                                      dev_agingCmd_sndInitative.agingCmd_greenModeSetOpreat = 1; //¶ÔÓ¦Ö÷¶¯ÉÏ´«Ê±Ð§Õ¼Î»ÖÃÒ»
 450   4                              
 451   4      #if(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_FANS)
                                              if(swCommand_fromUsr.objRelay == 4)swCommand_fromUsr.objRelay = 3; //·çÉÈÏìÓ¦ÖµÎª1¡¢2¡¢4£»Êµ¼ÊÖµÎª1¡¢2
             -¡¢3 --×ª»»
                                              
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_dIMMER)
                                              EACHCTRL_realesFLG = 1;
                                              
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SOCKETS)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_INFRARED)
              #elif(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_HEATER)
                                              (swCommand_fromUsr.objRelay == 0x01)?(heater_ActParam.heater_currentActMode = heaterActMode_swKeepOpen
             -):(heater_ActParam.heater_currentActMode = heaterActMode_swClose); //°´¼ü×´Ì¬Á¢Âí¸üÐÂ
                                              devHeater_actOpeartionExecute(heater_ActParam.heater_currentActMode); //¶¯×÷Ö´ÐÐ
                                              
              #else
 464   4                                      if(SWITCH_TYPE == SWITCH_TYPE_SWBIT1 || SWITCH_TYPE == SWITCH_TYPE_SWBIT2 || SWITCH_TYPE == SWITCH_TYP
             -E_SWBIT3)EACHCTRL_realesFLG |= (status_Relay ^ swCommand_fromUsr.objRelay); //ÓÐÐ§»¥¿Ø´¥·¢
 465   4                                      else
 466   4                                      if(SWITCH_TYPE == SWITCH_TYPE_CURTAIN)EACHCTRL_realesFLG = 1; //ÓÐÐ§»¥¿Ø´¥·¢
 467   4                                      
 468   4      #endif  
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 9   

 469   4                              }
 470   3                      }
 471   2                      
 472   2                      /*zigbÓ²¼þÆ÷¼þÑÓ³ÙÆô¶¯¼ÆÊ±±äÁ¿¸üÐÂ*///ÑÓ³ÙÆô¶¯
 473   2                      if(devZigbNwk_startUp_delayCounter)devZigbNwk_startUp_delayCounter --;
 474   2                      
 475   2                      /*³¡¾°ÖÜÆÚÑ¯²é¹ÒÆð¼ÆÊ±Öµ¸üÐÂ*///¹ÒÆð×÷ÓÃ<<
 476   2                      if(heartBeatHang_timeCnt)heartBeatHang_timeCnt --;
 477   2                      
 478   2                      /*ÐÄÌø¹ÒÆð¼ÆÊ±Öµ¸üÐÂ*///¹ÒÆð×÷ÓÃ<<
 479   2                      if(colonyCtrlGetHang_timeCnt)colonyCtrlGetHang_timeCnt --;
 480   2                      
 481   2                      /*ÏµÍ³Ê±¼ä±¾µØÎ¬³Ö¼ÆÊýÖµ¸üÐÂ*/
 482   2                      sysTimeKeep_counter ++;
 483   2                      
 484   2                      /*tips¿ÕÏÐÊÍ·Å¼ÆÊ±¼ÆÊýÒµÎñ*/
 485   2                      if(counter_ifTipsFree && countEN_ifTipsFree)counter_ifTipsFree --;
 486   2                      
 487   2                      /*ÏµÍ³Ê±¼äÖÜÆÚÐÂ¸üÐÂ¼ÆÊ±¼ÆÊýÒµÎñ*/
 488   2                      if(sysTimeReales_counter)sysTimeReales_counter --;
 489   2                      
 490   2                      /*zigbÍøÂç¿ª·Åµ¹¼ÆÊ±*/
 491   2                      if(tipsTimeCount_zigNwkOpen)tipsTimeCount_zigNwkOpen --;
 492   2                      
 493   2                      /*Éè±¸ÍøÂç¹ÒÆðÊ±¼äµ¹¼ÆÊ±*///¹ÒÆð×÷ÓÃ<<
 494   2                      if(devNwkHoldTime_Param.devHoldTime_counter)devNwkHoldTime_Param.devHoldTime_counter --;
 495   2                      
 496   2                      /*¼¯ÈºÊÜ¿Ø×´Ì¬ÖÜÆÚÐÔÂÖÑ¯ÖÜÆÚ¼ÆÊ±*/
 497   2                      if(colonyCtrlGet_queryCounter)colonyCtrlGet_queryCounter --;
 498   2                      
 499   2                      /*´¥ÃþIC¸´Î»Ê±¼äµ¹¼ÆÊ±*/
 500   2                      if(touchPad_resetTimeCount)touchPad_resetTimeCount --;
 501   2                      
 502   2                      /*´¥ÃþIC¸´Î»Tipsµ¹¼ÆÊ±*/
 503   2                      if(tipsTimeCount_touchReset)tipsTimeCount_touchReset --;
 504   2                      
 505   2                      /*»Ö¸´Ô¤ÖÃ¶¯×÷µ¹¼ÆÊ±*/
 506   2                      if(factoryRecover_HoldTimeCount)factoryRecover_HoldTimeCount --;
 507   2                      
 508   2                      /*»Ö¸´³ö³§Tipsµ¹¼ÆÊ±*/
 509   2                      if(tipsTimeCount_factoryRecover)tipsTimeCount_factoryRecover --;
 510   2                      
 511   2                      /*Ð­µ÷Æ÷Ê§Áª/¶ªÊ§ È·ÈÏµ¹¼ÆÊ±*/
 512   2                      if(timeCounter_coordinatorLost_detecting)timeCounter_coordinatorLost_detecting --; 
 513   2                      else{
 514   3                      
 515   3                              timeCounter_coordinatorLost_keeping ++; //Íø¹ØÊ§ÁªÀÛ¼ÆÊ±¼ä¼ÆÊ±
 516   3                      }
 517   2              }
 518   1      
 519   1              //***************´®¿Ú½ÓÊÕ³¬Ê±Ê±³¤¼ÆÊý*******************************//
 520   1              if(rxTout_count_EN){ //½ÓÊÕ³¬Ê±¼ÆÊ±Ê¹ÄÜÅÐ¶Ï
 521   2              
 522   2                      if(rxTout_count < TimeOutSet1)rxTout_count ++;
 523   2                      else{
 524   3                              
 525   3                              if(!uartRX_toutFLG && datsRcv_length >= 5){ //³¬Ê±Ê±¼äÅÐ¶Ï¼°×îÐ¡Ö¡³¤ÅÐ¶Ï
 526   4                              
 527   4                                      uartRX_toutFLG = 1;
 528   4                              
 529   4                                      memset(datsRcv_ZIGB.rcvDats, 0xff, sizeof(char) * COM_RX1_Lenth);
 530   4                                      memcpy(datsRcv_ZIGB.rcvDats, RX1_Buffer, COM_RX1_Lenth);
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 10  

 531   4                                      datsRcv_ZIGB.rcvDatsLen = datsRcv_length;
 532   4                                      
 533   4                                      /*>>>usr_debug<<<*/
 534   4                                      if(datsRcv_length != (datsRcv_ZIGB.rcvDats[1] + 5)){  //±êµÄÖ¡³¤ÅÐ¶Ï£¬ÊÇ·ñ³¬³¤
 535   5                                      
 536   5                                              //usr_debugÊý¾ÝÌî×°
 537   5                                              dev_debugInfoLog.debugInfoData.frameInfo.frameIllegal_FLG = 1;
 538   5                                              dev_debugInfoLog.debugInfoData.frameInfo.frame_aLength = RX1_Buffer[1];
 539   5                                              dev_debugInfoLog.debugInfoData.frameInfo.frame_rLength = datsRcv_length;
 540   5                                              //usr_debug´òÓ¡ÀàÐÍÌî×°Ìî×°
 541   5                                              dev_debugInfoLog.debugInfoType = infoType_frameUart;
 542   5                                              
 543   5                                      }else{
 544   5                                      
 545   5      
 546   5                                      }
 547   4                              }
 548   3                              rxTout_count_EN = 0;
 549   3                      }
 550   2              }
 551   1              
 552   1              //*******************beep¼ÆÊ±¼ÆÊýÒµÎñ**************************/
 553   1              if(count_beep < period_beep)count_beep ++;
 554   1              else{
 555   2                      
 556   2                      static u16 xdata        tips_Period = 20 * 50 / 2;
 557   2                      static u16 xdata        tips_Count      = 0;
 558   2                      static u8 xdata         tips_Loop       = 2 * 4;
 559   2                      static bit                      beeps_en        = 1;
 560   2              
 561   2                      count_beep = 0;
 562   2      
 563   2                      switch(dev_statusBeeps){ //×´Ì¬»ú
 564   3                              
 565   3                              case beepsMode_standBy:{
 566   4                                      
 567   4                                      period_beep = devTips_beep.tips_Period;
 568   4                                      tips_Period = 20 * devTips_beep.tips_time / period_beep;
 569   4                                      tips_Loop       = 2 * devTips_beep.tips_loop;
 570   4                                      tips_Count      = 0;
 571   4                                      beeps_en        = 1;
 572   4                                      dev_statusBeeps = beepsWorking;
 573   4              
 574   4                              }break;
 575   3                              
 576   3                              case beepsWorking:{
 577   4                              
 578   4                                      if(tips_Loop){
 579   5                                      
 580   5                                              if(tips_Count < tips_Period){
 581   6                                              
 582   6                                                      tips_Count ++;
 583   6                                                      (beeps_en)?(PIN_BEEP = !PIN_BEEP):(PIN_BEEP = !BEEP_OPEN_LEVEL);
 584   6                                                      
 585   6                                              }else{
 586   6                                              
 587   6                                                      tips_Count = 0;
 588   6                                                      beeps_en = !beeps_en;
 589   6                                                      tips_Loop --;
 590   6                                              }
 591   5                                              
 592   5                                      }else{
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 11  

 593   5                                      
 594   5                                              dev_statusBeeps = beepsComplete;
 595   5                                      }
 596   4                              
 597   4                              }break;
 598   3                              
 599   3                              case beepsComplete:{
 600   4                              
 601   4                                      tips_Count = 0;
 602   4                                      beeps_en = 1;
 603   4                                      PIN_BEEP = !BEEP_OPEN_LEVEL;
 604   4                                      dev_statusBeeps = beepsMode_null;
 605   4                                      
 606   4                              }break;
 607   3                      
 608   3                              default:{
 609   4                              
 610   4                                      PIN_BEEP = !BEEP_OPEN_LEVEL;
 611   4                                      
 612   4                              }break;
 613   3                      }
 614   2              }
 615   1              
 616   1              //***************tips_Led Ë¢ÐÂÒµÎñ*******************************//
 617   1              if(counter_tipsColor > period_tipsColor){       //»Ò¶ÈÖµÖµ¼ÓÔØ
 618   2              
 619   2                      counter_tipsColor = 0;
 620   2                      
 621   2                      cnt_relay1_Tips.colorGray_R = relay1_Tips.colorGray_R;
 622   2                      cnt_relay1_Tips.colorGray_G = relay1_Tips.colorGray_G;
 623   2                      cnt_relay1_Tips.colorGray_B = relay1_Tips.colorGray_B;
 624   2                      
 625   2                      cnt_relay2_Tips.colorGray_R = relay2_Tips.colorGray_R;
 626   2                      cnt_relay2_Tips.colorGray_G = relay2_Tips.colorGray_G;
 627   2                      cnt_relay2_Tips.colorGray_B = relay2_Tips.colorGray_B;
 628   2                      
 629   2                      cnt_relay3_Tips.colorGray_R = relay3_Tips.colorGray_R;
 630   2                      cnt_relay3_Tips.colorGray_G = relay3_Tips.colorGray_G;
 631   2                      cnt_relay3_Tips.colorGray_B = relay3_Tips.colorGray_B;
 632   2                      
 633   2                      cnt_zigbNwk_Tips.colorGray_R = zigbNwk_Tips.colorGray_R;
 634   2                      cnt_zigbNwk_Tips.colorGray_G = zigbNwk_Tips.colorGray_G;
 635   2                      cnt_zigbNwk_Tips.colorGray_B = zigbNwk_Tips.colorGray_B;
 636   2              }
 637   1              else{ //pwmÖ´ÐÐ
 638   2              
 639   2                      counter_tipsColor ++;
 640   2                      
 641   2      #if(SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_SOCKETS || SWITCH_TYPE_FORCEDEF == SWITCH_TYPE_INFRARED)
                              
                              if((counter_tipsColor > 0) && (counter_tipsColor <= (COLORGRAY_MAX * 1))){
                                      
                                       //Ö¸Ê¾¿ÉÓÃºË×¼
                                      if(cnt_relay1_Tips.colorGray_R && (DEV_actReserve & 0x01)){cnt_relay1_Tips.colorGray_R --; PIN_TIPS_REL
             -AY1_R = 0;}
                                      else PIN_TIPS_RELAY1_R = 1;
                                      
                              }else
                              if((counter_tipsColor > (COLORGRAY_MAX * 2)) && (counter_tipsColor <= (COLORGRAY_MAX * 3))){
                              
                                       //Ö¸Ê¾¿ÉÓÃºË×¼
                                      if(cnt_relay1_Tips.colorGray_B && (DEV_actReserve & 0x01)){cnt_relay1_Tips.colorGray_B --; PIN_TIPS_REL
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 12  

             -AY1_B = 0;}
                                      else PIN_TIPS_RELAY1_B = 1;
                              }               
              #else
 657   2                      
 658   2                      if((counter_tipsColor > 0) && (counter_tipsColor <= (COLORGRAY_MAX * 1))){
 659   3                              
 660   3                               //Ö¸Ê¾¿ÉÓÃºË×¼
 661   3                              if(cnt_relay1_Tips.colorGray_R && (DEV_actReserve & 0x01)){cnt_relay1_Tips.colorGray_R --; PIN_TIPS_REL
             -AY1_R = 0;}
 662   3                              else PIN_TIPS_RELAY1_R = 1;
 663   3                              if(cnt_relay2_Tips.colorGray_R && (DEV_actReserve & 0x02)){cnt_relay2_Tips.colorGray_R --; PIN_TIPS_REL
             -AY2_R = 0;}
 664   3                              else PIN_TIPS_RELAY2_R = 1;
 665   3                              if(cnt_relay3_Tips.colorGray_R && (DEV_actReserve & 0x04)){cnt_relay3_Tips.colorGray_R --; PIN_TIPS_REL
             -AY3_R = 0;}
 666   3                              else PIN_TIPS_RELAY3_R = 1;
 667   3                              if(cnt_zigbNwk_Tips.colorGray_R){cnt_zigbNwk_Tips.colorGray_R --; PIN_TIPS_ZIGBNWK_R = 0;}
 668   3                              else PIN_TIPS_ZIGBNWK_R = 1;
 669   3                              
 670   3                      }else
 671   2                      if((counter_tipsColor > (COLORGRAY_MAX * 1)) && (counter_tipsColor <= (COLORGRAY_MAX * 2))){
 672   3                      
 673   3                               //Ö¸Ê¾¿ÉÓÃºË×¼
 674   3                              if(cnt_relay1_Tips.colorGray_G && (DEV_actReserve & 0x01)){cnt_relay1_Tips.colorGray_G --; PIN_TIPS_REL
             -AY1_G = 0;}
 675   3                              else PIN_TIPS_RELAY1_G = 1;
 676   3                              if(cnt_relay2_Tips.colorGray_G && (DEV_actReserve & 0x02)){cnt_relay2_Tips.colorGray_G --; PIN_TIPS_REL
             -AY2_G = 0;}
 677   3                              else PIN_TIPS_RELAY2_G = 1;
 678   3                              if(cnt_relay3_Tips.colorGray_G && (DEV_actReserve & 0x04)){cnt_relay3_Tips.colorGray_G --; PIN_TIPS_REL
             -AY3_G = 0;}
 679   3                              else PIN_TIPS_RELAY3_G = 1;
 680   3                              if(cnt_zigbNwk_Tips.colorGray_G){cnt_zigbNwk_Tips.colorGray_G --; PIN_TIPS_ZIGBNWK_G = 0;}
 681   3                              else PIN_TIPS_ZIGBNWK_G = 1;
 682   3                              
 683   3                      }else
 684   2                      if((counter_tipsColor > (COLORGRAY_MAX * 2)) && (counter_tipsColor <= (COLORGRAY_MAX * 3))){
 685   3                      
 686   3                               //Ö¸Ê¾¿ÉÓÃºË×¼
 687   3                              if(cnt_relay1_Tips.colorGray_B && (DEV_actReserve & 0x01)){cnt_relay1_Tips.colorGray_B --; PIN_TIPS_REL
             -AY1_B = 0;}
 688   3                              else PIN_TIPS_RELAY1_B = 1;
 689   3                              if(cnt_relay2_Tips.colorGray_B && (DEV_actReserve & 0x02)){cnt_relay2_Tips.colorGray_B --; PIN_TIPS_REL
             -AY2_B = 0;}
 690   3                              else PIN_TIPS_RELAY2_B = 1;
 691   3                              if(cnt_relay3_Tips.colorGray_B && (DEV_actReserve & 0x04)){cnt_relay3_Tips.colorGray_B --; PIN_TIPS_REL
             -AY3_B = 0;}
 692   3                              else PIN_TIPS_RELAY3_B = 1;
 693   3                              if(cnt_zigbNwk_Tips.colorGray_B){cnt_zigbNwk_Tips.colorGray_B --; PIN_TIPS_ZIGBNWK_B = 0;}
 694   3                              else PIN_TIPS_ZIGBNWK_B = 1;
 695   3                      }
 696   2      #endif
 697   2              }
 698   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1716    ----
   CONSTANT SIZE    =      7    ----
   XDATA SIZE       =     19    ----
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.54   APPTIMER                                                              01/23/2019 16:32:39 PAGE 13  

   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
