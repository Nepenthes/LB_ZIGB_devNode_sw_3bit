C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE DATATRANS
OBJECT MODULE PLACED IN .\Output\dataTrans.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE dataTrans\dataTrans.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Usr;.\Usr_l
                    -ib;.\std_Lib;.\dataTrans;.\Actuator;.\Sensor;.\hwDriver) DEBUG PRINT(.\Listings\dataTrans.lst) OBJECT(.\Output\dataTrans
                    -.obj)

line level    source

   1          #include "dataTrans.h"
   2          
   3          #include "string.h"
   4          #include "stdio.h"
   5          
   6          #include "eeprom.h"
   7          #include "USART.h"
   8          #include "delay.h"
   9          #include "Relay.h"
  10          
  11          #include "timerAct.h"
  12          #include "pars_Method.h"
  13          #include "dataManage.h"
  14          #include "Tips.h"
  15          
  16          /**********************±¾µØÎÄ¼þ±äÁ¿¶¨ÒåÇø************************/
  17          datsAttr_datsTrans xdata datsSend_request = {0}; //Ô¶¶ËÊý¾Ý´«ÊäÇëÇó»º´æ
  18          datsAttr_datsTrans xdata datsRcv_respond = {0}; //Ô¶¶ËÊý¾Ý´«ÊäÇëÇóµÈ´ýÏìÓ¦»º´æ»º´æ
  19          remoteDataReq_method xdata devRemoteDataReqMethod = {0}; //Ô¶¶ËÊý¾ÝÇëÇó·½Ê½
  20          
  21          stt_devOpreatDataPonit xdata dev_currentDataPoint = {0}; //ÖÜÆÚÑ¯·ÃÊý¾Ýµã
  22          stt_agingDataSet_bitHold xdata  dev_agingCmd_rcvPassive = {0}; //ÖÜÆÚÑ¯·ÃÊ±Ð§Õ¼Î»Ö¸Áî»º´æ --±»¶¯½ÓÊÕ
  23          stt_agingDataSet_bitHold xdata  dev_agingCmd_sndInitative = {0}; //ÖÜÆÚÑ¯·ÃÊ±Ð§Õ¼Î»Ö¸Áî»º´æ --Ö÷¶¯ÉÏ´«
  24          u8 dtModeKeepAcess_currentCmd = DTMODEKEEPACESS_FRAMECMD_ASR; //Êý¾Ý´«ÊäÎª¶¨Ê±Ñ¯·ÃÄ£Ê½Ê±£¬Ð¯´øÑ¯·ÃÖ¸ÁîÖµ£¬
             -ÐèÒªÖ÷¶¯ÉÏ´«Ê±Ôò¸ü¸Ä´ËÖµ
  25          
  26          //zigbeeÔËÐÐ×´Ì¬ÇÐ»»±êÖ¾
  27          stt_statusChange xdata devStatus_switch = {0, status_NULL};
  28          //Êý¾ÝÇëÇóÍê³ÉºóÊÇ·ñÐèÒªÖØÆôÍøÂç
  29          bit reConnectAfterDatsReq_IF = 0; //ÓÃÓÚ»¥¿ØÍ¨Ñ¶´Ø¼´¿Ì×¢²áÌØÊâÇé¿öÏÂÊ¹ÓÃ
  30          
  31          bit coordinatorOnline_IF = 0; //Ð­µ÷Æ÷ÔÚÏß±êÖ¾
  32          
  33          //zigbÍøÂç¶¯×÷×¨ÓÃÊ±¼ä¼ÆÊý
  34          u16 xdata zigbNwkAction_counter = 0;
  35          
  36          //zigbÉè±¸ÍøÂç¹ÒÆðÊôÐÔ²ÎÊý
  37          attr_devNwkHold xdata devNwkHoldTime_Param = {0};
  38          
  39          //ÐÄÌø
  40          bit heartBeatCycle_FLG                  = 0; //ÐÄÌøÖÜÆÚ´¥·¢
  41          u8      xdata heartBeatCount            = 0; //ÐÄÌøÖÜÆÚ¼ÆÊý
  42          u8      xdata heartBeatPeriod           = PERIOD_HEARTBEAT_ASR; //ÐÄÌø¼ÆÊýÖÜÆÚ
  43          u8      xdata heartBeatHang_timeCnt = 0; //ÐÄÌø¹ÒÆð¼ÆÊ±(´ËÊý¾ÝÎª0Ê±²Å¿ÉÒÔ·¢ËÍÐÄÌø£¬·ñÔòÐÄÌø¹ÒÆð£¬ÓÃÓÚÍ¨ÐÅ±ÜÈÃ)
  44          
  45          //¼¯ÈºÊÜ¿ØÖÜÆÚÂÖÑ¯-<°üÀ¨ÓÐ»¥¿ØºÍ³¡¾°>
  46          u8      xdata colonyCtrlGet_queryCounter = COLONYCTRLGET_QUERYPERIOD; //¼¯ÈºÊÜ¿Ø×´Ì¬ÖÜÆÚÐÔÑ¯²é¼ÆÊ±¼ÆÊýÖµ 
  47          u8      xdata colonyCtrlGet_statusLocalEaCtrl[clusterNum_usr] = {0}; //¼¯Èº¿ØÖÆ-±¾µØ»¥¿Ø×´Ì¬Î»¼ÇÂ¼
  48          u8      xdata colonyCtrlGet_statusLocalScene = 0; //¼¯Èº¿ØÖÆ-±¾µØ³¡¾°×´Ì¬Î»¼ÇÂ¼
  49          u8      xdata colonyCtrlGetHang_timeCnt = 0; //¼¯ÈºÊÜ¿Ø×´Ì¬ÖÜÆÚÐÔÂÖÑ¯¹ÒÆð¼ÆÊ±(´ËÊý¾ÝÎª0Ê±²Å¿ÉÒÔ½øÐÐÖÜÆÚÑ¯²é£¬·ñ
             -ÔòÑ¯²é¹ÒÆð£¬ÓÃÓÚÍ¨ÐÅ±ÜÈÃ)
  50          
  51          //´®¿Ú½ÓÊÕ³¬Ê±±êÖ¾
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 2   

  52          bit uartRX_toutFLG      = 0;
  53          //´®¿Ú½ÓÊÕ³¬Ê±¼ÆÊý
  54          bit rxTout_count_EN = 0;
  55          u8  rxTout_count        = 0;
  56          //´®¿ÚÊý¾Ý»º´æ
  57          u8      datsRcv_length  = 0;
  58          uartTout_datsRcv xdata datsRcv_ZIGB = {{0}, 0};
  59          
  60          //zigbeeÍ¨ÐÅÏß³Ìµ±Ç°ÔËÐÐ×´Ì¬±êÖ¾
  61          threadRunning_Status devRunning_Status = status_NULL;
  62          
  63          void zigbUart_pinInit(void){
  64   1      
  65   1              //TXÍÆÍìÊä³ö
  66   1              P3M1 &= 0xFD;   
  67   1              P3M0 |= 0x02;   
  68   1              
  69   1              //RX¸ß×èÊäÈë
  70   1              P3M1 |= 0x01;
  71   1              P3M0 &= 0xFE;
  72   1              
  73   1              //TXÍÆÍìÊä³ö
  74   1              P2M1 &= ~0x08;
  75   1              P2M0 |= 0x08;
  76   1      }
  77                  
  78          /*--------------------------------------------------------------*/
  79          void uartObjZigb_Init(void){
  80   1      
  81   1              EA = 0;
  82   1      
  83   1              PS = 1;
  84   1              SCON = (SCON & 0x3f) | UART_8bit_BRTx;
  85   1      
  86   1      {
  87   2              u32 j = (MAIN_Fosc / 4) / ZIGB_BAUND;   //°´1T¼ÆËã
  88   2                      j = 65536UL - j;
  89   2              
  90   2              TH2 = (u8)(j>>8);
  91   2              TL2 = (u8)j;
  92   2      }
  93   1              AUXR &= ~(1<<4);        //Timer stop
  94   1              AUXR |= 0x01;           //S1 BRT Use Timer2;
  95   1              AUXR &= ~(1<<3);        //Timer2 set As Timer
  96   1              AUXR |=  (1<<2);        //Timer2 set as 1T mode
  97   1      
  98   1              IE2  &= ~(1<<2);        //½ûÖ¹ÖÐ¶Ï
  99   1              AUXR &= ~(1<<3);        //¶¨Ê±
 100   1              AUXR |=  (1<<4);        //Timer run enable
 101   1      
 102   1              ES        = 1;
 103   1              REN   = 1;
 104   1              P_SW1 = (P_SW1 & 0x3f) | (UART1_SW_P30_P31 & 0xc0);
 105   1              
 106   1              memset(TX1_Buffer, 0, sizeof(char) * COM_TX1_Lenth);
 107   1      
 108   1              EA = 1;
 109   1      
 110   1              PrintString1("i'm UART1 for wifi data translate !!!\n");
 111   1              PrintString1_logOut("i'm UART1 for datsLog !!!\n");
 112   1      }
 113          
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 3   

 114          ///*----------------------------
 115          //·¢ËÍ´®¿ÚÊý¾Ý
 116          //----------------------------*/
 117          //void uartObjWIFI_Send_Byte(u8 dat)    //´®¿Ú1
 118          //{
 119          //      TX1_write2buff(dat);
 120          //}
 121          
 122          //void uartObjWIFI_Send_String(char *s,unsigned char ucLength){  //´®¿Ú1
 123          //      
 124          //      uart1_datsSend(s, ucLength);
 125          //}
 126          
 127          //void rxBuff_WIFI_Clr(void){
 128          
 129          //      memset(rxBuff_WIFI, 0xff, sizeof(char) * COM_RX1_Lenth);
 130          //      COM1.RX_Cnt = 0;
 131          //}
 132          
 133          /********************* UART1(WIIF)ÖÐ¶Ïº¯Êý_×Ô¶¨ÒåÖØ¹¹************************/
 134          void UART1_Rountine (void) interrupt UART1_VECTOR
 135          {
 136   1              
 137   1              if(RI)
 138   1              {
 139   2                      RI = 0;
 140   2                      if(COM1.B_RX_OK == 0)
 141   2                      {
 142   3                              
 143   3      //                      if(COM1.RX_Cnt >= COM_RX1_Lenth)        COM1.RX_Cnt = 0;
 144   3      //                      RX1_Buffer[COM1.RX_Cnt++] = SBUF;
 145   3      //                      COM1.RX_TimeOut = TimeOutSet1;
 146   3                              
 147   3                              if(!rxTout_count_EN){
 148   4                              
 149   4                                      rxTout_count_EN = 1;
 150   4                                      rxTout_count    = 0;
 151   4                                      datsRcv_length  = 0;
 152   4                                      
 153   4                                      memset(RX1_Buffer, 0xff, sizeof(char) * COM_RX1_Lenth);
 154   4                              }
 155   3                              
 156   3                              
 157   3                              RX1_Buffer[datsRcv_length ++]   = SBUF;
 158   3                              rxTout_count = 0;
 159   3                      }
 160   2              }
 161   1      
 162   1              if(TI)
 163   1              {
 164   2                      TI = 0;
 165   2                      if(COM1.TX_read != COM1.TX_write)
 166   2                      {
 167   3                              SBUF = TX1_Buffer[COM1.TX_read];
 168   3                              if(++COM1.TX_read >= COM_TX1_Lenth)             COM1.TX_read = 0;
 169   3                      }
 170   2                      else    COM1.B_TX_busy = 0;
 171   2              }
 172   1      }
 173          
 174          /* ×Ô¶¨ÒåÐ£Ñé*///×Ô¼Ò²úÆ·Ð­Òé²ã
 175          static 
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 4   

 176          unsigned char frame_Check(unsigned char frame_temp[], u8 check_num){
 177   1        
 178   1              unsigned char loop              = 0;
 179   1              unsigned char val_Check = 0;
 180   1              
 181   1              for(loop = 0; loop < check_num; loop ++){
 182   2              
 183   2                      val_Check += frame_temp[loop];
 184   2              }
 185   1              
 186   1              val_Check  = ~val_Check;
 187   1              val_Check ^= 0xa7;
 188   1              
 189   1              return val_Check;
 190   1      }
 191          
 192          /*´ËÊý¾Ý·â×°±ØÐëÔÚÊý¾Ý°ü·¢ËÍÇ°×îºóµ÷ÓÃ£¬×Ô¶¨Òå¶ÔÏó½øÐÐÊý¾Ý·â×°*///±ÜÃâÐ£Ñé±»ÌáÇ°¶ø³ö´í
 193          static 
 194          u8 dtasTX_loadBasic_CUST(bit ifRemoteDats,
 195                                                       u8 dats_Tx[],
 196                                                       u8 datsLen_TX,
 197                                                       u8 frame_Type,
 198                                                       u8 frame_CMD,
 199                                                       bit ifSpecial_CMD){
 200   1                                                         
 201   1              dats_Tx[2]      = frame_Type;
 202   1              dats_Tx[3]      = frame_CMD;
 203   1              
 204   1              if(!ifSpecial_CMD)dats_Tx[10] = SWITCH_TYPE;    //¿ª¹ØÀàÐÍÌî³ä
 205   1              
 206   1              memcpy(&dats_Tx[5], &MAC_ID[1], 5);     //MACÌî³ä
 207   1                                                        
 208   1              dats_Tx[4]      = frame_Check(&dats_Tx[5], 28);
 209   1                                                                 
 210   1              if(ifRemoteDats){
 211   2                      
 212   2                      u8 xdata dats_Temp[64] = {0};
 213   2              
 214   2                      dats_Tx[0] = ZIGB_FRAMEHEAD_CTRLREMOTE;
 215   2                      dats_Tx[1]      = datsLen_TX + 12;
 216   2                      
 217   2                      memcpy(dats_Temp, &dats_Tx[1], datsLen_TX - 13);
 218   2                      memset(&dats_Tx[1], 0, datsLen_TX - 1);
 219   2                      memcpy(&dats_Tx[13], dats_Temp, datsLen_TX - 13);
 220   2                      memcpy(&dats_Tx[1], MAC_ID_DST, 6);
 221   2                      memcpy(&dats_Tx[8], &MAC_ID[1], 5);
 222   2                      
 223   2                      return 45;
 224   2                      
 225   2              }else{
 226   2              
 227   2                      dats_Tx[0]      = ZIGB_FRAMEHEAD_CTRLLOCAL;
 228   2                      dats_Tx[1]      = datsLen_TX;
 229   2                      
 230   2                      return 33;
 231   2              }
 232   1      }
 233          
 234          /*Êý¾ÝÒì»òÐ£Ñé*///ZNPÐ­Òé²ã
 235          static 
 236          u8 XORNUM_CHECK(u8 buf[], u8 length){
 237   1      
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 5   

 238   1              u8 loop = 0;
 239   1              u8 valXOR = buf[0];
 240   1              
 241   1              for(loop = 1;loop < length;loop ++)valXOR ^= buf[loop];
 242   1              
 243   1              return valXOR;
 244   1      }
 245          
 246          /*zigbeeÊý¾ÝÖ¡¼ÓÔØ*/
 247          static 
 248          u8 ZigB_TXFrameLoad(u8 frame[],u8 cmd[],u8 cmdLen,u8 dats[],u8 datsLen){                
 249   1      
 250   1              const u8 frameHead = ZIGB_FRAME_HEAD;   //ZNP,SOFÖ¡Í·
 251   1              u8 xor_check = datsLen;                                 //Òì»òÐ£Ñé£¬Ö¡Î²
 252   1              u8 loop = 0;
 253   1              u8 ptr = 0;
 254   1              
 255   1              frame[ptr ++] = frameHead;
 256   1              frame[ptr ++] = datsLen;
 257   1              
 258   1              memcpy(&frame[ptr],cmd,cmdLen);
 259   1              ptr += cmdLen;
 260   1              for(loop = 0;loop < cmdLen;loop ++)xor_check ^= cmd[loop];
 261   1      
 262   1              memcpy(&frame[ptr],dats,datsLen);
 263   1              ptr += datsLen;
 264   1              for(loop = 0;loop < datsLen;loop ++)xor_check ^= dats[loop];    
 265   1              
 266   1              frame[ptr ++] = xor_check;
 267   1              
 268   1              return ptr;
 269   1      }
 270          
 271          /*ÖÜÆÚÐÔÖ÷¶¯·¢ÂëÍ¨ÐÅ¹ÒÆð*/
 272          void periodDataTrans_momentHang(u8 hangTime){ //¹ÒÆðÊ±¼ä µ¥Î»£ºs
 273   1      
 274   1              heartBeatCount = 0;
 275   1              colonyCtrlGet_queryCounter = COLONYCTRLGET_QUERYPERIOD;
 276   1              
 277   1              heartBeatHang_timeCnt = colonyCtrlGetHang_timeCnt = hangTime;
 278   1      }
 279          
 280          /*zigbeeµ¥Ö¸ÁîÊý¾ÝÇëÇó£¬·µ»ØÓ¦´ðÊý¾Ý³¤¶È*/
 281          static 
 282          u8 zigb_datsRequest( u8 frameREQ[],             //ÇëÇóÖ¡
 283                                                   u8 frameREQ_Len,       //ÇëÇóÖ¡³¤
 284                                                   u8 resp_cmd[2],        //ËùÐèÓ¦´ðÖ¸Áî
 285                                                   u8 resp_dats[],        //Ó¦´ðÊý¾Ý»º´æ
 286                                                   u8 loopReapt,u16 timeWait){    //Ñ­»·´ÎÊý£¬µ¥´ÎµÈ´ýÊ±¼ä
 287   1                                                
 288   1              u16 Local_Delay = timeWait;             
 289   1              u8      loop = 0;
 290   1                                                       
 291   1              for(loop = 0;loop < loopReapt;loop ++){
 292   2              
 293   2                      uartRX_toutFLG = 0;
 294   2                      zigbNwkAction_counter = timeWait;       
 295   2                  uartZigB_datsSend(frameREQ, frameREQ_Len);
 296   2                      
 297   2                      while(zigbNwkAction_counter){ //¶¨Ê±Æ÷ÖÐ¶ÏÄÚ½øÐÐµ¹¼ÆÊ±
 298   3      
 299   3                              if(uartRX_toutFLG){
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 6   

 300   4                              
 301   4                                      uartRX_toutFLG = 0;
 302   4                                      
 303   4                                      if(!memcmp(&(datsRcv_ZIGB.rcvDats[2]), resp_cmd, 2)){
 304   5                                      
 305   5                                              memcpy(resp_dats, datsRcv_ZIGB.rcvDats, datsRcv_ZIGB.rcvDatsLen);
 306   5                                              return datsRcv_ZIGB.rcvDatsLen;
 307   5                                              
 308   5                                      }
 309   4                              }
 310   3                      }
 311   2              }       
 312   1      
 313   1              return 0;
 314   1      }
 315          
 316          /*zigbeeµ¥Ö¸ÁîÏÂ·¢¼°ÏìÓ¦ÑéÖ¤*///×èÈû
 317          bit zigb_VALIDA_INPUT(u8 REQ_CMD[2],            //Ö¸Áî
 318                                                    u8 REQ_DATS[],                //Êý¾Ý
 319                                                    u8 REQdatsLen,                //Êý¾Ý³¤¶È
 320                                                    u8 ANSR_frame[],              //ÏìÓ¦Ö¡
 321                                                    u8 ANSRdatsLen,               //ÏìÓ¦Ö¡³¤¶È
 322                                                    u8 times,u16 timeDelay){      //Ñ­»·´ÎÊý£¬µ¥´ÎµÈ´ýÊ±¼ä
 323   1                                                 
 324   1      #define dataLen_validaInput     96
 325   1              u8 xdata dataTXBUF[dataLen_validaInput] = {0};
 326   1              u8      loop = 0;
 327   1              u8      datsTX_Len;
 328   1      
 329   1              datsTX_Len = ZigB_TXFrameLoad(dataTXBUF,REQ_CMD, 2, REQ_DATS, REQdatsLen);
 330   1      
 331   1              for(loop = 0;loop < times;loop ++){
 332   2              
 333   2                      uartRX_toutFLG = 0;
 334   2                      zigbNwkAction_counter = timeDelay;
 335   2                      uartZigB_datsSend(dataTXBUF, datsTX_Len);
 336   2                      
 337   2                      while(zigbNwkAction_counter){ //¶¨Ê±Æ÷ÖÐ¶ÏÄÚ½øÐÐµ¹¼ÆÊ±
 338   3                              
 339   3                              if(uartRX_toutFLG){
 340   4                              
 341   4                                      uartRX_toutFLG = 0;
 342   4                                      
 343   4                                      if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, ANSR_frame, ANSRdatsLen)){
 344   5                                      
 345   5                                              delayMs(2);
 346   5                                              return 1;
 347   5                                      }
 348   4                              }
 349   3                      }
 350   2              }
 351   1              
 352   1              return 0;
 353   1      }
 354          
 355          ///*zigbeeÍ¨ÐÅ´ØÉèÖÃ*///×èÈû
 356          //bit zigb_clusterSet(u16 deviveID, u8 endPoint){
 357          
 358          //      datsAttr_ZigbInit code default_param = {{0x24,0x00},{0x0E,0x0D,0x00,0x0D,0x00,0x0D,0x00,0x01,0x00,0x00,
             -0x01,0x00,0x00},0x0D,{0xFE,0x01,0x64,0x00,0x00,0x65},0x06,300};       //Êý¾Ý´Ø×¢²á,Ä¬ÈÏ²ÎÊý
 359          //      u8 code frameResponse_Subs[6] = {0xFE,0x01,0x64,0x00,0xB8,0xDD}; //ÏìÓ¦Ö¡Ìæ²¹£¬ÈôÊý¾Ý´ØÒÑ¾­×¢²á
 360          //              
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 7   

 361          //#define       dataLen_zigbClusterSet  64
 362          //      u8 xdata paramTX_temp[dataLen_zigbClusterSet] = {0};
 363          //      
 364          //      bit setResult = 0;
 365          //      
 366          //      memcpy(paramTX_temp, default_param.zigbInit_reqDAT, default_param.reqDAT_num);
 367          //      paramTX_temp[0] = endPoint;
 368          //      paramTX_temp[3] = (u8)((deviveID & 0x00ff) >> 0);
 369          //      paramTX_temp[4] = (u8)((deviveID & 0xff00) >> 8);
 370          //      
 371          //      setResult =  zigb_VALIDA_INPUT( (u8 *)default_param.zigbInit_reqCMD,
 372          //                                                                      (u8 *)paramTX_temp,
 373          //                                                                      default_param.reqDAT_num,
 374          //                                                                      (u8 *)default_param.zigbInit_REPLY,
 375          //                                                                      default_param.REPLY_num,
 376          //                                                                      2,              //2´ÎÒÔÄÚÃ»ÓÐÕýÈ·ÏìÓ¦¾ÍÊ§°Ü
 377          //                                                                      default_param.timeTab_waitAnsr);
 378          //      
 379          //      if(setResult)return setResult;
 380          //      else{
 381          //      
 382          //              return zigb_VALIDA_INPUT((u8 *)default_param.zigbInit_reqCMD,
 383          //                                                               (u8 *)paramTX_temp,
 384          //                                                               default_param.reqDAT_num,
 385          //                                                               (u8 *)frameResponse_Subs,
 386          //                                                               6,
 387          //                                                               2,             //2´ÎÒÔÄÚÃ»ÓÐÕýÈ·ÏìÓ¦¾ÍÊ§°Ü
 388          //                                                               default_param.timeTab_waitAnsr);
 389          //      }
 390          //}
 391          
 392          ///*zigbeeÖØÐÂÈëÍø*///×èÈûº¯Êý£¬½ö¹©²âÊÔÊ¹ÓÃ
 393          //bit ZigB_NwkJoin(u16 PANID, u8 CHANNELS){
 394          
 395          //#define       cmdNum_zigbNwkJoin      8       
 396          //      
 397          //#define        loop_PANID             5
 398          //#define        loop_CHANNELS  6
 399          
 400          //      datsAttr_ZigbInit code ZigbInit_dats[cmdNum_zigbNwkJoin] = {
 401          //              
 402          //              {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      
             -//¸´Î»
 403          //              {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      
             -//¸´Î»
 404          //              {       {0x26,0x05},    {0x03,0x01,0x03},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //¼Ä´æÆ÷³
             -õÊ¼»¯£¬È«²¿Çå¿Õ
 405          //              {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      
             -//¶þ´Î¸´Î»
 406          //              
 407          ////            {       {0x26,0x05},    {0x87,0x01,0x00},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«É
             -èÖÃ£¨Ð­µ÷Æ÷£©
 408          //              {       {0x26,0x05},    {0x87,0x01,0x01},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«ÉèÖ
             -Ã£¨Â·ÓÉÆ÷£©
 409          ////            {       {0x26,0x05},    {0x87,0x01,0x02},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«É
             -èÖÃ£¨ÖÕ¶Ë£©
 410          //              
 411          //              {       {0x27,0x02},    {0x34,0x12},                    0x02,   {0xFE,0x01,0x67,0x02,0x00,0x64},                                                        0x06,   500             },      //PAN_ID¼Ä´æÆ
             -÷ÉèÖÃ
 412          //              {       {0x27,0x03},    {0x00,0x80,0x00,0x00},  0x04,   {0xFE,0x01,0x67,0x03,0x00,0x65},                                                        0x06,   500             },      //ÐÅµ
             -À¼Ä´æÆ÷ÅäÖÃ
 413          ////            {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x09,0x8D},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 8   

             -¶¨½ÇÉ«Ð­µ÷Æ÷£¨Ð­µ÷Æ÷ÏìÓ¦£©
 414          //              {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x07,0x83},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È¶¨
             -½ÇÉ«Ð­µ÷Æ÷£¨Â·ÓÉÆ÷ÏìÓ¦£©
 415          ////            {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x06,0x82},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È
             -¶¨½ÇÉ«Ð­µ÷Æ÷£¨ÖÕ¶ËÏìÓ¦£©
 416          //      };
 417          //      
 418          //#define       dataLen_zigbNwkJoin 64
 419          //      u8 xdata paramTX_temp[dataLen_zigbNwkJoin] = {0};
 420          //      
 421          //      u8  loop;
 422          //      u32 chnl_temp = 0x00000800UL << CHANNELS;
 423          //      
 424          //      for(loop = 1; loop < cmdNum_zigbNwkJoin; loop ++){
 425          //              
 426          //              memset(paramTX_temp, 0, dataLen_zigbNwkJoin * sizeof(u8));
 427          //              
 428          //              switch(loop){   //×ÔÑ¡²ÎÊý&Ä¬ÈÏ²ÎÊý
 429          //              
 430          //                      case loop_PANID:{
 431          //                      
 432          //                              paramTX_temp[0] = (u8)((PANID & 0x00ff) >> 0);
 433          //                              paramTX_temp[1] = (u8)((PANID & 0xff00) >> 8);
 434          //                              
 435          //                      }break;
 436          //                      
 437          //                      case loop_CHANNELS:{
 438          //                      
 439          //                              paramTX_temp[0] = (u8)((chnl_temp & 0x000000ff) >>  0);
 440          //                              paramTX_temp[1] = (u8)((chnl_temp & 0x0000ff00) >>  8);
 441          //                              paramTX_temp[2] = (u8)((chnl_temp & 0x00ff0000) >> 16);
 442          //                              paramTX_temp[3] = (u8)((chnl_temp & 0xff000000) >> 24);
 443          //                              
 444          //                      }break;
 445          //                      
 446          //                      default:{
 447          //                      
 448          //                              memcpy(paramTX_temp,ZigbInit_dats[loop].zigbInit_reqDAT,ZigbInit_dats[loop].reqDAT_num);
 449          //                              
 450          //                      }break;
 451          //              }
 452          //      
 453          //              delayMs(100);
 454          //              if(0 == zigb_VALIDA_INPUT((u8 *)ZigbInit_dats[loop].zigbInit_reqCMD,
 455          //                                                                (u8 *)paramTX_temp,
 456          //                                                                ZigbInit_dats[loop].reqDAT_num,
 457          //                                                                (u8 *)ZigbInit_dats[loop].zigbInit_REPLY,
 458          //                                                                ZigbInit_dats[loop].REPLY_num,
 459          //                                                                3,
 460          //                                                                ZigbInit_dats[loop].timeTab_waitAnsr)
 461          //                                                               )loop = 0;
 462          //      }
 463          //      
 464          //      return zigb_clusterSet(13, 13); //Éè±¸ID 13£¬ÖÕ¶Ëµã 13£»
 465          //}
 466          
 467          /*zigbee Ö÷¶¯¿ª·ÅÍøÂç*///×èÈû
 468          bit ZigB_nwkOpen(bit openIF, u8 openTime){
 469   1      
 470   1              datsAttr_ZigbInit code default_param = {{0x26,0x08}, {0xFC,0xFF,0x00}, 0x03, {0xFE,0x01,0x66,0x08,0x00,0x
             -6F}, 0x06, 150}; //zigbeeÖ¸ÁîÏÂ´ïÄ¬ÈÏ²ÎÊý
 471   1              
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 9   

 472   1              bit resultSet = 0;
 473   1              
 474   1              u8 openTime_temp = 0;
 475   1              
 476   1      #define paramLen_zigbNwkOpen 3
 477   1              u8 xdata paramTX_temp[paramLen_zigbNwkOpen] = {0xFC,0xFF,0x00};
 478   1              
 479   1              (openIF)?(paramTX_temp[2] = openTime):(paramTX_temp[2] = 0);
 480   1              
 481   1              resultSet = zigb_VALIDA_INPUT((u8 *)default_param.zigbInit_reqCMD,
 482   1                                                                        (u8 *)paramTX_temp,
 483   1                                                                        default_param.reqDAT_num,
 484   1                                                                        (u8 *)default_param.zigbInit_REPLY,
 485   1                                                                        default_param.REPLY_num,
 486   1                                                                        2,    //2´ÎÎÞ»Ø¸´ÎªÊ§°Ü
 487   1                                                                        default_param.timeTab_waitAnsr);
 488   1      
 489   1      #if(DEBUG_LOGOUT_EN == 1)       
 490   1      //      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
 491   1      //              u8 xdata log_buf[64];
 492   1      //              
 493   1      //              sprintf(log_buf, "nwkOpen result:%d.\n", (int)resultSet);
 494   1      //              PrintString1_logOut(log_buf);
 495   1      //      }
 496   1      #endif
 497   1              
 498   1              return resultSet;
 499   1      }
 500          
 501          /*zigbee PANID»ñÈ¡*///×èÈû
 502          static u16 ZigB_getPanIDCurrent(void){
 503   1      
 504   1              u16 PANID_temp = 0;
 505   1              
 506   1      #define paramLen_zigbPanIDGet 32
 507   1              u8 xdata paramTX_temp[paramLen_zigbPanIDGet] = {0};
 508   1              
 509   1              u8 code frameREQ_zigbPanIDGet[6] = {0xFE, 0x01, 0x26, 0x06, 0x06, 0x27};        //zigb PANID»ñÈ¡Ö¸ÁîÖ¡
 510   1              u8 code cmdResp_zigbPanIDGet[2]  = {0x66, 0x06};        //zigb PANID»ñÈ¡Ô¤ÆÚÏìÓ¦Ö¸Áî
 511   1              u8 datsResp_Len = 0;
 512   1      
 513   1              datsResp_Len = zigb_datsRequest(frameREQ_zigbPanIDGet, 6, cmdResp_zigbPanIDGet, paramTX_temp, 2, 300);
 514   1      
 515   1              if(datsResp_Len){
 516   2      
 517   2                      PANID_temp |= (((u16)(paramTX_temp[5]) << 0) & 0x00FF);
 518   2                      PANID_temp |= (((u16)(paramTX_temp[6]) << 8) & 0xFF00);
 519   2      
 520   2      //              printf_datsHtoA("[Tips_uartZigb]: resultDats:", local_datsParam->frameResp, local_datsParam->frameResp
             -Len);
 521   2              }
 522   1      
 523   1              return PANID_temp;
 524   1      }
 525          
 526          /*zigbeeÏµÍ³Ê±¼ä»ñÈ¡²¢¸üÐÂ*///×èÈû
 527          static bit getSystemTime_reales(void){
 528   1              
 529   1              bit resultOpreat = 0;
 530   1      
 531   1      #define paramLen_zigbSystimeGet 32
 532   1              u8 xdata paramTX_temp[paramLen_zigbSystimeGet] = {0};
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 10  

 533   1              
 534   1              u8 code frameREQ_zigbSystimeGet[5] = {0xFE, 0x00, 0x21, 0x11, 0x30};    //zigb PANID»ñÈ¡Ö¸ÁîÖ¡
 535   1              u8 code cmdResp_zigbSystimeGet[2]  = {0x61, 0x11};      //zigb PANID»ñÈ¡Ô¤ÆÚÏìÓ¦Ö¸Áî
 536   1              u8 datsResp_Len = 0;
 537   1      
 538   1              datsResp_Len = zigb_datsRequest(frameREQ_zigbSystimeGet, 5, cmdResp_zigbSystimeGet, paramTX_temp, 2, 300)
             -;
 539   1              
 540   1              if(!datsResp_Len)resultOpreat = 0;
 541   1              else{
 542   2                      
 543   2                      u16 Y_temp16 = ((u16)paramTX_temp[13] << 0) | ((u16)paramTX_temp[14] << 8);
 544   2                      u8  Y_temp8 = 0;
 545   2                      u8  M_temp8 = 0;
 546   2                      
 547   2                      u8 Y = (u8)(Y_temp16 % 2000);
 548   2                      u8 M = paramTX_temp[11];
 549   2                      u8 D = paramTX_temp[12];
 550   2                      u8 W = 0;
 551   2                      
 552   2                      /*¼ÆËã»º´æ¸³Öµ*/
 553   2                      Y_temp8 = Y;
 554   2                      if(M == 1 || M == 2){ //Ò»ÔÂºÍ¶þÔÂµ±×÷ÉÏÒ»ÄêÊ®ÈýÔÂºÍÊ®ËÄÔÂ
 555   3                      
 556   3                              M_temp8 = M + 12;
 557   3                              Y_temp8 --;
 558   3                      }
 559   2                      else M_temp8 = M;
 560   2                      
 561   2                      /*¿ªÊ¼¼ÆËã*/
 562   2                      W =      Y_temp8 + (Y_temp8 / 4) + 5 - 40 + (26 * (M_temp8 + 1) / 10) + D - 1;  //²ÌÀÕ¹«Ê½
 563   2                      W %= 7; 
 564   2                      
 565   2                      /*¼ÆËã½á¹û¸³Öµ*/
 566   2                      W?(systemTime_current.time_Week = W):(systemTime_current.time_Week = 7);
 567   2                      
 568   2                      systemTime_current.time_Month =         M;
 569   2                      systemTime_current.time_Day =           D;
 570   2                      systemTime_current.time_Year =          Y;
 571   2                      
 572   2                      systemTime_current.time_Hour =          paramTX_temp[8];
 573   2                      systemTime_current.time_Minute =        paramTX_temp[9];
 574   2                      systemTime_current.time_Second =        paramTX_temp[10];
 575   2                      
 576   2                      /*±¾µØÊ±¼äÎ¬³Ö¼ÆÊýÖµÐ£×¼¸üÐÂ*/
 577   2                      sysTimeKeep_counter = systemTime_current.time_Minute * 60 + systemTime_current.time_Second; //ÏµÍ³Ê±¼äÎ¬
             -³Ö¼ÆÊýÖµ¸üÐÂ
 578   2                      
 579   2                      resultOpreat = 1;
 580   2              }
 581   1              
 582   1      #if(DEBUG_LOGOUT_EN == 1)       
 583   1      //      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
 584   1      //              u8 xdata log_buf[64];
 585   1      //              
 586   1      //              sprintf(log_buf, "sysTime reales result:%d.\n", (int)resultOpreat);
 587   1      //              PrintString1_logOut(log_buf);
 588   1      //      }
 589   1      #endif
 590   1              
 591   1              return resultOpreat;
 592   1      }
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 11  

 593          
 594          /*zigbeeÏµÍ³Ê±¼äÉèÖÃ*///×èÈû
 595          static
 596          bit zigB_sysTimeSet(u32 timeStamp, bit timeZoneAdjust_IF){
 597   1      
 598   1              datsAttr_ZigbInit code default_param = {{0x21,0x10},{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x
             -00},0x0B,{0xFE,0x01,0x61,0x10,0x00},0x05,100}; //zigbeeÖ¸ÁîÏÂ´ïÄ¬ÈÏ²ÎÊý
 599   1              u8 xdata timeStampArray[0x0B] = {0};
 600   1              bit resultSet = 0;
 601   1              u32 timeStamp_temp = timeStamp;
 602   1              
 603   1              if(timeZoneAdjust_IF){ //ÊÇ·ñÐèÒªÊ±Çøµ÷Õû
 604   2              
 605   2                      if(sysTimeZone_H <= 12){
 606   3                      
 607   3                              timeStamp_temp += (3600UL * (long)sysTimeZone_H + 60UL * (long)sysTimeZone_M); //Ê±ÇøÕý
 608   3                              
 609   3                      }else
 610   2                      if(sysTimeZone_H > 12 && sysTimeZone_H <= 24){
 611   3                      
 612   3                              timeStamp_temp -= (3600UL * (long)(sysTimeZone_H - 12) + 60UL * (long)sysTimeZone_M); //Ê±Çø¸º
 613   3                              
 614   3                      }else
 615   2                      if(sysTimeZone_H >= 30){
 616   3                      
 617   3                              timeStamp_temp += (3600UL * (long)(sysTimeZone_H - 17) + 60UL * (long)sysTimeZone_M); //Ê±ÇøÌØÊâ
 618   3                      }
 619   2              }
 620   1      
 621   1              timeStampArray[0] = (u8)((timeStamp_temp & 0x000000ff) >> 0);
 622   1              timeStampArray[1] = (u8)((timeStamp_temp & 0x0000ff00) >> 8);
 623   1              timeStampArray[2] = (u8)((timeStamp_temp & 0x00ff0000) >> 16);
 624   1              timeStampArray[3] = (u8)((timeStamp_temp & 0xff000000) >> 24);
 625   1              
 626   1              resultSet = zigb_VALIDA_INPUT((u8 *)default_param.zigbInit_reqCMD,
 627   1                                                                        (u8 *)timeStampArray,
 628   1                                                                        default_param.reqDAT_num,
 629   1                                                                        (u8 *)default_param.zigbInit_REPLY,
 630   1                                                                        default_param.REPLY_num,
 631   1                                                                        2,    //2´ÎÎÞ»Ø¸´ÎªÊ§°Ü
 632   1                                                                        default_param.timeTab_waitAnsr);
 633   1              
 634   1      #if(DEBUG_LOGOUT_EN == 1)       
 635   1      //      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
 636   1      //              u8 xdata log_buf[64];
 637   1      //              
 638   1      //              sprintf(log_buf, "sysTime set result:%d.\n", (int)resultSet);
 639   1      //              PrintString1_logOut(log_buf);
 640   1      //      }
 641   1      #endif
 642   1              
 643   1              return resultSet;
 644   1      }
 645          
 646          ///*zigbeeÓ²¼þ¸´Î»³õÊ¼»¯*///×èÈû
 647          //bit ZigB_resetInit(void){
 648          
 649          //#define zigbInit_loopTry              3
 650          //#define zigbInit_onceWait     5000
 651          
 652          //      u8 code initCmp_Frame[11] = {0xFE, 0x06, 0x41, 0x80, 0x01, 0x02, 0x00, 0x02, 0x06, 0x03, 0xC3};
 653          //      
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 12  

 654          //      u8      loop = 0;
 655          //      u16 timeWait = 0;
 656          //      
 657          //      for(loop = 0; loop < zigbInit_loopTry; loop ++){
 658          //      
 659          //              zigbPin_RESET = 0;
 660          //              delayMs(100);
 661          //              zigbPin_RESET = 1;
 662          //              
 663          //              timeWait = zigbInit_onceWait;
 664          //              while(timeWait --){
 665          //              
 666          //                      delayMs(2);     //±ØÐëÑÓÊ±
 667          //                      if(uartRX_toutFLG){
 668          //                      
 669          //                              uartRX_toutFLG = 0;
 670          //                              
 671          //                              if(!memcmp(datsRcv_ZIGB.rcvDats, initCmp_Frame, 11)){
 672          //                              
 673          //                                      return 1;
 674          //                                      
 675          //                              }else{
 676          //                                      
 677          //                                      delayMs(1);     //±ØÐëÑÓÊ±
 678          //                              }
 679          //                      }
 680          //              }
 681          //      }
 682          //      
 683          //      return 0;
 684          //}
 685          
 686          ///*zigbee³õÊ¼»¯×Ô¼ì*///×èÈû
 687          //bit ZigB_inspectionSelf(void){        
 688          //      
 689          //#define       paramLen_zigbInspection 64
 690          //      u8 xdata paramTX_temp[paramLen_zigbInspection] = {0};
 691          //      
 692          ////    bit REQResult = 0;
 693          //      
 694          ////    u8 code frameREQ_zigbStatusCheck[5] = {0xFE, 0x00, 0x27, 0x00, 0x27};   //zigb×´Ì¬²éÑ¯Ö¸ÁîÖ¡
 695          ////    u8 code cmdResp_zigbStatusCheck[2]      = {0x67, 0x00}; //zigb×´Ì¬²éÑ¯ÏìÓ¦Ö¸Áî
 696          //      u8 code frameREQ_zigbJoinNWK[5]         = {0xFE, 0x00, 0x26, 0x00, 0x26};       //zigb¼¤»îÍøÂçÖ¸ÁîÖ¡
 697          //      u8 code cmdResp_zigbJoinNWK[2]          = {0x45, 0xC0}; //zigb¼¤»îÍøÂçÏìÓ¦Ö¸Áî
 698          //      u8 datsResp_Len = 0;
 699          //      
 700          ////    datsResp_Len = zigb_datsRequest(frameREQ_zigbStatusCheck, 5, cmdResp_zigbStatusCheck, paramTX_temp, 2
             -, 500);
 701          ////    if(paramTX_temp[16] == 0x07)REQResult
 702          //      
 703          //      datsResp_Len = zigb_datsRequest(frameREQ_zigbJoinNWK, 5, cmdResp_zigbJoinNWK, paramTX_temp, 2, 5000);
 704          //      if(paramTX_temp[4] == 0x07)return (zigb_clusterSet(13, 13) & zigb_clusterSet(13, 14));  //Éè±¸ID 13£¬ÖÕ¶
             -Ëµã 13£»        
 705          //      else{
 706          //      
 707          //              return 0;
 708          //      }
 709          //}
 710          
 711          /*zigbee·Ç×èÈûÈëÍøÇëÇó×´Ì¬»ú*///·Ç×èÈû ---ÐÅµÀÄ¬ÈÏµÚËÄÐÅµÀ
 712          static 
 713          void zigB_nwkJoinRequest(bit reJoin_IF){
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 13  

 714   1      
 715   1      #define cmdNum_zigbNwkREQ       9       
 716   1      
 717   1              datsAttr_ZigbInit code ZigbInit_dats[cmdNum_zigbNwkREQ] = {
 718   1      
 719   1                      {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      //
             -¸´Î»(Ó²¼þ)
 720   1      //              {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x00,0x02,0x00,0x02,0x06,0x03,0xC2},       0x0B,   4000    },      
             -//¸´Î»(Ìæ²¹)
 721   1                      {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      //
             -¸´Î»(Èí¼þ)
 722   1                      {       {0x26,0x05},    {0x03,0x01,0x03},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //¼Ä´æÆ÷³õÊ
             -¼»¯£¬È«²¿Çå¿Õ
 723   1                      {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      //
             -¶þ´Î¸´Î»(Èí¼þ)
 724   1                      
 725   1      //              {       {0x26,0x05},    {0x87,0x01,0x00},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«ÉèÖ
             -Ã£¨Ð­µ÷Æ÷£©
 726   1                      {       {0x26,0x05},    {0x87,0x01,0x01},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«ÉèÖÃ£
             -¨Â·ÓÉÆ÷£©
 727   1      //              {       {0x26,0x05},    {0x87,0x01,0x02},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«ÉèÖ
             -Ã£¨ÖÕ¶Ë£©
 728   1                      
 729   1                      {       {0x27,0x02},    {0xFF,0xFF},                    0x02,   {0xFE,0x01,0x67,0x02,0x00,0x64},                                                        0x06,   500             },      //PAN_ID¼Ä´æÆ÷É
             -èÖÃ
 730   1                      {       {0x27,0x03},    {0x00,0x80,0x00,0x00},  0x04,   {0xFE,0x01,0x67,0x03,0x00,0x65},                                                        0x06,   500             },      //ÐÅµÀ¼
             -Ä´æÆ÷ÅäÖÃ
 731   1      //              {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x09,0x8D},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È¶¨
             -½ÇÉ«Ð­µ÷Æ÷£¨Ð­µ÷Æ÷ÏìÓ¦£©
 732   1                      {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x07,0x83},                                                        0x06,   8000    },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È¶¨½ÇÉ
             -«Ð­µ÷Æ÷£¨Â·ÓÉÆ÷ÏìÓ¦£©
 733   1      //              {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x06,0x82},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È¶¨
             -½ÇÉ«Ð­µ÷Æ÷£¨ÖÕ¶ËÏìÓ¦£©
 734   1                      {       {0x26,0x08},    {0xFC,0xFF,0x00},               0x03,   {0xFE,0x01,0x66,0x08,0x00,0x6F},                                                        0x06,   150             },  //¹Ø±Õ
             -ÍøÂç
 735   1              };
 736   1              
 737   1              datsAttr_ZigbInit code defaultParam_clusterRegister = {{0x24,0x00},{0x0E,0x0D,0x00,0x0D,0x00,0x0D,0x00,0x
             -01,0x00,0x00,0x01,0x00,0x00},0x0D,{0xFE,0x01,0x64,0x00,0x00,0x65},0x06,500};  //Êý¾Ý´Ø×¢²á,Ä¬ÈÏ²ÎÊý
 738   1              u8 code frameResponseSubs_clusterRegister[6] = {0xFE,0x01,0x64,0x00,0xB8,0xDD}; //ÏìÓ¦Ö¡Ìæ²¹£¬ÈôÊý¾Ý´ØÒÑ¾
             -­×¢²á
 739   1              
 740   1      #define clusterNum_default 3
 741   1              datsAttr_clusterREG code cluster_Default[clusterNum_default] = {
 742   1              
 743   1                      {ZIGB_ENDPOINT_CTRLSECENARIO, zigbDatsDefault_ClustID}, 
 744   1                      {ZIGB_ENDPOINT_CTRLNORMAL, zigbDatsDefault_ClustID}, 
 745   1                      {ZIGB_ENDPOINT_CTRLSYSZIGB, zigbDatsDefault_ClustID}
 746   1              };
 747   1              
 748   1      #define dataLen_zigbNwkREQ 64
 749   1              u8 xdata paramTX_temp[dataLen_zigbNwkREQ] = {0};
 750   1              
 751   1              static u8 xdata step_CortexA = 0, //×´Ì¬»ú-Ö÷²½Öè
 752   1                                xdata step_CortexB = 0; //×´Ì¬»ú-×Ó²½Öè
 753   1              static u8 xdata reactionLoop = 0; //ÖØ¸´´ÎÊý»º´æ
 754   1                         u8 xdata actionReaptDefine_normal = 2; //ÖØ¸´´ÎÊý¶¨Òå_³£¹æÖ¸ÁîÏÂ
 755   1              
 756   1              u8 datsTX_Len = 0;
 757   1              
 758   1              if(devStatus_switch.statusChange_IF){ //×´Ì¬Ç¿ÖÆÇÐ»»Ê±£¬½«µ±Ç°×Ó×´Ì¬ÄÚ¾²Ì¬±äÁ¿³õÊ¼»¯ºóÔÙ½øÐÐÍâ²¿ÇÐ»»
 759   2              
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 14  

 760   2                      devStatus_switch.statusChange_IF = 0;
 761   2                      devRunning_Status = devStatus_switch.statusChange_standBy;
 762   2                      
 763   2                      step_CortexA = 0;
 764   2                      step_CortexB = 0;
 765   2                      reactionLoop = 0;
 766   2                      zigbPin_RESET = 1;
 767   2                      
 768   2                      return;
 769   2              }
 770   1              
 771   1              if(step_CortexA > (cmdNum_zigbNwkREQ + clusterNum_usr + clusterNum_default)){ //ÄÚ²¿×´Ì¬Íê³É
 772   2              
 773   2                      step_CortexA = 0;
 774   2                      step_CortexB = 0;
 775   2                      reactionLoop = 0;
 776   2                      zigbPin_RESET = 1;
 777   2                      
 778   2                      sysTimeReales_counter = PERIOD_SYSTIMEREALES; //systime¸üÐÂÖÜÆÚÖØÖÃ£¬·ÀÖ¹¶àÖ¸Áî¶ÂÈû³åÍ»
 779   2                      
 780   2                      devRunning_Status = status_passiveDataRcv; //Íâ²¿×´Ì¬ÇÐ»»
 781   2                      devTips_status = status_Normal; //Éè±¸ÏµÍ³tips×´Ì¬ÇÐ»»
 782   2                      
 783   2      #if(DEBUG_LOGOUT_EN == 1)
 784   2                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
 785   3                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
 786   3                              sprintf(log_buf, "nwkZigb connect/rejoin all complete.\n");
 787   3                              PrintString1_logOut(log_buf);
 788   3                      }                       
 789   2      #endif
 790   2                      
 791   2                      return;
 792   2              }
 793   1              
 794   1              if(!reJoin_IF)if(step_CortexA == 0)step_CortexA = 7; //ÊÇ·ñÎªÖØÐÂÖ÷¶¯¼ÓÈëÐÂÍøÂç£¬·ñÔò²»½øÐÐÓ²¼þ¸´Î»(Ó²¼þ¸
             -´Î»½«µ¼ÖÂ±¾µØÊ±¼ä±»ÖØÖÃ)
 795   1              if((step_CortexA == 7) || (step_CortexA == 0))sysTimeReales_counter     = PERIOD_SYSTIMEREALES; //·Ç×èÈû¹Ø¼üÖ
             -¸Áî²»ÄÜ±»×èÈûÖ¸Áî´ò¶Ï£¨Ó²¼þ¸´Î» ºÍ ÈëÍøÊ± ÖÐ¶Ï×èÈûÖ¸ÁîÏÂ´ï£©
 796   1              
 797   1      #if(DEBUG_LOGOUT_EN == 1)
 798   1              {//Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
 799   2              #define STATUSMACHINE_NWKREQ_DISPINITVAL 255
 800   2                      static u8 xdata stepDisp_CortexA = STATUSMACHINE_NWKREQ_DISPINITVAL;
 801   2                      
 802   2                      if(stepDisp_CortexA != step_CortexA){
 803   3                      
 804   3                              stepDisp_CortexA = step_CortexA;
 805   3                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
 806   3                              sprintf(log_buf, "nwkZigb connect/rejoin mainStep-%02d@method:%d complete.\n", (int)stepDisp_CortexA, (
             -int)reJoin_IF);
 807   3                              PrintString1_logOut(log_buf);
 808   3                      }
 809   2              }
 810   1      #endif
 811   1              
 812   1              if(step_CortexA == 0){ //ÌØÊâÖ¸Áî_Ó²¼þ¸´Î»:<0>
 813   2              
 814   2                      switch(step_CortexA){
 815   3                      
 816   3                              case 0:{ //Ê×ÌõÖ¸Áî£¬Ó²¼þ¸´Î»
 817   4                              
 818   4                                      switch(step_CortexB){
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 15  

 819   5                                      
 820   5                                              case 0:{ //²½ÖèÒ»£ºÓ²¼þÀ­µÍ100ms
 821   6                                              
 822   6                                                      zigbPin_RESET = 0;
 823   6                                                      zigbNwkAction_counter = 200;
 824   6                                                      step_CortexB = 1;
 825   6                                              
 826   6                                              }break;
 827   5                                      
 828   5                                              case 1:{ //²½Öè¶þ£ºÓ²¼þÀ­µÍÍê±ÏºóÈ·ÈÏÓ¦´ðÖ¡Ê±³¤
 829   6                                              
 830   6                                                      if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ý
 831   7                                                      
 832   7                                                              zigbPin_RESET = 1;
 833   7                                                              zigbNwkAction_counter = 6000;
 834   7                                                              step_CortexB = 2;
 835   7                                                      }
 836   6                                                      
 837   6                                              }break;
 838   5                                              
 839   5                                              case 2:{ //²½Öè¶þ£ºÈ·ÈÏÓ¦´ðÖ¡
 840   6                                                      
 841   6                                                      if(!zigbNwkAction_counter)step_CortexB = 0; //·Ç×èÈûµÈ´ýÏìÓ¦
 842   6                                              
 843   6                                                      if(uartRX_toutFLG){
 844   7                                                      
 845   7                                                              uartRX_toutFLG = 0;
 846   7                                                              
 847   7                                                              if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, ZigbInit_dats[0].zigbInit_REPLY, ZigbInit_dats[0].RE
             -PLY_num)){
 848   8                              
 849   8                                                                      step_CortexB = 0;
 850   8                                                                      reactionLoop = 0;
 851   8                                                                      step_CortexA ++;
 852   8                                                              }
 853   7                                                      }
 854   6                                                      
 855   6                                              }break;
 856   5                                      }
 857   4                                      
 858   4                              }break;
 859   3                      }
 860   2              }else
 861   1              if(step_CortexA > 0 && step_CortexA < cmdNum_zigbNwkREQ){ //³£¹æÖ¸Áî:<1 - 9>
 862   2                      
 863   2      //              if(!reJoin_IF)if(step_CortexA == 2)step_CortexA = 7;    //ÊÇ·ñÎªÖØÐÂÖ÷¶¯¼ÓÈëÐÂÍøÂç£¬·ñÔòÖ»½øÐÐ±»¶¯ÍøÂç¼¤»
             -î
 864   2      
 865   2                      switch(step_CortexB){
 866   3                      
 867   3                              case 0:{
 868   4                                      
 869   4                                      (step_CortexA == 7)?(actionReaptDefine_normal = 12):(actionReaptDefine_normal =  2); //ÓÉÓÚÈëÍø¹ý³Ì½Ï¸
             -´ÔÓ£¬ÈëÍøÖ¸ÁîµÈ´ýÊ±¼ä·Å³¤
 870   4                                      
 871   4                                      if(reactionLoop > actionReaptDefine_normal){
 872   5                                              
 873   5                                              reactionLoop = 0;
 874   5                                              step_CortexA = 0;
 875   5                                              break;
 876   5                                      }
 877   4                                      
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 16  

 878   4                                      datsTX_Len = ZigB_TXFrameLoad(paramTX_temp, 
 879   4                                                                                                ZigbInit_dats[step_CortexA].zigbInit_reqCMD, 
 880   4                                                                                                2, 
 881   4                                                                                                ZigbInit_dats[step_CortexA].zigbInit_reqDAT, 
 882   4                                                                                                ZigbInit_dats[step_CortexA].reqDAT_num);
 883   4                                      
 884   4                                      uartZigB_datsSend(paramTX_temp, datsTX_Len);
 885   4                                      
 886   4                                      zigbNwkAction_counter = ZigbInit_dats[step_CortexA].timeTab_waitAnsr;
 887   4                                      step_CortexB = 1;
 888   4                                      
 889   4                              }break;
 890   3                                      
 891   3                              case 1:{
 892   4                                      
 893   4                                      if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ýÏìÓ¦
 894   5                                      
 895   5                                              reactionLoop ++;
 896   5                                              step_CortexB = 0;
 897   5                                      }
 898   4                                      else
 899   4                                      if(uartRX_toutFLG){
 900   5                                      
 901   5                                              uartRX_toutFLG = 0;
 902   5                                              
 903   5                                              if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, ZigbInit_dats[step_CortexA].zigbInit_REPLY, ZigbInit_d
             -ats[step_CortexA].REPLY_num)){
 904   6                                              
 905   6                                                      step_CortexB = 0;
 906   6                                                      reactionLoop = 0;
 907   6                                                      step_CortexA ++;
 908   6                                              }
 909   5                                      }
 910   4                                      
 911   4                              }break;
 912   3                      }
 913   2                      
 914   2              }else
 915   1              if(step_CortexA >= cmdNum_zigbNwkREQ){ //ÌØÊâÖ¸Áî_³£¹æÍ¨ÐÅ´Ø×¢²á:<10 - n>
 916   2                      
 917   2                      u8 datsREG_cluster[16] = {0};
 918   2                      memcpy(datsREG_cluster, defaultParam_clusterRegister.zigbInit_reqDAT, defaultParam_clusterRegister.reqDA
             -T_num);
 919   2                      if(step_CortexA < (cmdNum_zigbNwkREQ + clusterNum_default)){ //Ä¬ÈÏ×¨ÓÃÍ¨ÐÅ´Ø²ÎÊýÌî×°
 920   3                      
 921   3                              datsREG_cluster[0] = cluster_Default[step_CortexA - cmdNum_zigbNwkREQ].endpoint;
 922   3                              datsREG_cluster[3] = (u8)((cluster_Default[step_CortexA - cmdNum_zigbNwkREQ].devID & 0x00ff) >> 0);
 923   3                              datsREG_cluster[4] = (u8)((cluster_Default[step_CortexA - cmdNum_zigbNwkREQ].devID & 0xff00) >> 8);
 924   3                              
 925   3                      }else{  //ÓÃ»§Í¨ÐÅ´Ø£¨»¥¿Ø£©×¢²á²ÎÊýÌî×°
 926   3                      
 927   3                              if((CTRLEATHER_PORT[step_CortexA - cmdNum_zigbNwkREQ - clusterNum_usr] >= 0x10) && (CTRLEATHER_PORT[ste
             -p_CortexA - cmdNum_zigbNwkREQ - clusterNum_usr] < 255)){ //Í¨ÐÅ´Ø¶Ë¿ÚºÏ·¨ÐÔÅÐ¶Ï
 928   4                              
 929   4                                      datsREG_cluster[0] = CTRLEATHER_PORT[step_CortexA - cmdNum_zigbNwkREQ - clusterNum_usr];
 930   4                                      datsREG_cluster[3] = zigbDatsDefault_ClustID; //Ä¬ÈÏ´ØID <LSB>
 931   4                                      datsREG_cluster[4] = 0; //Ä¬ÈÏ´ØID <MSB>
 932   4                                      
 933   4                              }else{
 934   4                              
 935   4                                      step_CortexA ++;
 936   4                                      return;
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 17  

 937   4                              }
 938   3                      }
 939   2              
 940   2                      switch(step_CortexB){
 941   3                      
 942   3                              case 0:{
 943   4                                      
 944   4                                      if(reactionLoop > 2){
 945   5                                              
 946   5                                              reactionLoop = 0;
 947   5                                              step_CortexA = 0;
 948   5                                              break;
 949   5                                      }
 950   4                                      
 951   4                                      datsTX_Len = ZigB_TXFrameLoad(paramTX_temp, 
 952   4                                                                                                defaultParam_clusterRegister.zigbInit_reqCMD, 
 953   4                                                                                                2, 
 954   4                                                                                                datsREG_cluster, 
 955   4                                                                                                defaultParam_clusterRegister.reqDAT_num);
 956   4                                      
 957   4                                      uartZigB_datsSend(paramTX_temp, datsTX_Len);
 958   4                                      
 959   4                                      zigbNwkAction_counter = defaultParam_clusterRegister.timeTab_waitAnsr;
 960   4                                      step_CortexB = 1;
 961   4                                      
 962   4                              }break;
 963   3                                      
 964   3                              case 1:{
 965   4                                      
 966   4                                      if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ýÏìÓ¦
 967   5                                      
 968   5                                              reactionLoop ++;
 969   5                                              step_CortexB = 0;
 970   5                                      }
 971   4                                      else
 972   4                                      if(uartRX_toutFLG){
 973   5                                      
 974   5                                              uartRX_toutFLG = 0;
 975   5                                              
 976   5                                              if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, defaultParam_clusterRegister.zigbInit_REPLY, defaultPa
             -ram_clusterRegister.REPLY_num) || //Ô¤ÆÚÏìÓ¦
 977   5                                                 memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, frameResponseSubs_clusterRegister, 6)){ //Ìæ²¹ÏìÓ¦
 978   6                                              
 979   6                                                      step_CortexB = 0;
 980   6                                                      reactionLoop = 0;
 981   6                                                      step_CortexA ++;
 982   6                                              }
 983   5                                      }
 984   4                                      
 985   4                              }break;
 986   3                      }
 987   2              }
 988   1      }
 989          
 990          /*zigbeeÍøÂçÊý¾Ý·¢ËÍ¸ñÊ½»¯Ìî×°*/
 991          static 
 992          u8 zigb_datsLoad_datsSend(u8  frame_Temp[NORMALDATS_DEFAULT_LENGTH],
 993                                                            u16 DstAddr,
 994                                                            u8  portPoint,
 995                                                            u8  dats[],
 996                                                            u8  datsLen){
 997   1              
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 18  

 998   1              u8 code zigbCMD_DatsSend[2] = {0x24, 0x01};
 999   1              
1000   1      #define zigbDatsSend_datsTransLen       72
1001   1              u8 xdata buf_datsLOAD[zigbDatsSend_datsTransLen] = {0};
1002   1              u8 datsTX_Len = 0;
1003   1                                                                
1004   1              memset(frame_Temp, 0, NORMALDATS_DEFAULT_LENGTH * sizeof(u8));  
1005   1      
1006   1              //·¢ËÍÖ¡Ìî×°
1007   1              buf_datsLOAD[0] = (u8)((DstAddr & 0x00ff) >> 0);
1008   1              buf_datsLOAD[1] = (u8)((DstAddr & 0xff00) >> 8);
1009   1              buf_datsLOAD[2] = portPoint;
1010   1              buf_datsLOAD[3] = portPoint;
1011   1              buf_datsLOAD[4] = zigbDatsDefault_ClustID;
1012   1              buf_datsLOAD[6] = zigbDatsDefault_TransID;
1013   1              buf_datsLOAD[7] = zigbDatsDefault_Option;
1014   1              buf_datsLOAD[8] = zigbDatsDefault_Radius;
1015   1              buf_datsLOAD[9] = datsLen;
1016   1              memcpy(&buf_datsLOAD[10], dats, datsLen);       
1017   1              
1018   1              return ZigB_TXFrameLoad(frame_Temp, (u8 *)zigbCMD_DatsSend, 2, buf_datsLOAD, datsLen + 10);
1019   1      }
1020          
1021          /*zigbeeÎÞÊÓÏìÓ¦»Ø¸´Ö±½Ó·¢ËÍÊý¾Ý*///×èÈû
1022          static
1023          void dataSendRemote_straightforward( u16 DstAddr, //Ô¶¶ËÍøÂç¶ÌµØÖ·
1024                                                                                    u8 port,       //¶Ëµã¿Ú
1025                                                                                    u8 dats[], //Êý¾Ý
1026                                                                                    u8 datsLen ){ //Êý¾Ý³¤¶È
1027   1                                                                                                                                                
1028   1              u8 xdata buf_datsTX[NORMALDATS_DEFAULT_LENGTH] = {0};
1029   1              u8 datsTX_Len = 0;
1030   1              
1031   1              datsTX_Len = zigb_datsLoad_datsSend(buf_datsTX, DstAddr, port, dats, datsLen);
1032   1              
1033   1              uartZigB_datsSend(buf_datsTX, datsTX_Len);
1034   1      }
1035          
1036          /*zigbeeÍøÂçÊý¾Ý·¢ËÍÇëÇó×´Ì¬»ú*///·Ç×èÈû
1037          static
1038          void dataTransRequest_datsSend(void){
1039   1      
1040   1              u8 xdata buf_datsTX[NORMALDATS_DEFAULT_LENGTH] = {0};
1041   1              u8 datsTX_Len = 0;
1042   1              
1043   1      #define zigbDatsSend_datsRespLen        64
1044   1              u8 xdata buf_datsRX[zigbDatsSend_datsRespLen] = {0};
1045   1              u8 datsRX_Len = 0;
1046   1              
1047   1      #define zigbDatsSend_ASR_datsLen        3
1048   1              u8              ASR_dats[zigbDatsSend_ASR_datsLen] = {0};
1049   1              u8 code ASR_cmd[2] = {0x44,0x80};       //±¾µØZNPÐ­Òé²ãÈ·ÈÏ·¢ËÍÏìÓ¦
1050   1              
1051   1      #define resCODE_datsSend_NOROUTER 0xCD  //Êý¾Ý·¢ËÍÐ­Òé²ãÏìÓ¦´úÂë-Â·ÓÉÊ§Áª£¬Í¨Ñ¶Ã½½é¶ªÊ§
1052   1      #define resCODE_datsSend_NOREMOTE 0xE9  //Êý¾Ý·¢ËÍÐ­Òé²ãÏìÓ¦´úÂë-¶Ô·½²»ÔÚÏß£¬Ä¿±êµØÖ·½ÚµãÉè±¸²»´æÔÚ
1053   1      #define resCODE_datsSend_TIMEOUT  0x01  //Êý¾Ý·¢ËÍÐ­Òé²ãÏìÓ¦´úÂë-·¢ËÍ³¬Ê±
1054   1      #define resCODE_datsSend_SUCCESS  0x00  //Êý¾Ý·¢ËÍÐ­Òé²ãÏìÓ¦´úÂë-·¢ËÍ³É¹¦
1055   1              static u8 datsTrans_respondCode = 0; //·¢ËÍÍê³ÉÏìÓ¦Âë
1056   1              
1057   1              static u8 step = 0;
1058   1              static u8 reactionLoop = 0;
1059   1              
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 19  

1060   1              if(devStatus_switch.statusChange_IF){   //×´Ì¬Ç¿ÖÆÇÐ»»Ê±£¬½«µ±Ç°×Ó×´Ì¬ÄÚ¾²Ì¬±äÁ¿³õÊ¼»¯ºóÔÙ½øÐÐÍâ²¿ÇÐ»»
1061   2              
1062   2                      devStatus_switch.statusChange_IF = 0;
1063   2                      devRunning_Status = devStatus_switch.statusChange_standBy;
1064   2                      
1065   2                      step = 0;
1066   2                      reactionLoop = 0;
1067   2                      
1068   2                      return;
1069   2              }
1070   1              
1071   1              //½ÓÊÕÖ¡Ìî×°_±¾µØ
1072   1              ASR_dats[0] = resCODE_datsSend_SUCCESS; //·¢ËÍ³É¹¦ÏìÓ¦´úÂë
1073   1              ASR_dats[1] = datsSend_request.portPoint;
1074   1              ASR_dats[2] = zigbDatsDefault_TransID;
1075   1              datsRX_Len = ZigB_TXFrameLoad(buf_datsRX, (u8 *)ASR_cmd, 2, ASR_dats, zigbDatsSend_ASR_datsLen);
1076   1              
1077   1              datsTX_Len = zigb_datsLoad_datsSend(buf_datsTX, datsSend_request.nwkAddr, datsSend_request.portPoint, dat
             -sSend_request.datsTrans.dats, datsSend_request.datsTrans.datsLen);
1078   1              
1079   1              switch(step){
1080   2              
1081   2                      case 0:{ //ÏìÓ¦½ÓÊÕ¾ÍÐ÷£¬ÉèÖÃÏìÓ¦Ê±¼ä
1082   3                              
1083   3                              if(reactionLoop > 3){ //ÖØ·¢´ÎÊýÒÑ³¬³ö
1084   4                                      
1085   4                                      datsTrans_respondCode = resCODE_datsSend_TIMEOUT; //ÏìÓ¦Âë¸ÄÎª³¬Ê±
1086   4                                      
1087   4                                      reactionLoop = 0;
1088   4                                      step = 4;
1089   4                                      
1090   4                                      break;
1091   4                              }
1092   3                      
1093   3                              zigbPin_RESET = 1; //±£ÏÕÆð¼û£¬¸´Î»À­¸ß
1094   3                              if(!devRemoteDataReqMethod.keepTxUntilCmp_IF)uartZigB_datsSend(buf_datsTX, datsTX_Len); //·ÇËÀ¿Ä£¬·¢Ò»´
             -Î¾ÍÐÐ
1095   3                              zigbNwkAction_counter = REMOTE_DATAREQ_TIMEOUT; //Ä¬ÈÏÐ­Òé²ãÏìÓ¦Ê±¼ä<Ê±¼äÌ«¶ÌÎÞ·¨ÊÕµ½ºóÃæµÄ½ÓÊÕ×´Ì¬ÏìÓ¦
             -Ö¸Áî£¬Ö»ÄÜÊÕµ½ÏµÍ³ÏìÓ¦>
1096   3                              step = 1;
1097   3                              
1098   3                      }break;
1099   2                      
1100   2                      case 1:{ //·Ç×èÈûµÈ´ýÏµÍ³ÏìÓ¦
1101   3                              
1102   3                              static u8 xdata local_funRecord = 0; //±¾µØ ³ý´Î±È ÅÐ¶Ï
1103   3                                         u8 xdata funRecord_temp = zigbNwkAction_counter / devRemoteDataReqMethod.datsTxKeep_Period; //³ý´Î±
             -È£¬ÓÃÓÚÖÜÆÚÅÐ¶Ï
1104   3                      
1105   3                              if(!zigbNwkAction_counter){ //³¬Ê±ÅÐ¶Ï
1106   4                              
1107   4                                      reactionLoop ++;
1108   4                                      step = 0;
1109   4                                      local_funRecord = 0;
1110   4                              }
1111   3                              else{
1112   4                                      
1113   4                                      if(devRemoteDataReqMethod.keepTxUntilCmp_IF){ //ËÀ¿Ä·½Ê½ÏÂ£¬³¬Ê±Ê±¼äÄÚ£¬ÖÜÆÚÑ­»·ÏÂ·¢Ö¸Áî
1114   5                                              
1115   5                                              if(local_funRecord != funRecord_temp){ //°´³ÖÐøÆµÂÊ³ÖÐø·¢ËÍ
1116   6                                              
1117   6                                                      local_funRecord = funRecord_temp; //±¾µØ³ý´Î±È¸üÐÂ
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 20  

1118   6                                                      
1119   6                                                      uartZigB_datsSend(buf_datsTX, datsTX_Len);
1120   6                                              }
1121   5                                      }
1122   4                                      
1123   4                                      if(uartRX_toutFLG){
1124   5                                      
1125   5                                              uartRX_toutFLG = 0;
1126   5      
1127   5                                              if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, buf_datsRX, datsRX_Len)){ //Ó¦´ðÖ¸ÁîºÍÓ¦´ðÂë¶¼ÕýÈ·
1128   6                                              
1129   6                                                      if(datsRcv_respond.datsTrans.datsLen == 0){ //ÅÐ¶ÏÌõ¼þÊÇ·ñÐèÒªÔ¶¶ËÏìÓ¦
1130   7                                                      
1131   7                                                              step = 3;
1132   7                                                              
1133   7                                                      }else{
1134   7                                                      
1135   7                                                              step = 2;
1136   7                                                              zigbNwkAction_counter = REMOTE_RESPOND_TIMEOUT; //Ä¬ÈÏÔ¶¶ËÏìÓ¦Ê±¼ä<¶Ô·½½ÚµãÏìÓ¦>
1137   7                                                      }
1138   6                                                      
1139   6                                                      local_funRecord = 0; //±¾µØ³ý´Î±È¸´Î»
1140   6                                                      
1141   6                                              }else{  
1142   6                                                      
1143   6                                                      if(!memcmp(&datsRcv_ZIGB.rcvDats[2], ASR_cmd, 2)){ //Ó¦´ðÖ¸ÁîÕýÈ·£¬µ«Ó¦´ðÂë´íÎó£¬ÔòÈ¡³ö´íÎóÂë
1144   7                                                      
1145   7                                                              datsTrans_respondCode = datsRcv_ZIGB.rcvDats[4]; //´íÎóÏìÓ¦Âë×°ÔØ
1146   7                                                              
1147   7                                                              if(devRemoteDataReqMethod.keepTxUntilCmp_IF){ //·¢ËÍ·½Ê½ÅÐ¶Ï-ÊÇ·ñÎªËÀ¿Ä·½Ê½
1148   8                                                              
1149   8                                                                      
1150   8                                                                      
1151   8                                                              }else{
1152   8                                                              
1153   8                                                                      step = 4; //·ÇËÀ¿Ä·½Ê½£¬ÔòÓÐÓ¦´ðÖ¸Áî£¬µ«Ó¦´ðÊý¾Ý´íÎó£¬ÌøÖÁÊ§°Ü²½Öè
1154   8                                                              }
1155   7                                                      }
1156   6                                                      
1157   6      //#if(DEBUG_LOGOUT_EN == 1)
1158   6      //                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1159   6      //                                                      u8 xdata log_buf[64]; //Êý¾Ý´«ÊäÊ§°ÜÐ­Òé²ãÏìÓ¦´úÂë´òÓ¡
1160   6      //                                                      
1161   6      //                                                      sprintf(log_buf, "dats_TX fail code: %02X %02X %02X.\n", (int)datsRcv_ZIGB.rcvDats[2], (int)datsR
             -cv_ZIGB.rcvDats[3], (int)datsRcv_ZIGB.rcvDats[4]);
1162   6      //                                                      PrintString1_logOut(log_buf);
1163   6      //                                              }       
1164   6      //#endif                                
1165   6                                              }
1166   5                                      }
1167   4                              }
1168   3                              
1169   3                      }break;
1170   2                      
1171   2                      case 2:{ //·Ç×èÈûµÈ´ýÔ¶¶ËÏìÓ¦
1172   3      
1173   3                              if(!zigbNwkAction_counter){
1174   4                              
1175   4                                      reactionLoop ++;
1176   4                                      step = 0;
1177   4                              }
1178   3                              else{
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 21  

1179   4                                      
1180   4                                      if(uartRX_toutFLG){
1181   5                                              
1182   5                                              u16 idata datsFrom_addr = ((u16)(datsRcv_ZIGB.rcvDats[9]) << 8) | ((u16)(datsRcv_ZIGB.rcvDats[8]) << 
             -0); //Êý¾Ý·¢ËÍ·½ÍøÂçµØÖ·
1183   5                                              u8      idata dstPoint =  datsRcv_ZIGB.rcvDats[11];     //Ô¶¶Ë  
1184   5                                              
1185   5                                              uartRX_toutFLG = 0;
1186   5                                              
1187   5                                              if(datsRcv_ZIGB.rcvDats[0] != ZIGB_FRAME_HEAD){ //Ö¡Í·²»¶Ô£¬´òÓ¡Êä³ö
1188   6                                              
1189   6      #if(DEBUG_LOGOUT_EN == 1)
1190   6                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1191   7                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1192   7                                                              sprintf(log_buf, "err frameHead:%02X.\n", (int)datsRcv_ZIGB.rcvDats[0]);
1193   7                                                              PrintString1_logOut(log_buf);
1194   7                                                      }                       
1195   6      #endif  
1196   6                                              }
1197   5      
1198   5                                              if(!memcmp(&(datsRcv_ZIGB.rcvDats[21]), datsRcv_respond.datsTrans.dats, datsRcv_respond.datsTrans.dat
             -sLen) && 
1199   5                                                 (datsRcv_respond.nwkAddr == datsFrom_addr) &&
1200   5                                                      (datsRcv_respond.portPoint == dstPoint)){
1201   6                                              
1202   6                                                      step = 3;
1203   6                                                              
1204   6                                              }else{
1205   6                                              
1206   6      #if(DEBUG_LOGOUT_EN == 1)
1207   6                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1208   7                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1209   7      //                                                      sprintf(log_buf, "data remoteRcv is %02X %02X %02X.\n", (int)datsRcv_ZIGB.rcvDats[21], (int)datsR
             -cv_ZIGB.rcvDats[22], (int)datsRcv_ZIGB.rcvDats[23]);
1210   7                                                              sprintf(log_buf, "rcvPort is %02X, rcvNwkAddr is %04X.\n", (int)dstPoint, (int)datsFrom_addr);
1211   7      //                                                      sprintf(log_buf, "rcvPort is %02X, rcvNwkAddr is %04X.\n", (int)datsRcv_respond.portPoint, (int)d
             -atsRcv_respond.nwkAddr);
1212   7                                                              PrintString1_logOut(log_buf);
1213   7                                                      }       
1214   6      #endif  
1215   6                                              }
1216   5                                      }
1217   4                              }
1218   3                              
1219   3                      }break;
1220   2                      
1221   2                      case 3:{ //ÏìÓ¦³É¹¦
1222   3                      
1223   3                              if(reConnectAfterDatsReq_IF){ //Õë¶Ô¼´¿Ì×¢²á»¥¿ØÌØÊâÇé¿ö ×´Ì¬ÇÐ»»
1224   4                              
1225   4                                      reConnectAfterDatsReq_IF = 0;
1226   4                                      devRunning_Status = status_nwkReconnect;
1227   4                                      
1228   4                              }else{ 
1229   4                              
1230   4                                      devRunning_Status = status_passiveDataRcv;
1231   4                              }
1232   3                              
1233   3                              reactionLoop = 0;
1234   3                              step = 0;
1235   3                              
1236   3                              /*ËÀ¿ÄÊôÐÔ¸´Î»*///ÊôÐÔÉèÖÃ½öÉúÐ§Ò»´Î
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 22  

1237   3                              devRemoteDataReqMethod.keepTxUntilCmp_IF = 0; //ËÀ¿ÄÊ¹ÄÜ¸´Î»
1238   3                              devRemoteDataReqMethod.datsTxKeep_Period = 0; //ËÀ¿ÄÖÜÆÚ¸´Î»
1239   3                              
1240   3                      }break;
1241   2                      
1242   2                      case 4:{ //ÏìÓ¦Ê§°Ü
1243   3                      
1244   3                              if(reConnectAfterDatsReq_IF){ //Õë¶Ô¼´¿Ì×¢²á»¥¿ØÌØÊâÇé¿ö ×´Ì¬ÇÐ»»
1245   4                              
1246   4                                      reConnectAfterDatsReq_IF = 0;
1247   4                                      devRunning_Status = status_nwkReconnect;
1248   4                                      
1249   4                              }else{ 
1250   4                              
1251   4                                      devRunning_Status = status_passiveDataRcv;
1252   4                              }
1253   3                              
1254   3                              //Õë¶ÔÊý¾Ý´«ÊäÊ§°ÜÏìÓ¦´úÂëÇé¿ö½øÐÐÑ¡ÔñÐÔÖØÁ¬£¬·ñÔò½öÊ±ÇøÐ­µ÷Æ÷Éè±¸¾Ígg
1255   3                              if(datsTrans_respondCode){ 
1256   4                                      
1257   4      #if(DEBUG_LOGOUT_EN == 1)                               
1258   4                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1259   5                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1260   5                                              sprintf(log_buf, "remote dataRequest fail, code:[0x%02X].\n", (int)datsTrans_respondCode);
1261   5                                              PrintString1_logOut(log_buf);
1262   5                                      }
1263   4      #endif  
1264   4                                      
1265   4                                      switch(datsTrans_respondCode){ //ÏìÓ¦Ê§°ÜÂë·ÖÎö
1266   5                                      
1267   5                                              case resCODE_datsSend_NOROUTER:
1268   5                                              case resCODE_datsSend_NOREMOTE:
1269   5                                              case resCODE_datsSend_SUCCESS:{
1270   6                                              
1271   6                                                      devTips_nwkZigb = nwkZigb_outLine; //ÔÝÊ±Ö»×öÊ§°ÜÌáÊ¾£¬²»×öÆäËû¶¯×÷
1272   6                                                      
1273   6                                              }break;
1274   5                                              
1275   5                                              default:{
1276   6                                              
1277   6                                                      devTips_nwkZigb = nwkZigb_outLine; //ÔÝÊ±Ö»×öÊ§°ÜÌáÊ¾£¬²»×öÆäËû¶¯×÷
1278   6                                                      
1279   6                                              }break;
1280   5                                      }
1281   4                                      
1282   4                                      datsTrans_respondCode = 0;
1283   4                              }
1284   3                              
1285   3                              reactionLoop = 0;
1286   3                              step = 0;
1287   3                              
1288   3                              /*ËÀ¿ÄÊôÐÔ¸´Î»*///ÊôÐÔÉèÖÃ½öÉúÐ§Ò»´Î
1289   3                              devRemoteDataReqMethod.keepTxUntilCmp_IF = 0; //ËÀ¿ÄÊ¹ÄÜ¸´Î»
1290   3                              devRemoteDataReqMethod.datsTxKeep_Period = 0; //ËÀ¿ÄÖÜÆÚ¸´Î»
1291   3                              
1292   3                      }break;
1293   2                              
1294   2                      default:{
1295   3                      
1296   3                              step = 4;
1297   3                              
1298   3                      }break;
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 23  

1299   2              }
1300   1      }
1301          
1302          /*Éè±¸Êý¾Ý´«ÊäÖ÷×´Ì¬ÇÐ»»ÖÁÍøÂç¹ÒÆð*/
1303          void devStatusChangeTo_devHold(bit zigbNwkSysNote_IF){ //Éè±¸ÍøÂç¹ÒÆð
1304   1      
1305   1              devNwkHoldTime_Param.devHoldTime_counter = DEVHOLD_TIME_DEFAULT;
1306   1              if(zigbNwkSysNote_IF)devNwkHoldTime_Param.zigbNwkSystemNote_IF = 1;
1307   1              
1308   1              devStatus_switch.statusChange_standBy = status_devNwkHold; //Êý¾Ý´«Êä×´Ì¬»ú¸ü±ä
1309   1              devStatus_switch.statusChange_IF = 1;
1310   1              
1311   1              devTips_status = status_devHold; //tips¸ü±ä
1312   1              
1313   1      #if(DEBUG_LOGOUT_EN == 1)                               
1314   1              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1315   2                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1316   2                      sprintf(log_buf, "devHold start right now.\n");
1317   2                      PrintString1_logOut(log_buf);
1318   2              }
1319   1      #endif  
1320   1      }
1321          
1322          /*Éè±¸ÍøÂç¹ÒÆðÍ£Ö¹£¬Ê¹ÌáÇ°½áÊø*/
1323          void devHoldStop_makeInAdvance(void){ //Í£Ö¹Éè±¸ÍøÂç¹ÒÆð£¨ÌáÇ°£©
1324   1      
1325   1              if(devNwkHoldTime_Param.devHoldTime_counter)devNwkHoldTime_Param.devHoldTime_counter = 0;
1326   1      }
1327          
1328          /*zigbeeÉè±¸ÍøÂç¹ÒÆð×´Ì¬»ú*///·Ç×èÈû
1329          static 
1330          void function_devNwkHold(void){
1331   1              
1332   1              static status_Step = 0; //µ±Ç°×´Ì¬»ú²½Öè×´Ì¬Ö¸Ê¾
1333   1              
1334   1              if(devNwkHoldTime_Param.devHoldTime_counter){ //Ö±µ½¹ÒÆðÊ±¼ä½áÊø
1335   2              
1336   2                      if(devNwkHoldTime_Param.zigbNwkSystemNote_IF){ //Í¨Öªµ±Ç°ÍøÂçÄÚ×ÓÉè±¸¹ÒÆð,±¨Ò»´Î
1337   3                              
1338   3                              u8 xdata dats_Note[3] = {ZIGB_SYSCMD_DEVHOLD, 1, 0}; //ÃüÁî¡¢Êý¾Ý³¤¶È¡¢Êý¾Ý
1339   3                      
1340   3                              devNwkHoldTime_Param.zigbNwkSystemNote_IF = 0; //Í¨ÖªÊ¹ÄÜ¸´Î»
1341   3                              
1342   3                              dataSendRemote_straightforward( 0xFFFF, //¹ã²¥Í¨ÖªÍøÄÚËùÓÐ×ÓÉè±¸¹ÒÆð
1343   3                                                                                              ZIGB_ENDPOINT_CTRLSYSZIGB,
1344   3                                                                                              dats_Note,
1345   3                                                                                              3 );
1346   3                              
1347   3                              delayMs(50); //±ØÐèÑÓÊ±£¬·ñÔòÊý¾Ý»¹Ã»·¢ËÍ³öÈ¥£¬¾ÍÅÜµ½ÏÂÒ»²½¸´Î»ÁË
1348   3                      }
1349   2                      
1350   2                      { //Éè±¸¹ÒÆð,Ñ­»·¸´Î»
1351   3                              
1352   3                              switch(status_Step){
1353   4                              
1354   4                                      case 0:{ //¸´Î»200ms
1355   5                                      
1356   5                                              zigbPin_RESET = 0;
1357   5                                              zigbNwkAction_counter = 200;
1358   5                                              status_Step = 1;
1359   5                                      
1360   5                                      }break;
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 24  

1361   4                                              
1362   4                                      case 1:{ //Ã¿6s¸´Î»Ò»´Î
1363   5                                      
1364   5                                              if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ý
1365   6                                              
1366   6                                                      zigbPin_RESET = 1;
1367   6                                                      zigbNwkAction_counter = 6000;
1368   6                                                      status_Step = 2;
1369   6                                              }
1370   5                                      
1371   5                                      }break;
1372   4                                      
1373   4                                      case 2:{
1374   5                                      
1375   5                                              if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ý
1376   6                                              
1377   6                                                      status_Step = 0;
1378   6                                                      
1379   6      #if(DEBUG_LOGOUT_EN == 1)                               
1380   6                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1381   7                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1382   7                                                              sprintf(log_buf, "devHold time count remind: %02d s.\n", (int)devNwkHoldTime_Param.devHoldTime_coun
             -ter);
1383   7                                                              PrintString1_logOut(log_buf);
1384   7                                                      }
1385   6      #endif
1386   6                                              }
1387   5                                      
1388   5                                      }break;
1389   4                                      
1390   4                                      default:{
1391   5                                              
1392   5                                              status_Step = 0;
1393   5                                              
1394   5                                      }break;
1395   4                              }
1396   3                      }
1397   2      
1398   2              }else{
1399   2              
1400   2                      //¹ÒÆðÊ±¼ä½áÊø,Ö÷×´Ì¬»Ö¸´ÖÁÖØÁ¬£¬±¾µØ×´Ì¬»Ö¸´
1401   2                      status_Step = 0;
1402   2                      zigbPin_RESET = 1;
1403   2                      
1404   2                      devRunning_Status = status_nwkReconnect; //Ö±½Ó½«Ö÷×´Ì¬ÇÐ»»ÖÁÍøÂçÖØÁ¬,²»×ßstandbyÁ÷³Ì
1405   2                      devTips_status = status_Normal; //tips¸ü±ä
1406   2              
1407   2      #if(DEBUG_LOGOUT_EN == 1)                               
1408   2                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1409   3                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1410   3                              sprintf(log_buf, "devHold stop.\n");
1411   3                              PrintString1_logOut(log_buf);
1412   3                      }
1413   2      #endif  
1414   2              }
1415   1      }
1416          
1417          /*zigbee¼¯Èº¿ØÖÆÊý¾Ý½âÎö*/
1418          static 
1419          void dataParing_scenarioCtrl(u8 datsFrame[]){
1420   1      
1421   1              swCommand_fromUsr.objRelay = datsFrame[0]; //¼ÌµçÆ÷ÏìÓ¦¼´¿É
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 25  

1422   1              swCommand_fromUsr.actMethod = relay_OnOff;
1423   1              
1424   1              colonyCtrlGet_statusLocalScene = datsFrame[0]; //±¾µØ³¡¾°¿ØÖÆÂÖÑ¯Öµ¸üÐÂ(³¡¾°¿ØÖÆ½öÀ´×ÔÓÚÊÖ»ú¿ØÖÆ)
1425   1              
1426   1      #if(DEBUG_LOGOUT_EN == 1)
1427   1              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1428   2                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1429   2                      sprintf(log_buf, "cmdScenarioCtrl comming, statusData:%02X.\n", (int)datsFrame[0]);
1430   2                      PrintString1_logOut(log_buf);
1431   2              }                       
1432   1      #endif          
1433   1      }
1434          
1435          /*zigbeeÏµÍ³½»»¥Êý¾Ý½âÎö*/
1436          static 
1437          void dataParing_zigbSysCtrl(u8 datsFrame[]){
1438   1      
1439   1              /*>>>>>>>>>>>>>>frame reference<<<<<<<<<<<<<<<<<*/
1440   1              /*----------------------------------------------*/
1441   1              /*  frame_CMD   |       frame_dataLen|  frame_data      |
1442   1              /*----------------------------------------------*/
1443   1              /*      1byte           |       1byte            |      < 256byte       |       
1444   1              /*----------------------------------------------*/
1445   1              
1446   1              frame_zigbSysCtrl xdata dats = {0};
1447   1              
1448   1              dats.command = datsFrame[0];
1449   1              memcpy(dats.dats, &datsFrame[2], datsFrame[1]);
1450   1              dats.datsLen = datsFrame[1];
1451   1              
1452   1              switch(dats.command){
1453   2              
1454   2                      case ZIGB_SYSCMD_NWKOPEN:{ //ÍøÂç¿ª·Å
1455   3                              
1456   3                              bit resultSet = 0;
1457   3                              
1458   3                              resultSet = ZigB_nwkOpen(1, dats.dats[0]); //¹¦ÄÜ´¥·¢
1459   3                              tips_statusChangeToZigbNwkOpen(dats.dats[0]); //tips´¥·¢
1460   3                              
1461   3      #if(DEBUG_LOGOUT_EN == 1)
1462   3                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1463   4                                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1464   4                                      sprintf(log_buf, "master cmdComing:nwkOpen:%02ds.\n", (int)dats.dats[0]);
1465   4                                      PrintString1_logOut(log_buf);
1466   4                              }                       
1467   3      #endif          
1468   3                              
1469   3                      }break;
1470   2                      
1471   2                      case ZIGB_SYSCMD_TIMESET:{ //ÏµÍ³Ê±¼äÉè¶¨
1472   3                      
1473   3                              bit resultSet = 0;
1474   3                              bit timeZoneAdjust_needIF = 0;
1475   3                              u32 time_Temp = 0UL;
1476   3                              
1477   3                              time_Temp |= (u32)dats.dats[0] << 0;
1478   3                              time_Temp |= (u32)dats.dats[1] << 8;
1479   3                              time_Temp |= (u32)dats.dats[2] << 16;
1480   3                              time_Temp |= (u32)dats.dats[3] << 24;
1481   3                              if((sysTimeZone_H != dats.dats[4]) || (sysTimeZone_M != dats.dats[5])){ //Ê±ÇøÍ¬²½
1482   4                              
1483   4                                      sysTimeZone_H = dats.dats[4];
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 26  

1484   4                                      sysTimeZone_M = dats.dats[5];
1485   4                                      coverEEPROM_write_n(EEPROM_ADDR_timeZone_H, &sysTimeZone_H, 1);
1486   4                                      coverEEPROM_write_n(EEPROM_ADDR_timeZone_M, &sysTimeZone_M, 1);
1487   4                              }
1488   3                              
1489   3                              if(dats.dats[6])timeZoneAdjust_needIF = 1; //Ê±Çø²¹³¥Ê¹ÄÜÅÐ¶Ï
1490   3                              if(time_Temp > ZIGB_UTCTIME_START)resultSet = zigB_sysTimeSet(time_Temp - ZIGB_UTCTIME_START, timeZoneA
             -djust_needIF); //zigbee ±¾µØÏµÍ³Ê±¼äÉèÖÃ<UTC¸º²¹³¥>
1491   3                              
1492   3      #if(DEBUG_LOGOUT_EN == 1)
1493   3                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1494   4                                      u8 xdata log_buf[64];
1495   4                                      
1496   4                                      sprintf(log_buf, "master UTC coming:[0x%02X%02X%02X%02X].\n", (int)dats.dats[3], (int)dats.dats[2], (i
             -nt)dats.dats[1], (int)dats.dats[0]);
1497   4                                      PrintString1_logOut(log_buf);
1498   4                              }                       
1499   3      #endif  
1500   3                      }break;
1501   2                      
1502   2                      case ZIGB_SYSCMD_DEVHOLD:{ //ÍøÂç¹ÒÆð£¨ÓÃ×÷Íø¹ØÇÐ»»£©
1503   3                              
1504   3      #if(DEBUG_LOGOUT_EN == 1)
1505   3                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1506   4                                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1507   4                                      sprintf(log_buf, "node cmdComing:devNwk hold.\n");
1508   4                                      PrintString1_logOut(log_buf);
1509   4                              }                       
1510   3      #endif  
1511   3                              devStatusChangeTo_devHold(0); //Éè±¸ÍøÂç±»¶¯¹ÒÆð,²»½øÐÐÍøÂçÍ¨Öª
1512   3                              
1513   3                      }break;
1514   2      
1515   2      #if(COLONYINFO_QUERYPERIOD_EN == ENABLE) /*ºêÅÐÍ·*///¼¯Èº¿ØÖÆÐÅÏ¢ÖÜÆÚ²éÑ¯Ê¹ÄÜ
                              case ZIGB_SYSCMD_COLONYPARAM_REQPERIOD:{
                              
                                      /*>>>>>>>>>>>>>>>>>>>frame_data reference<<<<<<<<<<<<<<<*/
                                      /*------------------------------------------------------*/
                                      /*  frame_data[0]                       |       frame_data[1...3]               |
                                      /*------------------------------------------------------*/
                                      /*      ×î½üÒ»´Î³¡¾°¿ØÖÆ×´Ì¬Öµ  |       ×î½üÒ»´Î»¥¿Ø¸üÐÂ×´Ì¬Öµ  |
                                      /*------------------------------------------------------*/
                                      
                                      u8 idata statusRelay_temp = status_Relay; //¿ª¹Ø¶¯×÷Ö´ÐÐ»º´æ
                                      
              //#if(DEBUG_LOGOUT_EN == 1)
              //                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
              //                                      u8 xdata log_buf[64];
              //                                      
              //                                      sprintf(log_buf, "curRealy_Val:%02X, dataQuery result:%02X %02X %02X %02X.\n",
              //                                                                       (int)status_Relay,
              //                                                                       (int)dats.dats[0],
              //                                                                       (int)dats.dats[1],
              //                                                                       (int)dats.dats[2],
              //                                                                       (int)dats.dats[3]);
              //                                      PrintString1_logOut(log_buf);
              //                              }                       
              //#endif                
                                      if(dats.dats[0] != colonyCtrlGet_statusLocalScene){ //³¡¾°×´Ì¬ÖµÂÖÑ¯¸üÐÂ
                                      
              #if(DEBUG_LOGOUT_EN == 1)
                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 27  

                                                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
                                                      sprintf(log_buf, "differ scene detect from poling.\n");
                                                      PrintString1_logOut(log_buf);
                                              }                       
              #endif  
                                              
                                              //ÉÏÒ»´Î³¡¾°¿ØÖÆÈôÃ»ÓÐÊÕµ½£¬Ôò½øÐÐ²¹³¥²Ù×÷
                                              colonyCtrlGet_statusLocalScene = dats.dats[0];
                                              
                                              if(colonyCtrlGet_statusLocalScene <= 0x07){ //3bitÒÔÄÚ²Ù×÷ÎªÓÐÐ§Öµ£¬±ãÓÚ³õÊ¼»¯²Ù×÷Å×ÆúÎÞÐ§Öµ
                                              
                                                      swCommand_fromUsr.actMethod = relay_OnOff;
                                                      swCommand_fromUsr.objRelay = colonyCtrlGet_statusLocalScene;
                                              }
                                      }
                                      
                                      if(memcmp(&dats.dats[1], colonyCtrlGet_statusLocalEaCtrl, clusterNum_usr)){ //»¥¿Ø×´Ì¬ÖµÖµÂÖÑ¯¸üÐÂ
                                              
                                              u8 idata loop;
                                              
              #if(DEBUG_LOGOUT_EN == 1)
                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
                                                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
                                                      sprintf(log_buf, "differ eachCtrl detect from poling, currentVal is: %02X %02X %02X.\n", (int)colonyC
             -trlGet_statusLocalEaCtrl[0],
                                                                                                                                                                                                                                       (int)colonyCtrlGet_statusLocalEaCtrl[1],
                                                                                                                                                                                                                                       (int)colonyCtrlGet_statusLocalEaCtrl[2]);
                                                      PrintString1_logOut(log_buf);
                                              }                       
              #endif
                                              //ÉÏÒ»´Î»¥¿ØÈôÃ»ÓÐÊÕµ½£¬Ôò½øÐÐ²¹³¥²Ù×÷
                                              memcpy(colonyCtrlGet_statusLocalEaCtrl, &dats.dats[1], clusterNum_usr);
                                              
                                              for(loop = 0; loop < clusterNum_usr; loop ++){ //ÑÚÂëÅÐ¶Ï²Ù×÷Î»£¬±ãÓÚ³õÊ¼»¯²Ù×÷Å×ÆúÎÞÐ§Öµ
                                              
                                                      if(colonyCtrlGet_statusLocalEaCtrl[loop] == STATUSLOCALEACTRL_VALMASKRESERVE_ON)statusRelay_temp |= (
             -1 << loop);
                                                      if(colonyCtrlGet_statusLocalEaCtrl[loop] == STATUSLOCALEACTRL_VALMASKRESERVE_OFF)statusRelay_temp &= 
             -~(1 << loop);
                                                      
                                                      swCommand_fromUsr.actMethod = relay_OnOff;
                                                      swCommand_fromUsr.objRelay = statusRelay_temp;
                                              }
                                      }
                                      
                              }break;
              #endif /*ºêÅÐÎ²*///¼¯Èº¿ØÖÆÐÅÏ¢ÖÜÆÚ²éÑ¯Ê¹ÄÜ
1588   2                      default:break;
1589   2              }
1590   1      }
1591          
1592          /*zigbee³£¹æ¿ØÖÆ×ª·¢Êý¾Ý½âÎö*/
1593          static 
1594          void dataParing_Nomal(u8 datsParam[], u16 nwkAddr_from, u8 port_from){
1595   1              
1596   1      #define dataLen_dataParingNomal 96
1597   1              u8 xdata paramTX_temp[dataLen_dataParingNomal] = {0};
1598   1              
1599   1              bit dataFromRemote_IF = 0;      //ÊÇ·ñÎª·þÎñÆ÷¶ËÊý¾Ý±êÖ¾
1600   1      
1601   1              /*²úÆ·¶þ¼¶Ð­ÒéºË¶Ô_³£¹æ¿ØÖÆ*///¿ØÖÆÏÂ´ï
1602   1              switch(datsParam[0]){
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 28  

1603   2              
1604   2                      /*Ô¶¶Ë*/
1605   2                      case ZIGB_FRAMEHEAD_CTRLREMOTE:{
1606   3                              
1607   3                              dataFromRemote_IF = 1;
1608   3                              
1609   3                              memcpy(MAC_ID_DST, &datsParam[7], 6);
1610   3                              memcpy(&datsParam[1], &datsParam[13], datsRcv_ZIGB.rcvDats[20] - 13);
1611   3                      }
1612   2                      
1613   2                      /*±¾µØ*/
1614   2                      case ZIGB_FRAMEHEAD_CTRLLOCAL:{
1615   3                              
1616   3                              bit frameCheck_Done = 0; //Êý¾Ý¼ì²âºÏ¸ñ±êÖ¾
1617   3                              
1618   3                              {
1619   4                                      bit frameCodeCheck_PASS = 0; //Ð£ÑéÂë¼ì²éÍ¨¹ý±êÖ¾
1620   4                                      bit frameMacCheck_PASS  = 0; //macµØÖ·´ý¼ì²éÍ¨¹ý±êÖ¾
1621   4                                      
1622   4                                      if(datsParam[4] == frame_Check(&datsParam[5], 28))frameCodeCheck_PASS = 1; //Ð£ÑéÂë¼ì²â
1623   4                                      if(!memcmp(&datsParam[5], &MAC_ID[1], 5))frameMacCheck_PASS = 1; //MAC¼ì²â
1624   4      
1625   4                                      if(datsParam[3] == FRAME_MtoZIGBCMD_cmdConfigSearch){ //ÌØÊâÖ¸Áî²»×öMAC¼ì²â
1626   5                                      
1627   5                                              frameMacCheck_PASS = 1;
1628   5                                              
1629   5                                      }else
1630   4                                      if((datsParam[3] == FRAME_MtoZIGBCMD_cmdCfg_swTim) || //ÌØÊâÖ¸Áî²»×öÐ£ÑéÂë¼ì²â
1631   4                                         (datsParam[3] == FRAME_MtoZIGBCMD_cmdswTimQuery)){
1632   5                                         
1633   5                                              frameCodeCheck_PASS = 1;
1634   5                                      }
1635   4                                         
1636   4                                      if(frameCodeCheck_PASS && frameCodeCheck_PASS)frameCheck_Done = 1;
1637   4                              }
1638   3                                 
1639   3                              if(frameCheck_Done){ //Ö¡¼ì²éÍ¨¹ý£¬¿ªÊ¼½âÎö¡¢¶¯×÷¼°ÏìÓ¦
1640   4                                      
1641   4                                      bit respond_IF          = 0;    //ÊÇ·ñ»Ø¸´
1642   4                                      bit specialCmd_IF       = 0;    //ÊÇ·ñÎªÌØÊâÖ¸Áî£¨ÌØÊâÖ¸ÁîÕ¼ÓÃ¿ª¹ØÀàÐÍÄÇÒ»¸ö×Ö½Ú£©
1643   4                                      
1644   4      #if(DEBUG_LOGOUT_EN == 1)
1645   4                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1646   5                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1647   5                                              sprintf(log_buf, "cmdComing:%02X.\n", (int)datsParam[3]);
1648   5                                              PrintString1_logOut(log_buf);
1649   5                                      }                       
1650   4      #endif          
1651   4                                      memset(paramTX_temp, 0, sizeof(u8) * dataLen_dataParingNomal);
1652   4                              
1653   4                                      switch(datsParam[3]){
1654   5                                      
1655   5                                              case FRAME_MtoZIGBCMD_cmdConfigSearch:{
1656   6                                                      
1657   6                                                      if(!deviceLock_flag){ //Éè±¸ÊÇ·ñÉÏËø
1658   7                                                              
1659   7                                                              u16 xdata panid_Temp = ZigB_getPanIDCurrent(); //ÅäÖÃ»Ø¸´Ìí¼ÓPANID
1660   7                                                              
1661   7                                                              paramTX_temp[11] = status_Relay;
1662   7                                                              
1663   7                                                              paramTX_temp[14] = (u8)((panid_Temp & 0xFF00) >> 8);
1664   7                                                              paramTX_temp[15] = (u8)((panid_Temp & 0x00FF) >> 0);
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 29  

1665   7                                                              
1666   7                                                              sysTimeZone_H = datsParam[12];
1667   7                                                              sysTimeZone_M = datsParam[13];
1668   7                                                              coverEEPROM_write_n(EEPROM_ADDR_timeZone_H, &sysTimeZone_H, 1);
1669   7                                                              coverEEPROM_write_n(EEPROM_ADDR_timeZone_M, &sysTimeZone_M, 1);
1670   7                                                              
1671   7                                                              periodDataTrans_momentHang(10); //½ÓÊÕµ½ËÑË÷Âëºó ½«ÆäËûÖÜÆÚÖ÷¶¯·¢ÂëÍ¨ÐÅ½øÐÐ±ÜÈÃ ÎªËÑË÷ÏìÓ¦ÇåÂ· 10s
1672   7                                                      
1673   7                                                              respond_IF              = 1; //ÏìÓ¦»Ø¸´
1674   7                                                              specialCmd_IF   = 0;
1675   7                                                              
1676   7                                                      }else{
1677   7                                                      
1678   7                                                              
1679   7                                                      }
1680   6                                                      
1681   6                                              }break;
1682   5                                              
1683   5                                              case FRAME_MtoZIGBCMD_cmdControl:{
1684   6      
1685   6                                                      paramTX_temp[11] = 0;
1686   6                                                      paramTX_temp[11] |= (datsParam[11] & 0x07);     //×´Ì¬Î»Ìî×°
1687   6                                                      if(             (datsParam[11] & 0x01) != (status_Relay & 0x01))paramTX_temp[11] |= 0x20; //¸ü¸ÄÖµÌî×°<¸ßÈýÎ»>µ
             -ÚÒ»Î»
1688   6                                                      else if((datsParam[11] & 0x02) != (status_Relay & 0x02))paramTX_temp[11] |= 0x40; //¸ü¸ÄÖµÌî×°<¸ßÈýÎ
             -»>µÚ¶þÎ»
1689   6                                                      else if((datsParam[11] & 0x04) != (status_Relay & 0x04))paramTX_temp[11] |= 0x80; //¸ü¸ÄÖµÌî×°<¸ßÈýÎ
             -»>µÚÈýÎ»
1690   6                                                      
1691   6                                                      swCommand_fromUsr.objRelay = datsParam[11];
1692   6                                                      swCommand_fromUsr.actMethod = relay_OnOff;
1693   6      
1694   6                                                      respond_IF              = 1; //ÏìÓ¦»Ø¸´
1695   6                                                      specialCmd_IF   = 0;                                                    
1696   6                                                      
1697   6                                              }break;
1698   5                                                      
1699   5                                              case FRAME_MtoZIGBCMD_cmdQuery:{}break;
1700   5                                                      
1701   5                                              case FRAME_MtoZIGBCMD_cmdInterface:{}break;
1702   5                                                      
1703   5                                              case FRAME_MtoZIGBCMD_cmdReset:{}break;
1704   5                                                      
1705   5                                              case FRAME_MtoZIGBCMD_cmdDevLockON:{
1706   6                                              
1707   6                                                      //Êý¾Ý´¦Àí¼°¶¯×÷ÏìÓ¦
1708   6                                                      {
1709   7                                                              u8 deviceLock_IF = 1;
1710   7                                                              
1711   7                                                              deviceLock_flag  = 1;
1712   7                                                              coverEEPROM_write_n(EEPROM_ADDR_deviceLockFLAG, &deviceLock_IF, 1);
1713   7                                                      }               
1714   6                                                      
1715   6                                              }break;
1716   5                                                      
1717   5                                              case FRAME_MtoZIGBCMD_cmdDevLockOFF:{
1718   6                                              
1719   6                                                      //Êý¾Ý´¦Àí¼°¶¯×÷ÏìÓ¦
1720   6                                                      {
1721   7                                                              u8 deviceLock_IF = 0;
1722   7                                                              
1723   7                                                              deviceLock_flag  = 0;
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 30  

1724   7                                                              coverEEPROM_write_n(EEPROM_ADDR_deviceLockFLAG, &deviceLock_IF, 1);
1725   7                                                      }       
1726   6                                              
1727   6                                              }break;
1728   5                                                      
1729   5                                              case FRAME_MtoZIGBCMD_cmdswTimQuery:{
1730   6                                              
1731   6                                                      //·ÖÀà»Ø¸´
1732   6                                                      switch(datsParam[13]){ //×ÓÃüÁî½âÎö
1733   7                                                      
1734   7                                                              case 0: /*ÉÏÎ»»úÔÚ¶¨Ê±µÄÊ±ºò¸ø0£¬´ýÐ­ÉÌ*/
1735   7                                                              case cmdConfigTim_normalSwConfig:{
1736   8                                                              
1737   8                                                                      u8 loop = 0;
1738   8                                                              
1739   8                                                                      //Êý¾ÝÏìÓ¦¼°»Ø¸´
1740   8                                                                      EEPROM_read_n(EEPROM_ADDR_swTimeTab, &paramTX_temp[14], 12);    //¶¨Ê±±í»Ø¸´Ìî×°
1741   8                                                                      
1742   8                                                                      //»Ø¸´Êý¾Ý¶þ´Î´¦Àí£¨Õë¶ÔÒ»´ÎÐÔ¶¨Ê±Êý¾Ý£©
1743   8                                                                      for(loop = 0; loop < 4; loop ++){
1744   9                                                                      
1745   9                                                                              if(swTim_onShoot_FLAG & (1 << loop)){
1746  10                                                                                      
1747  10                                                                                      paramTX_temp[14 + loop * 3] &= 0x80;
1748  10                                                                              }
1749   9                                                                      }
1750   8                                                                                      
1751   8                                                                      specialCmd_IF = 1; //ÌØÊâÕ¼Î»Ö¸Áî
1752   8                                                                      
1753   8      #if(DEBUG_LOGOUT_EN == 1)
1754   8                                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1755   9                                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1756   9                                                                              sprintf(log_buf, ">>>>>>>>timer_tab3 respond:[%02X-%02X-%02X].\n", (int)paramTX_temp[20], (int)pa
             -ramTX_temp[21], (int)paramTX_temp[22]);
1757   9                                                                              PrintString1_logOut(log_buf);
1758   9                                                                      }                       
1759   8      #endif  
1760   8                                                                      
1761   8                                                              }break;
1762   7                                                              
1763   7                                                              case cmdConfigTim_onoffDelaySwConfig:{
1764   8                                                              
1765   8                                                                      if(!delayCnt_onoff)paramTX_temp[14] = 0;
1766   8                                                                      else paramTX_temp[14] = delayPeriod_onoff - (u8)(delayCnt_onoff / 60);
1767   8                                                                      paramTX_temp[15] = delayUp_act;
1768   8                                                                      
1769   8                                                              }break;
1770   7                                                              
1771   7                                                              case cmdConfigTim_closeLoopSwConfig:{
1772   8                                                              
1773   8                                                                      paramTX_temp[14] = delayPeriod_closeLoop;
1774   8                                                                      
1775   8                                                              }break;
1776   7                                                              
1777   7                                                              case cmdConfigTim_nightModeSwConfig:{  
1778   8                                                              
1779   8                                                                      EEPROM_read_n(EEPROM_ADDR_TimeTabNightMode, &paramTX_temp[14], 6);      //Ò¹¼äÄ£Ê½¶¨Ê±±í»Ø¸´Ìî×°
1780   8                                                                      
1781   8                                                                      (deviceLock_flag)?(paramTX_temp[12] |= 0x01):(paramTX_temp[12] &= ~0x01);
1782   8                                                                      (ifNightMode_sw_running_FLAG)?(paramTX_temp[12] |= 0x02):(paramTX_temp[12] &= ~0x02);
1783   8                                                                      
1784   8                                                              }break;
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 31  

1785   7                                                              
1786   7                                                              default:break;
1787   7                                                      }
1788   6                                                      
1789   6                                                      paramTX_temp[13] = datsParam[13]; //¶¨Ê±×ÓÃüÁîÍ¬²½»Ø¸´
1790   6                                                      
1791   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1792   6                                                      
1793   6                                              }break;
1794   5                                                      
1795   5                                              case FRAME_MtoZIGBCMD_cmdConfigAP:{}break;
1796   5                                                      
1797   5                                              case FRAME_MtoZIGBCMD_cmdBeepsON:{ //Ò¹¼äÄ£Ê½¹Ø
1798   6                                              
1799   6                                                      u8 datsTemp = 0;
1800   6                                                      
1801   6                                                      EEPROM_read_n(EEPROM_ADDR_TimeTabNightMode, &datsTemp, 1);
1802   6                                                      datsTemp &= ~0x7f; //Ò¹¼äÄ£Ê½¶¨Ê±±í´æ´¢,È¡ÏûÍ·×Ö½ÚÈ«Õ¼Âú,Ê§ÄÜÈ«Ìì
1803   6                                                      coverEEPROM_write_n(EEPROM_ADDR_TimeTabNightMode, &datsTemp, 1);
1804   6                                                      
1805   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1806   6                                                      
1807   6                                              }break;
1808   5                                                      
1809   5                                              case FRAME_MtoZIGBCMD_cmdBeepsOFF:{ //Ò¹¼äÄ£Ê½¿ª
1810   6                                              
1811   6                                                      u8 datsTemp = 0;
1812   6                                                      
1813   6                                                      EEPROM_read_n(EEPROM_ADDR_TimeTabNightMode, &datsTemp, 1);
1814   6                                                      datsTemp |= 0x7f; //Ò¹¼äÄ£Ê½¶¨Ê±±í´æ´¢,Í·×Ö½ÚÈ«Õ¼Âú,Ç¿ÖÆÈ«Ìì
1815   6                                                      coverEEPROM_write_n(EEPROM_ADDR_TimeTabNightMode, &datsTemp, 1);        
1816   6                                                      
1817   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1818   6                                                      
1819   6                                              }break;
1820   5                                                      
1821   5                                              case FRAME_MtoZIGBCMD_cmdftRecoverRQ:{
1822   6                                              
1823   6                                                      respond_IF = 1;
1824   6                                                      
1825   6                                              }break;
1826   5                                                      
1827   5                                              case FRAME_MtoZIGBCMD_cmdRecoverFactory:{
1828   6                                              
1829   6                                                      Factory_recover();
1830   6                                              
1831   6                                              }break;
1832   5                                                      
1833   5                                              case FRAME_MtoZIGBCMD_cmdCfg_swTim:{
1834   6                                                      
1835   6                                                      u8 loop = 0;
1836   6                                                      
1837   6                                                      switch(datsParam[13]){ //¶¨Ê±Êý¾Ý´¦Àí¼°¸üÐÂ,·ÖÀà´¦Àí
1838   7                                                      
1839   7                                                              case cmdConfigTim_normalSwConfig:{      /*ÆÕÍ¨¶¨Ê±*/
1840   8                                                                      
1841   8                                                                      for(loop = 0; loop < 4; loop ++){
1842   9                                                                      
1843   9                                                                              if(datsParam[14 + loop * 3] == 0x80){   /*Ò»´ÎÐÔ¶¨Ê±ÅÐ¶Ï*///ÖÜÕ¼Î»Îª¿Õ£¬¶ø¶¨Ê±Æ÷±»´ò¿ª£¬ËµÃ÷ÊÇÒ»´ÎÐ
             -Ô
1844  10                                                                              
1845  10                                                                                      swTim_onShoot_FLAG      |= (1 << loop); //Ò»´ÎÐÔ¶¨Ê±±êÖ¾¿ªÆô
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 32  

1846  10                                                                                      datsParam[14 + loop * 3] |= (1 << (systemTime_current.time_Week - 1)); //Ç¿ÐÐ½øÐÐµ±Ç°ÖÜÕ¼Î»£¬µ±´
             -ÎÖ´ÐÐÍê±ÏºóÇå³ý
1847  10                                                                              }
1848   9                                                                      }
1849   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_swTimeTab, &datsParam[14], 4 * 3);      //¶¨Ê±±í
1850   8                                                                      
1851   8      #if(DEBUG_LOGOUT_EN == 1)
1852   8                                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1853   9                                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
1854   9                                                                              sprintf(log_buf, ">>>>>>>>timer_tab3 has been set:[%02X-%02X-%02X].\n", (int)datsParam[20], (int)
             -datsParam[21], (int)datsParam[22]);
1855   9                                                                              PrintString1_logOut(log_buf);
1856   9                                                                      }                       
1857   8      #endif  
1858   8                                                              
1859   8                                                              }break;
1860   7                                                              
1861   7                                                              case cmdConfigTim_onoffDelaySwConfig:{  /*¿ª¹ØÑÓÊ±*/
1862   8                                                              
1863   8                                                                      if(datsParam[14]){
1864   9                                                                      
1865   9                                                                              ifDelay_sw_running_FLAG |= (1 << 1);
1866   9                                                                              delayPeriod_onoff               = datsParam[14];
1867   9                                                                              
1868   9                                                                              delayUp_act                             = datsParam[15];
1869   9                                                                              
1870   9                                                                              delayCnt_onoff                  = 0;
1871   9                                                                              
1872   9                                                                      }else{
1873   9                                                                      
1874   9                                                                              ifDelay_sw_running_FLAG &= ~(1 << 1);
1875   9                                                                              delayPeriod_onoff               = 0;
1876   9                                                                              delayCnt_onoff                  = 0;
1877   9                                                                      }
1878   8                                                                      
1879   8                                                              }break;
1880   7                                                              
1881   7                                                              case cmdConfigTim_closeLoopSwConfig:{   /*ÂÌÉ«¹¦ÄÜ(×Ô¶¯Ñ­»·¹Ø±Õ)*/
1882   8                                                              
1883   8                                                                      if(datsParam[14]){
1884   9                                                                      
1885   9                                                                              ifDelay_sw_running_FLAG |= (1 << 0);
1886   9                                                                              delayPeriod_closeLoop   = datsParam[14];
1887   9                                                                              delayCnt_closeLoop              = 0;
1888   9                                                                              
1889   9                                                                      }else{
1890   9                                                                      
1891   9                                                                              ifDelay_sw_running_FLAG &= ~(1 << 0);
1892   9                                                                              delayPeriod_closeLoop   = 0;
1893   9                                                                              delayCnt_closeLoop              = 0;
1894   9                                                                      }
1895   8                                                                      
1896   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_swDelayFLAG, &ifDelay_sw_running_FLAG, 1);
1897   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_periodCloseLoop, &delayPeriod_closeLoop, 1);
1898   8                                                                      
1899   8                                                              }break;         
1900   7      
1901   7                                                              case cmdConfigTim_nightModeSwConfig:{  /*Ò¹¼äÄ£Ê½ ±³¹â°ëÁÁ*/
1902   8                                                              
1903   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_TimeTabNightMode, &datsParam[14], 6);   //Ò¹¼äÄ£Ê½¶¨Ê±±í´æ´¢
1904   8                                                                      
1905   8                                                              }break;
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 33  

1906   7                                                              
1907   7                                                              default:break;
1908   7                                                      }
1909   6                                                      
1910   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1911   6                                                      
1912   6                                              }break;
1913   5                                              
1914   5                                              case FRAME_MtoZIGBCMD_cmdCfg_ctrlEachO:{
1915   6                                              
1916   6                                                      u8 loop = 0;
1917   6                                                      u8 effective_oprate = datsParam[12]; //ÓÐÐ§²Ù×÷Êý¾ÝÕ¼Î»»ñÈ¡
1918   6                                                      
1919   6                                                      for(loop = 0; loop < clusterNum_usr; loop ++){
1920   7                                                      
1921   7                                                              if((effective_oprate >> loop) & 0x01){ //ÓÐÐ§Êý¾ÝÅÐ¶Ï
1922   8                                                              
1923   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_portCtrlEachOther + loop, &datsParam[14 + loop], 1);
1924   8                                                                      CTRLEATHER_PORT[loop] = datsParam[14 + loop];
1925   8                                                                      reConnectAfterDatsReq_IF = 1; //¼´¿Ì×¢²á»¥¿ØÍ¨Ñ¶´Ø¶Ë¿Ú
1926   8                                                              }
1927   7                                                      }
1928   6                                                      
1929   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1930   6                                              
1931   6                                              }break;
1932   5                                              
1933   5                                              case FRAME_MtoZIGBCMD_cmdQue_ctrlEachO:{
1934   6                                              
1935   6                                                      u8 loop = 0;
1936   6                                                      
1937   6                                                      for(loop = 0; loop < clusterNum_usr; loop ++){
1938   7                                                      
1939   7                                                              EEPROM_read_n(EEPROM_ADDR_portCtrlEachOther + loop, &paramTX_temp[14 + loop], 1);
1940   7                                                      }
1941   6                                                      
1942   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1943   6                                              
1944   6                                              }break;
1945   5                                                      
1946   5                                              case FRAME_MtoZIGBCMD_cmdCfg_ledBackSet:{
1947   6                                              
1948   6                                                      coverEEPROM_write_n(EEPROM_ADDR_ledSWBackGround, &datsParam[14], 1);
1949   6                                                      coverEEPROM_write_n(EEPROM_ADDR_ledSWBackGround + 1, &datsParam[15], 1);
1950   6                                                      tipsInsert_swLedBKG_ON  = datsParam[14];
1951   6                                                      tipsInsert_swLedBKG_OFF = datsParam[15];
1952   6                                                      
1953   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1954   6                                              
1955   6                                              }break;
1956   5                                              
1957   5                                              case FRAME_MtoZIGBCMD_cmdQue_ledBackSet:{
1958   6                                              
1959   6                                                      EEPROM_read_n(EEPROM_ADDR_ledSWBackGround, &paramTX_temp[14], 1);
1960   6                                                      EEPROM_read_n(EEPROM_ADDR_ledSWBackGround + 1, &paramTX_temp[15], 1);
1961   6                                                      
1962   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1963   6                                              
1964   6                                              }break;
1965   5                                              
1966   5      //                                      case FRAME_MtoZIGBCMD_cmdCfg_scenarioSet:{
1967   5      //                                              
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 34  

1968   5      //                                              u16 xdata panid_Temp = ZigB_getPanIDCurrent(); //ÅäÖÃ»Ø¸´Ìí¼ÓPANID
1969   5      //                                      
1970   5      //                                              bit opt_result = swScenario_oprateSave(datsParam[12], datsParam[14]);
1971   5      //                                              if(opt_result)paramTX_temp[12] = 0;
1972   5      //                                              else paramTX_temp[12] = 0x0A; //³¡¾°ÉèÖÃÎÞÐ§»Ø¸´£¨³¡¾°´æ´¢ÒÑÂú£©
1973   5      //                                              
1974   5      //                                              paramTX_temp[14] = (u8)((panid_Temp & 0xFF00) >> 8);
1975   5      //                                              paramTX_temp[15] = (u8)((panid_Temp & 0x00FF) >> 0);
1976   5      //                                              
1977   5      //                                              respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ£¨±¾µØ´æ´¢ÒÑ±»Õ¼Âú£©
1978   5      //                                      
1979   5      //                                      }break;
1980   5      //                                      
1981   5      //                                      case FRAME_MtoZIGBCMD_cmdCfg_scenarioCtl:{
1982   5      //                                              
1983   5      //                                              u8 sw_Act = swScenario_oprateCheck(datsParam[12]);
1984   5      //                                              if(sw_Act != SW_SCENCRAIO_ACTINVALID){ //ÈôË÷Òýµ½ÓÐÐ§²Ù×÷Î»
1985   5      //                                                      
1986   5      //                                                      swCommand_fromUsr.actMethod = relay_OnOff;
1987   5      //                                                      swCommand_fromUsr.objRelay = sw_Act;
1988   5      //                                              
1989   5      //                                                      paramTX_temp[12] = 0;
1990   5      //                                                      
1991   5      //                                              }else{ //ÈôÎÞ·¨Ë÷Òýµ½ÓÐÐ§²Ù×÷Î»
1992   5      //                                              
1993   5      //                                                      paramTX_temp[12] = 0x0A; //³¡¾°¿ØÖÆÎÞÐ§»Ø¸´£¨³¡¾°ºÅÎÞ·¨±»Ë÷Òý£©
1994   5      //                                              }
1995   5      //                                      
1996   5      //                                              respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1997   5      //                                      
1998   5      //                                      }break;
1999   5      //                                      
2000   5      //                                      case FRAME_MtoZIGBCMD_cmdCfg_scenarioDel:{
2001   5      //                                              
2002   5      //                                              swScenario_oprateDele(datsParam[12]);
2003   5      //                                              paramTX_temp[12] = 0;
2004   5      //                                      
2005   5      //                                              respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
2006   5      //                                      
2007   5      //                                      }break;
2008   5                                              
2009   5                                              default:{
2010   6                                              
2011   6                                                      respond_IF = 0;
2012   6                                              
2013   6                                              }break;
2014   5                                      }
2015   4                                      
2016   4                                      /*»Ø¸´ÏìÓ¦*/
2017   4                                      if(respond_IF){ //Êý¾Ý°ü»Ø¸´ÏìÓ¦¶¯×÷
2018   5                                      
2019   5                                              u8 datsTX_Len = 0;
2020   5                                              
2021   5                                              respond_IF = 0;
2022   5                                              
2023   5                                              datsTX_Len = dtasTX_loadBasic_CUST(dataFromRemote_IF,
2024   5                                                                                                                 paramTX_temp,
2025   5                                                                                                                 33,
2026   5                                                                                                                 FRAME_TYPE_StoM_RCVsuccess,
2027   5                                                                                                                 datsParam[3],
2028   5                                                                                                                 specialCmd_IF);
2029   5                                              
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 35  

2030   5                                              heartBeatCount += 1; //ÑÓÊ±ÐÔÐ­µ÷ÐÄÌøÖÍºó 1s
2031   5                                              
2032   5                                              datsSend_request.nwkAddr = nwkAddr_from;
2033   5                                              datsSend_request.portPoint = port_from;
2034   5                                              memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
2035   5                                              memcpy(datsSend_request.datsTrans.dats, paramTX_temp, datsTX_Len);
2036   5                                              datsSend_request.datsTrans.datsLen = datsTX_Len;
2037   5                                              datsRcv_respond.datsTrans.datsLen = 0;
2038   5                                              devRunning_Status = status_dataTransRequestDatsSend;
2039   5                                              
2040   5      //#if(DEBUG_LOGOUT_EN == 1)
2041   5      //                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2042   5      //                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2043   5      //                                              sprintf(log_buf, ">>>>>>>>standby dataTX_buf_tab3:[%02X-%02X-%02X].\n", (int)datsSend_request.dats
             -Trans.dats[20], (int)datsSend_request.datsTrans.dats[21], (int)datsSend_request.datsTrans.dats[22]);
2044   5      //                                              PrintString1_logOut(log_buf);
2045   5      //                                      }                       
2046   5      //#endif        
2047   5                                      }
2048   4                              }
2049   3                      }break;
2050   2                      
2051   2                      /*ÐÄÌø_Íø¹ØÔÚÏß*/
2052   2                      case ZIGB_FRAMEHEAD_HEARTBEAT:{
2053   3                      
2054   3                              
2055   3                              
2056   3                      }break;
2057   2                      
2058   2                      /*ÐÄÌø_Íø¹ØÀëÏß*///internetÀëÏß£¬²»ÊÇzigbÍøÂçÀëÏß
2059   2                      case ZIGB_FRAMEHEAD_HBOFFLINE:{
2060   3                      
2061   3                              
2062   3                              
2063   3                      }break;
2064   2                      
2065   2      #if(ZIGB_DATATRANS_WORKMODE == DATATRANS_WORKMODE_KEEPACESS) /*ºêÅÐÍ·*///¶¨Ê±ÀàÍ¨Ñ¶Ä£Ê½ÅÐ¶Ï
2066   2                      /*¶¨Ê±Ñ¯·Ã_Íø¹ØÔÚÏß*/
2067   2                      case DTMODEKEEPACESS_FRAMEHEAD_ONLINE:{
2068   3                      
2069   3                              stt_agingDataSet_bitHold code   agingCmd_Temp = {0};
2070   3                              stt_devOpreatDataPonit xdata    dev_dataPointTemp = {0};
2071   3                              
2072   3                              bit frameCodeCheck_PASS = 0; //Ð£ÑéÂë¼ì²éÍ¨¹ý±êÖ¾
2073   3                              bit frameMacCheck_PASS  = 0; //macµØÖ·´ý¼ì²éÍ¨¹ý±êÖ¾
2074   3                              
2075   3      //#if(DEBUG_LOGOUT_EN == 1)
2076   3      //                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2077   3      //                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2078   3      //                              sprintf(log_buf, "periodKeepAcess respondRcv, cmd[%02X], dataLen[%02d].\n", (int)datsParam[8], (int)
             -datsParam[1]);
2079   3      //                              PrintString1_logOut(log_buf);
2080   3      //                      }                       
2081   3      //#endif        
2082   3                              
2083   3                              if(datsParam[datsParam[1] - 1] == frame_Check(&datsParam[1], datsParam[1] - 2))frameCodeCheck_PASS = 1;
2084   3                              if(!memcmp(&datsParam[2], &MAC_ID[1], 5))frameMacCheck_PASS = 1;
2085   3                              
2086   3                              if(frameCodeCheck_PASS && frameMacCheck_PASS){ 
2087   4                      
2088   4                                      memcpy(&dev_dataPointTemp, &datsParam[15], sizeof(stt_devOpreatDataPonit)); //Êý¾Ý½á¹¹»¯
2089   4                                      
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 36  

2090   4      //#if(DEBUG_LOGOUT_EN == 1)
2091   4      //                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2092   4      //                                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2093   4      //                                      sprintf(log_buf, "agingCmd[%02X], swAging[%d], val[%02X].\n", (int)datsParam[8],
2094   4      //                                                                                                                                                                (int)dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_swOpreat, 
2095   4      //                                                                                                                                                                (int)dev_dataPointTemp.devStatus_Reference.statusRef_swStatus);
2096   4      //                                      PrintString1_logOut(log_buf);
2097   4      //                              }                       
2098   4      //#endif        
2099   4                              
2100   4                                      switch(datsParam[8]){ //Ö¡ÃüÁî
2101   5                                      
2102   5                                              case DTMODEKEEPACESS_FRAMECMD_ASR:{
2103   6                                                      
2104   6                                                      static bit local_ftyRecover_standbyFLG = 0; //»Ö¸´³ö³§ÉèÖÃ²Ù×÷Ô¤¶¯×÷±êÖ¾
2105   6                                      
2106   6                                                      /*·ÇÊ±Ð§ÐÔÃüÁîÅÐ¶Ï*///Êý¾Ý²»Ò»ÖÂÊ±£¬¸üÐÂ»º´æºóÖ´ÐÐ¶¯×÷¼´¿É£¨·ÇÊ±Ð§ÔòÃ¿´Î»ñÈ¡Êý¾ÝÊ±¶¼ÒªÓë±¾µØÊý¾Ý×÷±È
             -½Ï£©
2107   6      //                                              { //ÆÕÍ¨¿ª¹Ø²Ù×÷£¬ÎÞÐèÊ±Ð§
2108   6      //                                              
2109   6      //                                                      if((status_Relay & 0x07) != dev_dataPointTemp.devStatus_Reference.statusRef_swStatus){ 
2110   6      //                                                      
2111   6      //                                                              swCommand_fromUsr.objRelay = dev_dataPointTemp.devStatus_Reference.statusRef_swStatus;
2112   6      //                                                              swCommand_fromUsr.actMethod = relay_OnOff;
2113   6      //                                                              
2114   6      //#if(DEBUG_LOGOUT_EN == 1)
2115   6      //                                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2116   6      //                                                                      
2117   6      //                                                                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2118   6      //                                                                      sprintf(log_buf, ">>>>>>>>relayStatus reales:%02X, currentVal:%02X.\n", (int)status_Relay & 0x0
             -7, (int)dev_dataPointTemp.devStatus_Reference.statusRef_swStatus);
2119   6      //                                                                      PrintString1_logOut(log_buf);
2120   6      //                                                              }                       
2121   6      //#endif        
2122   6      //                                                      }
2123   6      //                                              }
2124   6                                                      
2125   6      //                                              { //¿ª¹Ø¶¨Ê±²Ù×÷£¬ÎÞÐèÊ±Ð§
2126   6      //                                              
2127   6      //                                                      timing_Dats xdata timDatsTemp_CalibrateTab[TIMEER_TABLENGTH] = {0};
2128   6      //                                                      
2129   6      //                                                      datsTiming_read_eeprom(timDatsTemp_CalibrateTab);
2130   6      //                                                      if(memcmp(timDatsTemp_CalibrateTab, dev_dataPointTemp.devData_timer, sizeof(timing_Dats) * TIMEER
             -_TABLENGTH)){ //Êý¾Ý²»Ò»ÖÂÔò¸üÐÂeeprom
2131   6      //                                                      
2132   6      //                                                              coverEEPROM_write_n(EEPROM_ADDR_swTimeTab, dev_dataPointTemp.devData_timer, sizeof(timing_Dats) 
             -* TIMEER_TABLENGTH);
2133   6      //                                                      }
2134   6      //                                              }
2135   6                                                      
2136   6      //                                              { //ÂÌÉ«Ä£Ê½²Ù×÷£¬ÎÞÐèÊ±Ð§
2137   6      //                                              
2138   6      //                                                      if(delayPeriod_closeLoop != dev_dataPointTemp.devData_greenMode){
2139   6      //                                                      
2140   6      //                                                              
2141   6      //                                                      }
2142   6      //                                              }
2143   6                                                      
2144   6      //                                              { //Ò¹¼äÄ£Ê½²Ù×÷£¬ÎÞÐèÊ±Ð§
2145   6      //                                                      
2146   6      //                                                      timing_Dats xdata nightDatsTemp_CalibrateTab[2];
2147   6      //                                                      
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 37  

2148   6      //                                                      datsTimNight_read_eeprom(nightDatsTemp_CalibrateTab);
2149   6      //                                                      if(memcmp(nightDatsTemp_CalibrateTab, dev_dataPointTemp.devData_nightMode, sizeof(timing_Dats) * 
             -2)){ //Êý¾Ý²»Ò»ÖÂÔò¸üÐÂeeprom
2150   6      //                                                      
2151   6      //                                                              coverEEPROM_write_n(EEPROM_ADDR_TimeTabNightMode, dev_dataPointTemp.devData_nightMode, sizeof(ti
             -ming_Dats) * 2);
2152   6      //                                                      }       
2153   6      //                                              }
2154   6                                                      
2155   6      //                                              { //±³¹âµÆÉèÖÃ²Ù×÷£¬ÎÞÐèÊ±Ð§
2156   6      //                                              
2157   6      //                                                      if(tipsInsert_swLedBKG_ON != dev_dataPointTemp.devData_bkLight[0]){ //¿ªÉ«
2158   6      //                                                      
2159   6      //                                                              
2160   6      //                                                      }
2161   6      //                                                      
2162   6      //                                                      if(tipsInsert_swLedBKG_OFF != dev_dataPointTemp.devData_bkLight[1]){ //¹ØÉ«
2163   6      //                                                      
2164   6      //                                                              
2165   6      //                                                      }
2166   6      //                                              }
2167   6                                                      
2168   6                                                      /*Ê±Ð§ÐÔÃüÁîÅÐ¶Ï*///¸üÐÂÊ±Ð§²Ù×÷ºó£¬Çå¿ÕÊ±Ð§²Ù×÷Î»£¨Ê±Ð§ÊÇÎªÁË½ÚÔ¼ÐÔÄÜ²»ÓÃÃ¿´Î²éÑ¯Ê±¶¼×÷±È½Ï£©
2169   6                                                      if(memcmp(&agingCmd_Temp, &dev_dataPointTemp.devAgingOpreat_agingReference, sizeof(stt_agingDataSet_
             -bitHold))){ //Ò»µ©ÓÐÊ±Ð§Ö¸ÁîÎ»ÖÃ 1 £¬Ö»ÒªÓÐÊ±Ð§Õ¼Î»£¬¾ÍÔ­Î»»Ø·¢
2170   7                                                              
2171   7                                                              heartBeatCount = PERIOD_HEARTBEAT_ASR; //ÓÐÊ±Ð§¿ØÖÆ£¬Ç¿ÐÐÌáÇ°ÐÄÌøÁ¢¼´»ØÂë
2172   7                                                              
2173   7                                                              memcpy(&dev_agingCmd_rcvPassive, &dev_dataPointTemp.devAgingOpreat_agingReference, sizeof(stt_aging
             -DataSet_bitHold)); //±¾µØ±»¶¯Ê±Ð§²Ù×÷»º´æÍ¬²½¸üÐÂ£¬ÓÃÓÚÔ­Î»»Ø·¢
2174   7                                                      
2175   7                                                              /*Ê±Ð§²Ù×÷½âÎö*/                
2176   7      
2177   7                                                              if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_swOpreat){ //¿ª¹Ø×´Ì¬²Ù×÷£¬ÐèÒªÊ±Ð§
2178   8                                                                      
2179   8                                                                      if((status_Relay & 0x07) != dev_dataPointTemp.devStatus_Reference.statusRef_swStatus){ 
2180   9                                                                      
2181   9                                                                              swCommand_fromUsr.objRelay = dev_dataPointTemp.devStatus_Reference.statusRef_swStatus;
2182   9                                                                              swCommand_fromUsr.actMethod = relay_OnOff;
2183   9                                                                              
2184   9      #if(DEBUG_LOGOUT_EN == 1)
2185   9                                                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2186  10                                                                                      
2187  10                                                                                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2188  10                                                                                      sprintf(log_buf, ">>>>>>>>relayStatus reales:%02X, currentVal:%02X.\n", (int)status_Relay & 0x07
             -, (int)dev_dataPointTemp.devStatus_Reference.statusRef_swStatus);
2189  10                                                                                      PrintString1_logOut(log_buf);
2190  10                                                                              }                       
2191   9      #endif  
2192   9                                                                      }
2193   8                                                              }
2194   7                                                              
2195   7                                                              if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_delaySetOpreat){ //ÑÓÊ±ÉèÖÃ²Ù×÷£¬ÐèÒªÊ±
             -Ð§
2196   8                              
2197   8                                                                      if(dev_dataPointTemp.devData_delayer){ //ÑÓÊ±Ê±¼ä´óÓÚ0¾ÍÊÇ¿ª
2198   9                                                                      
2199   9                                                                              ifDelay_sw_running_FLAG |= (1 << 1); //ÑÓÊ±±êÖ¾¸üÐÂ£¬Æô¶¯
2200   9                                                                              delayPeriod_onoff               = dev_dataPointTemp.devData_delayer; //ÑÓÊ±Ê±¼ä
2201   9                                                                              delayUp_act                             = dev_dataPointTemp.devData_delayUpStatus; //ÑÓÊ±µ½´ïÊ±£¬¿ª¹ØÏìÓ¦×´Ì¬
2202   9                                                                              delayCnt_onoff                  = 0; //ÑÓÊ±¼ÆÊýÇåÁã
2203   9      #if(DEBUG_LOGOUT_EN == 1)
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 38  

2204   9                                                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2205  10                                                                                      
2206  10                                                                                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2207  10                                                                                      sprintf(log_buf, ">>>>>>>>delayPeriod:[%d], delayUpAct:[%02X].\n", (int)delayPeriod_onoff, (int)
             -delayUp_act);
2208  10                                                                                      PrintString1_logOut(log_buf);
2209  10                                                                              }                       
2210   9      #endif  
2211   9                                                                              
2212   9                                                                      }else{
2213   9                                                                      
2214   9                                                                              ifDelay_sw_running_FLAG &= ~(1 << 0); //ÑÓÊ±±êÖ¾¸üÐÂ
2215   9                                                                              delayPeriod_onoff               = 0; 
2216   9                                                                              delayCnt_onoff                  = 0; 
2217   9                                                                      }
2218   8                                                              }
2219   7                                                              
2220   7                                                              if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_devResetOpreat){ //³ö³§ÉèÖÃ¸´Î»¶¯×÷£¬Ðè
             -ÒªÊ±Ð§
2221   8                                                                      
2222   8                                                                      local_ftyRecover_standbyFLG = 1; //½ÓÊÕµ½»Ö¸´³ö³§¶¯×÷ºó£¬½«»Ö¸´³ö³§ÉèÖÃ¶¯×÷½øÐÐ¾ÍÐ÷Ì¬¼ÇÂ¼£¬µÈ´ýÊ±Ð
             -§±êÖ¾ÖÃÁãºóÔÙ½øÐÐÊµ¼Ê¶¯×÷                                     
2223   8      #if(DEBUG_LOGOUT_EN == 1)
2224   8                                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2225   9                                                      
2226   9                                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2227   9                                                                              sprintf(log_buf, ">>>>>>>>factory recover standBy!.\n");
2228   9                                                                              PrintString1_logOut(log_buf);
2229   9                                                                      }                       
2230   8      #endif          
2231   8                                                              }
2232   7                                                              
2233   7                                                              if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_devLock){ //Éè±¸ËøÉèÖÃ²Ù×÷£¬ÐèÒªÊ±Ð§
2234   8                                                              
2235   8                                                                      u8 deviceLock_IF = 0; //²Ù×÷×Ö½Ú»º´æ
2236   8                                                                      
2237   8      #if(DEBUG_LOGOUT_EN == 1)
2238   8                                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2239   9                                                                              
2240   9                                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2241   9                                                                              sprintf(log_buf, ">>>>>>>>agingCmd devLock coming, lockIf:[%d].\n", (int)dev_dataPointTemp.devSta
             -tus_Reference.statusRef_devLock);
2242   9                                                                              PrintString1_logOut(log_buf);
2243   9                                                                      }                       
2244   8      #endif  
2245   8                                                                      
2246   8                                                                      if(dev_dataPointTemp.devStatus_Reference.statusRef_devLock){ //Êý¾Ý·ÅÔÚ×´Ì¬Àï
2247   9                                                                      
2248   9                                                                              deviceLock_flag = deviceLock_IF = 1; //ÔËÐÐ»º´æ¸üÐÂ
2249   9                                                                              
2250   9                                                                      }else{
2251   9                                                                      
2252   9                                                                              deviceLock_flag = deviceLock_IF = 0; //ÔËÐÐ»º´æ¸üÐÂ
2253   9                                                                      }
2254   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_deviceLockFLAG, &deviceLock_IF, 1); //Ö±½Ó¸üÐÂeepromÊý¾Ý
2255   8                                                              }
2256   7                                                              
2257   7                                                              if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_timerSetOpreat){ //¶¨Ê±Æ÷ÉèÖÃ²Ù×÷£¬ÐèÒª
             -Ê±Ð§
2258   8                                                                      
2259   8                                                                      u8 loop = 0;
2260   8      #if(DEBUG_LOGOUT_EN == 1)
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 39  

2261   8                                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2262   9                                                                              
2263   9                                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2264   9                                                                              sprintf(log_buf, ">>>>>>>>agingCmd timer coming, dataTab3:[%02X-%02X-%02X].\n", (int)dev_dataPoin
             -tTemp.devData_timer[6],
2265   9                                                                                                                                                                                                                                              (int)dev_dataPointTemp.devData_timer[7],
2266   9                                                                                                                                                                                                                                              (int)dev_dataPointTemp.devData_timer[8]);
2267   9                                                                              PrintString1_logOut(log_buf);
2268   9                                                                      }                       
2269   8      #endif  
2270   8                                                                      for(loop = 0; loop < TIMEER_TABLENGTH; loop ++){ //ÔËÐÐ»º´æ¸üÐÂ
2271   9                                                                      
2272   9                                                                              if(dev_dataPointTemp.devData_timer[loop * 3] == 0x80){  /*Ò»´ÎÐÔ¶¨Ê±ÅÐ¶Ï*///ÖÜÕ¼Î»Îª¿Õ£¬¶ø¶¨Ê±Æ÷±»
             -´ò¿ª£¬ËµÃ÷ÊÇÒ»´ÎÐÔ
2273  10                                                                              
2274  10                                                                                      swTim_onShoot_FLAG      |= (1 << loop); //Ò»´ÎÐÔ¶¨Ê±±êÖ¾¿ªÆô
2275  10                                                                                      dev_dataPointTemp.devData_timer[loop * 3] |= (1 << (systemTime_current.time_Week - 1)); //Ç¿ÐÐ½ø
             -ÐÐµ±Ç°ÖÜÕ¼Î»£¬µ±´ÎÖ´ÐÐÍê±ÏºóÇå³ý
2276  10                                                                              }
2277   9                                                                      }
2278   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_swTimeTab, dev_dataPointTemp.devData_timer, sizeof(timing_Dats) * 
             -TIMEER_TABLENGTH); //Ö±½Ó¸üÐÂeepromÊý¾Ý
2279   8                                                              }
2280   7                                                              
2281   7                                                              if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_greenModeSetOpreat){ //ÂÌÉ«Ä£Ê½ÉèÖÃ²Ù×÷
             -£¬ÐèÒªÊ±Ð§
2282   8                                                                      
2283   8      #if(DEBUG_LOGOUT_EN == 1)
2284   8                                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2285   9                                                                              
2286   9                                                                              
2287   9                                                                              sprintf(log_buf, ">>>>>>>>agingCmd greenMode coming.\n");
2288   9                                                                              PrintString1_logOut(log_buf);
2289   9                                                                      }                       
2290   8      #endif  
2291   8                                                              
2292   8                                                                      (dev_dataPointTemp.devData_greenMode)?(ifDelay_sw_running_FLAG |= (1 << 0)):(ifDelay_sw_running_FL
             -AG &= ~(1 << 0)); //¸üÐÂÔËÐÐ»º´æ
2293   8                                                                      delayPeriod_closeLoop = dev_dataPointTemp.devData_greenMode;
2294   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_swDelayFLAG, &ifDelay_sw_running_FLAG, 1); //Ö±½Ó¸üÐÂeepromÊý¾Ý
2295   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_periodCloseLoop, &delayPeriod_closeLoop, 1);
2296   8                                                              }
2297   7                                                              
2298   7                                                              if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_nightModeSetOpreat){ //Ò¹¼äÄ£Ê½ÉèÖÃ²Ù×÷
             -£¬ÐèÒªÊ±Ð§
2299   8                                                                      
2300   8                                                                      u8 dataTemp[6] = {0};
2301   8      #if(DEBUG_LOGOUT_EN == 1)
2302   8                                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2303   9                                                                              
2304   9                                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2305   9                                                                              sprintf(log_buf, ">>>>>>>>agingCmd nightMode coming.\n");
2306   9                                                                              PrintString1_logOut(log_buf);
2307   9                                                                      }                       
2308   8      #endif  
2309   8                                                                      (dev_dataPointTemp.devData_nightMode[0])?(dataTemp[0] |= 0x7f):(dataTemp[0] &= ~0x7f);
2310   8                                                                      (dev_dataPointTemp.devData_nightMode[1])?(dataTemp[0] |= 0x80):(dataTemp[0] &= ~0x80);
2311   8                                                                      dataTemp[1] = dev_dataPointTemp.devData_nightMode[2] << 3; //×Ö½ÚÏÂ±ê2 ¸ß5Î» Ê±
2312   8                                                                      dataTemp[2] = dev_dataPointTemp.devData_nightMode[3];      //×Ö½ÚÏÂ±ê3 È«8Î» ·Ö
2313   8                                                                      dataTemp[4] = dev_dataPointTemp.devData_nightMode[4] << 3; //×Ö½ÚÏÂ±ê4 ¸ß5Î» Ê±
2314   8                                                                      dataTemp[5] = dev_dataPointTemp.devData_nightMode[5];      //×Ö½ÚÏÂ±ê5 È«8Î» ·Ö
2315   8                                                                      
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 40  

2316   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_TimeTabNightMode, dataTemp, sizeof(timing_Dats) * 2); //Ö±½Ó¸üÐÂee
             -promÊý¾Ý
2317   8                                                              }
2318   7                                                              
2319   7                                                              if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_bkLightSetOpreat){ //±³¹âµÆÉèÖÃ²Ù×÷£¬Ðè
             -ÒªÊ±Ð§
2320   8                                                                      
2321   8      #if(DEBUG_LOGOUT_EN == 1)
2322   8                                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2323   9                                                                              
2324   9                                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2325   9                                                                              sprintf(log_buf, ">>>>>>>>agingCmd bkLight coming.\n");
2326   9                                                                              PrintString1_logOut(log_buf);
2327   9                                                                      }                       
2328   8      #endif  
2329   8                                                              
2330   8                                                                      tipsInsert_swLedBKG_ON  = dev_dataPointTemp.devData_bkLight[0]; //¸üÐÂÔËÐÐ»º´æ
2331   8                                                                      tipsInsert_swLedBKG_OFF = dev_dataPointTemp.devData_bkLight[1]; //Ö±½Ó¸üÐÂeepromÊý¾Ý
2332   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_ledSWBackGround, dev_dataPointTemp.devData_bkLight, 2);
2333   8                                                              }
2334   7                                                              
2335   7                                                              if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_horsingLight){ //ÅÜÂíµÆÉèÖÃ²Ù×÷£¬ÐèÒªÊ±
             -Ð§
2336   8                                                              
2337   8                                                                      
2338   8                                                              }
2339   7                                                              
2340   7      //                                                      if(dev_dataPointTemp.devAgingOpreat_agingReference.agingCmd_swOpreat){ //¿ª¹Ø×´Ì¬²Ù×÷£¬²»ÐèÒªÊ±Ð§
             -µÄ²Ù×÷£¬ÊµÊ±¸üÐÂÊý¾Ý¼´¿É
2341   7      //                                                      
2342   7      //
2343   7      //                                                      }
2344   7                                                      
2345   7                                                      }else{
2346   7                                                      
2347   7                                                              memset(&dev_agingCmd_rcvPassive, 0, sizeof(stt_agingDataSet_bitHold)); //±¾µØ±»¶¯Ê±Ð§²Ù×÷»º´æÇåÁã
2348   7                                                              
2349   7                                                              if(local_ftyRecover_standbyFLG){ //µ±Ê±Ð§±êÖ¾ÖÃÁãºó²ÅÖ´ÐÐ»Ö¸´³ö³§¶¯×÷£¬·ñÔòÉÏÎ»»ú»áÒ»Ö±ÍùÏÂ·¢¸´Î»
2350   8                                                                      
2351   8      #if(DEBUG_LOGOUT_EN == 1)
2352   8                                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2353   9                                                                              
2354   9                                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2355   9                                                                              sprintf(log_buf, ">>>>>>>>factory recover doing now!.\n");
2356   9                                                                              PrintString1_logOut(log_buf);
2357   9                                                                      }                       
2358   8      #endif  
2359   8                                                                      local_ftyRecover_standbyFLG = 0;
2360   8                                                                      Factory_recover();
2361   8                                                              }
2362   7                                                      }
2363   6                                                      
2364   6                                              }break;
2365   5                                                      
2366   5                                              case DTMODEKEEPACESS_FRAMECMD_PST:{
2367   6                                                      
2368   6                                                      heartBeatPeriod = PERIOD_HEARTBEAT_ASR; //ÇÐ»»Îª±»¶¯Ñ¯·Ã£¬ÐÄÌøÖÜÆÚ¸ÄÎª±»¶¯
2369   6                                                      
2370   6                                                      if(memcmp(&dev_agingCmd_sndInitative, &dev_dataPointTemp.devAgingOpreat_agingReference, sizeof(stt_a
             -gingDataSet_bitHold))){ //±¾µØÖ÷¶¯Ê±Ð§²Ù×÷»º´æÍ¬²½¸üÐÂ£¬Ê±Ð§Õ¼Î»Óë±¾µØ²»Ò»ÖÂ Ñ¯·ÃÃüÁî¾ÍÒ»Ö±ÎªÖ÷¶¯
2371   7                                                      
2372   7                                                              dtModeKeepAcess_currentCmd = DTMODEKEEPACESS_FRAMECMD_PST;
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 41  

2373   7                                                              
2374   7                                                      }else{
2375   7                                                      
2376   7                                                              memset(&dev_agingCmd_sndInitative, 0, sizeof(stt_agingDataSet_bitHold)); //±¾µØÖ÷¶¯Ê±Ð§²Ù×÷»º´æÇåÁã
2377   7                                                              dtModeKeepAcess_currentCmd = DTMODEKEEPACESS_FRAMECMD_ASR;
2378   7                                                      }
2379   6                                                      
2380   6                                              }break;
2381   5                                                      
2382   5                                              default:{}break;
2383   5                                      }
2384   4                              }
2385   3                              
2386   3                      }break;
2387   2                      
2388   2                      /*¶¨Ê±Ñ¯·Ã_Íø¹ØÀëÏß*///internetÀëÏß£¬²»ÊÇzigbÍøÂçÀëÏß
2389   2                      case DTMODEKEEPACESS_FRAMEHEAD_OFFLINE:{
2390   3                              
2391   3                              periodDataTrans_momentHang(6); //internetÀëÏßÇé¿öÏÂ£¬ÖÜÆÚÍ¨Ñ¶¾ÍÃ»ÓÃÁË£¬Í¨ÐÅÆµ´ÎÏÂ½µµ½ 6s/´Î
2392   3      #if(DEBUG_LOGOUT_EN == 1)
2393   3                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2394   4                                      
2395   4                                      memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2396   4                                      sprintf(log_buf, ">>>>>>>>internet offline.\n");
2397   4                                      PrintString1_logOut(log_buf);
2398   4                              }       
2399   3      #endif
2400   3                      }break;
2401   2                      
2402   2      #endif /*ºêÅÐÎ²*///¶¨Ê±ÀàÍ¨Ñ¶Ä£Ê½ÅÐ¶Ï
2403   2                      
2404   2                      default:{}break;
2405   2              }
2406   1      }
2407          
2408          /*zigbeeÖ÷Ïß³Ì*///¶¯×÷×èÈû´óÓÚ200msµÄº¯Êý¶¼ÉèÎª×´Ì¬»úÔËÐÐ£¬ÆäËüÐ¡ÓÚ200msº¯Êý£¬×èÈûÎ¬³Ö£¬·ñÔò×´Ì¬»ú¸´ÔÓ¶È¼Ó
             -´ó
2409          void thread_dataTrans(void){
2410   1              
2411   1              u8 code cmd_datsComing[2] = {0x44, 0x81}; //Ô¶¶ËÊý¾ÝÖ¡Ö¸Áî
2412   1      
2413   1      #define dataLen_zigbDatsTrans 96
2414   1              u8 xdata paramTX_temp[dataLen_zigbDatsTrans] = {0};
2415   1              u8 xdata paramRX_temp[dataLen_zigbDatsTrans] = {0};
2416   1              
2417   1              static bit heartBeat_cmdFLG = 0; //ÐÄÌøÆæÅ¼±êÖ¾
2418   1              
2419   1              /*zigbÖ÷Ïß³ÌÏµÍ³Ê±¼ä¸üÐÂ*/
2420   1              if(!sysTimeReales_counter){ 
2421   2              
2422   2                      sysTimeReales_counter = PERIOD_SYSTIMEREALES;
2423   2                      getSystemTime_reales();
2424   2              }
2425   1              
2426   1              /*zigbÖ÷Ïß³Ì×´Ì¬»ú£º¸ù¾Ý×´Ì¬±êÖ¾ÔËÐÐ*/
2427   1              switch(devRunning_Status){
2428   2              
2429   2                      case status_passiveDataRcv:{
2430   3                              
2431   3                              if(devStatus_switch.statusChange_IF){ //×´Ì¬Ç¿ÖÆÇÐ»»Ê±£¬½«µ±Ç°×Ó×´Ì¬ÄÚ¾²Ì¬±äÁ¿³õÊ¼»¯ºóÔÙ½øÐÐÍâ²¿ÇÐ»»
2432   4                              
2433   4                                      devStatus_switch.statusChange_IF = 0;
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 42  

2434   4                                      devRunning_Status = devStatus_switch.statusChange_standBy;
2435   4                                      
2436   4                                      break;
2437   4                              }
2438   3                              
2439   3                              {/*³õÊ¼»¯Ê±¼ä¸³Öµ*///½ö¿ª»ú¸³ÖµÒ»´Î£¬²»×öÊ±Çøµ÷Õû
2440   4                                      static bit FLG_timeSetInit = 1;
2441   4                                      
2442   4                                      if(FLG_timeSetInit){
2443   5                                      
2444   5                                              FLG_timeSetInit = 0;
2445   5                                              zigB_sysTimeSet(1533810700UL - 946713600UL, 0); //zigbeeÊ±¼ä´Á´Óunix¼ÍÔª946713600<2000/01/01 00:00:00
             ->¿ªÊ¼¼ÆËã
2446   5                                      }
2447   4                              }
2448   3                              
2449   3                              if(devTips_status == status_tipsNwkFind)tips_statusChangeToNormal(); //tips¸´Ô­(ÍøÂçÒÑ¼ÓÈë£¬»Ö¸´Õý³£tip
             -s)
2450   3              
2451   3                              //--------------------------------Ö÷×´Ì¬£ºÐÄÌø--------------------------------------------------------/
             -/
2452   3                              if(heartBeatCycle_FLG && !heartBeatHang_timeCnt){ //ÐÄÌø´¥·¢±êÖ¾ ¼° ¹ÒÆðÊ±¼ä ÅÐ¶Ï
2453   4                                      
2454   4                                      u8 xdata frame_dataLen = 0; //´ý·¢ËÍÊý¾ÝÖ¡³¤¶È
2455   4                              
2456   4                                      heartBeatCycle_FLG = 0;
2457   4                                      heartBeat_cmdFLG = !heartBeat_cmdFLG;
2458   4                                      
2459   4                                      memset(paramTX_temp, 0, sizeof(u8) * dataLen_zigbDatsTrans); //Çå»º´æ
2460   4                                      
2461   4      #if(ZIGB_DATATRANS_WORKMODE == DATATRANS_WORKMODE_HEARTBEAT) //Ô­¼´Ê±Í¨Ñ¶»úÖÆÐÄÌø
                                              
                                              frame_dataLen = 14;
                                              paramTX_temp[0] = ZIGB_FRAMEHEAD_HEARTBEAT;
                                              paramTX_temp[1] = frame_dataLen ;
                                              (heartBeat_cmdFLG)?(paramTX_temp[2] = FRAME_HEARTBEAT_cmdOdd):(paramTX_temp[2] = FRAME_HEARTBEAT_cmdEv
             -en);
                                              memcpy(&paramTX_temp[4], &MAC_ID[1], 5);
                                              
                                              if(heartBeat_cmdFLG){ //Ææ°ü
                                              
                                                      
                                              
                                              }else{ //Å¼°ü
                                              
                                                      
                                              }
              #elif(ZIGB_DATATRANS_WORKMODE == DATATRANS_WORKMODE_KEEPACESS)  //ÐÂÖÜÆÚÑ¯·Ã»úÖÆÑ¯·ÃÖÜÆÚ
2478   4                                      
2479   4                                      //×´Ì¬Ìî×°-ÊµÊ±Öµ
2480   4                                      dev_currentDataPoint.devStatus_Reference.statusRef_swStatus     = status_Relay; //ÖÜÆÚÑ¯·Ã±¾µØÊý¾Ýµã ¿ª¹Ø
             -×´Ì¬¸üÐÂ
2481   4                                      dev_currentDataPoint.devStatus_Reference.statusRef_timer                = ifTim_sw_running_FLAG; //ÖÜÆÚÑ¯·Ã±¾µØÊý¾Ý
             -µã ¶¨Ê±Æ÷×´Ì¬¸üÐÂ
2482   4                                      dev_currentDataPoint.devStatus_Reference.statusRef_devLock              = deviceLock_flag;
2483   4                                      dev_currentDataPoint.devStatus_Reference.statusRef_delay                = (ifDelay_sw_running_FLAG & 0x02) >> 1;
2484   4                                      dev_currentDataPoint.devStatus_Reference.statusRef_greenMode    = (ifDelay_sw_running_FLAG & 0x01) >> 0;
2485   4                                      dev_currentDataPoint.devStatus_Reference.statusRef_nightMode    = ifNightMode_sw_running_FLAG;
2486   4                                      dev_currentDataPoint.devStatus_Reference.statusRef_horsingLight = 0;
2487   4                                      
2488   4                                      //ÊôÐÔÖµÌî×°-ÊµÊ±Öµ
2489   4                                      EEPROM_read_n(EEPROM_ADDR_swTimeTab, &dev_currentDataPoint.devData_timer, 24);
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 43  

2490   4                                      dev_currentDataPoint.devData_delayer            = delayPeriod_onoff - (delayCnt_onoff / 60);
2491   4                                      dev_currentDataPoint.devData_delayUpStatus      = delayUp_act;
2492   4                                      dev_currentDataPoint.devData_greenMode          = delayPeriod_closeLoop;
2493   4                                      { //Ò¹¼äÄ£Ê½Êý¾ÝÌØÊâ×ª»»
2494   5                                              
2495   5                                              timing_Dats xdata nightDatsTemp_CalibrateTab[2] = {0};
2496   5                                              
2497   5                                              datsTimNight_read_eeprom(nightDatsTemp_CalibrateTab);
2498   5                                              ((nightDatsTemp_CalibrateTab[0].Week_Num & 0x7F) == 0x7F)?(dev_currentDataPoint.devData_nightMode[0] 
             -= 1):(dev_currentDataPoint.devData_nightMode[0] = 0);
2499   5                                              (nightDatsTemp_CalibrateTab[0].if_Timing)?(dev_currentDataPoint.devData_nightMode[1] = 1):(dev_curren
             -tDataPoint.devData_nightMode[1] = 0);
2500   5                                              dev_currentDataPoint.devData_nightMode[2] = nightDatsTemp_CalibrateTab[0].Hour;
2501   5                                              dev_currentDataPoint.devData_nightMode[3] = nightDatsTemp_CalibrateTab[0].Minute;
2502   5                                              dev_currentDataPoint.devData_nightMode[4] = nightDatsTemp_CalibrateTab[1].Hour;
2503   5                                              dev_currentDataPoint.devData_nightMode[5] = nightDatsTemp_CalibrateTab[1].Minute;
2504   5                                      }
2505   4                                      EEPROM_read_n(EEPROM_ADDR_ledSWBackGround, &dev_currentDataPoint.devData_bkLight, 2);
2506   4                                      dev_currentDataPoint.devData_devReset = 0;
2507   4                                      
2508   4                                      //Ê±Ð§²Ù×÷Õ¼Î»Ö¸ÁîÌî×°
2509   4                                      switch(dtModeKeepAcess_currentCmd){
2510   5                                      
2511   5                                              case DTMODEKEEPACESS_FRAMECMD_ASR:{
2512   6                                              
2513   6                                                      memcpy(&dev_currentDataPoint.devAgingOpreat_agingReference, &dev_agingCmd_rcvPassive, sizeof(stt_agi
             -ngDataSet_bitHold));
2514   6                                              
2515   6                                              }break;
2516   5                                                      
2517   5                                              case DTMODEKEEPACESS_FRAMECMD_PST:{
2518   6                                              
2519   6                                                      memcpy(&dev_currentDataPoint.devAgingOpreat_agingReference, &dev_agingCmd_sndInitative, sizeof(stt_a
             -gingDataSet_bitHold));
2520   6                                              
2521   6                                              }break;
2522   5                                                      
2523   5                                              default:{}break;
2524   5                                      }
2525   4                                      
2526   4                                      //Êý¾ÝÖ¡×ÜÊý¾ÝÌî×°
2527   4                                      frame_dataLen                                   = 0;
2528   4                                      paramTX_temp[frame_dataLen ++]  = DTMODEKEEPACESS_FRAMEHEAD_ONLINE; //Ö¡Í·
2529   4                                      paramTX_temp[frame_dataLen ++]  = 0;  //Ö¡³¤ÔÝÌî0£¬×îºó¸üÐÂ
2530   4                                      memcpy(&paramTX_temp[frame_dataLen], &MAC_ID[1], 5); //MAC
2531   4                                      frame_dataLen += 6; //¿Õ³ö1Byte MAC
2532   4                                      paramTX_temp[frame_dataLen ++]  = dtModeKeepAcess_currentCmd; //ÃüÁî
2533   4                                      paramTX_temp[frame_dataLen ++]  = SWITCH_TYPE; //¿ª¹ØÐÅÏ¢
2534   4                                      paramTX_temp[frame_dataLen ++]  = 0; //devVersion_reserve
2535   4                                      paramTX_temp[frame_dataLen ++]  = 0; //devVersion_reserve
2536   4                                      paramTX_temp[frame_dataLen ++]  = 0; //devVersion_reserve
2537   4                                      paramTX_temp[frame_dataLen ++]  = sysTimeZone_H; //Ê±Çø_Ê±
2538   4                                      paramTX_temp[frame_dataLen ++]  = sysTimeZone_M; //Ê±Çø_·Ö
2539   4                                      memcpy(&paramTX_temp[frame_dataLen], &dev_currentDataPoint, sizeof(stt_devOpreatDataPonit)); //Ö±½ÓÊý¾
             -ÝÖ¸Õë¶ÔÆë,Êý¾ÝµãÏòÊý¾ÝÖ¡´ý·¢»º´æÇ¿í¡
2540   4                                      frame_dataLen += sizeof(stt_devOpreatDataPonit);
2541   4                                      frame_dataLen ++;
2542   4                                      paramTX_temp[1]                                 = frame_dataLen;
2543   4                                      paramTX_temp[frame_dataLen - 1] = frame_Check(&paramTX_temp[1], frame_dataLen - 2); //Ð£ÑéÂë×îºóËã
2544   4                                      
2545   4      //#if(DEBUG_LOGOUT_EN == 1)
2546   4      //                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 44  

2547   4      //                                      u8 xdata log_buf[64];
2548   4      //                                      
2549   4      //                                      sprintf(log_buf, "package_num:[%02d], check_num[%02X].\n", (int)frame_dataLen, (int)paramTX_temp[fr
             -ame_dataLen - 1]);
2550   4      //                                      PrintString1_logOut(log_buf);
2551   4      //                              }                       
2552   4      //#endif        
2553   4                              
2554   4      #endif                          
2555   4                                      datsSend_request.nwkAddr = 0; //½ö¶ÔÍø¹Ø·¢ËÍ£¬½øÐÐÊý¾Ý×ª·¢
2556   4                                      datsSend_request.portPoint = ZIGB_ENDPOINT_CTRLNORMAL; //³£¹æÊý¾Ý×ª·¢×¨ÓÃ¶Ë¿Ú
2557   4                                      memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
2558   4                                      memcpy(datsSend_request.datsTrans.dats, paramTX_temp, frame_dataLen );
2559   4                                      datsSend_request.datsTrans.datsLen = frame_dataLen ;
2560   4                                      datsRcv_respond.datsTrans.datsLen = 0;
2561   4                                      devRemoteDataReqMethod.keepTxUntilCmp_IF = 1; //ËÀ¿Ä
2562   4                                      devRemoteDataReqMethod.datsTxKeep_Period = REMOTE_DATAREQ_TIMEOUT / 4; //ËÀ¿ÄÖÜÆÚ£¬³ý´Î±È µ¥¸ö³¬Ê±ÖÜÆÚ
             -ÄÚ ·¢ 4´Î
2563   4                                      devRunning_Status = status_dataTransRequestDatsSend;
2564   4                                      
2565   4                                      return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£³Ö£¬
             -µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
2566   4                              }
2567   3                              
2568   3                              //------------------------------Ö÷×´Ì¬£º±¾µØ¿ª¹ØÊÜ¼¯Èº¿ØÖÆ×´Ì¬Î»ÖÜÆÚÐÔÂÖÑ¯<°üÀ¨ÓÐ»¥¿ØºÍ³¡¾°>---------//
2569   3      #if(COLONYINFO_QUERYPERIOD_EN == ENABLE) /*ºêÅÐÍ·*///¼¯Èº¿ØÖÆÐÅÏ¢ÖÜÆÚ²éÑ¯Ê¹ÄÜ
                                      if(!colonyCtrlGet_queryCounter && !colonyCtrlGetHang_timeCnt){ //ÖÜÆÚÑ¯²é ¼° ¹ÒÆðÊ±¼äÅÐ¶Ï
                                      
                                              colonyCtrlGet_queryCounter = COLONYCTRLGET_QUERYPERIOD;
                                              
                                              /*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>frame reference<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
             -<<<<<<<<<<<<<<<<<<<<<<*/
                                              /*----------------------------------------------------------------------------------------------------
             -----------------------*/
                                              /*      frame_data[0]           |       frame_data[1]           |       frame_data[2...6]       |       frame_data[7]                   |       frame_data[8...10]      |
                                              /*----------------------------------------------------------------------------------------------------
             -----------------------*/
                                              /*      ÃüÁî                            |       Êý¾Ý³¤¶È                        |       ±¾»úMACµØÖ·                     |       ³¡¾°ËµÃ÷(ÔÝÎÞËµÃ÷)              |       »¥¿ØËµÃ÷(µ±Ç°×éºÅ)      |               
                                              /*----------------------------------------------------------------------------------------------------
             -----------------------*/
                                              memset(paramTX_temp, 0, sizeof(u8) * dataLen_zigbDatsTrans); //Çå»º´æ
                                              paramTX_temp[0] = ZIGB_SYSCMD_COLONYPARAM_REQPERIOD; //ÃüÁî
                                              paramTX_temp[1] = clusterNum_usr + 5 + 1; //Êý¾Ý³¤¶ÈËµÃ÷
                                              memcpy(&paramTX_temp[2], &MAC_ID[1], 5); //MACµØÖ·Ìî×°
                                              paramTX_temp[7] = 0; //³¡¾°ËµÃ÷×°ÔØ(ÎÞËµÃ÷£¬0Ìî³ä)
                                              memcpy(&paramTX_temp[8], CTRLEATHER_PORT, clusterNum_usr); //»¥¿ØËµÃ÷×°ÔØ(ËµÃ÷¶Ë¿ÚºÅ)
                                              
                                              datsSend_request.nwkAddr = 0; //½ö¶ÔÍø¹Ø·¢ËÍ
                                              datsSend_request.portPoint = ZIGB_ENDPOINT_CTRLSYSZIGB; //zigbÏµÍ³½»»¥×¨ÓÃ¶Ë¿Ú
                                              memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
                                              memcpy(datsSend_request.datsTrans.dats, paramTX_temp, paramTX_temp[1] + 2); 
                                              datsSend_request.datsTrans.datsLen = paramTX_temp[1] + 2;
                                              datsRcv_respond.datsTrans.datsLen = 0; //²»ÐèÒªÔ¶¶ËÓ¦´ð
                                              devRunning_Status = status_dataTransRequestDatsSend;
                                              
                                              return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£³Ö£¬
             -µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
                                      }
              #endif /*ºêÅÐÎ²*///¼¯Èº¿ØÖÆÐÅÏ¢ÖÜÆÚ²éÑ¯Ê¹ÄÜ
2598   3                              
2599   3                              //--------------------------------Ö÷×´Ì¬£ºÊý¾ÝÍÆËÍ---------------------------------------------------//
             -        
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 45  

2600   3                              if(devActionPush_IF.push_IF){
2601   4                                      
2602   4                                      const bit dataFromRemote_IF = 1; //Ô¶³ÌÍÆËÍ
2603   4                                      const bit specialCmd_IF = 0; //·ÇÌØÊâÕ¼Î»
2604   4                                      
2605   4                                      u8 xdata datsTX_Len = 0;
2606   4                                      
2607   4                                      devActionPush_IF.push_IF = 0;
2608   4                                      
2609   4      #if(ZIGB_DATATRANS_WORKMODE == DATATRANS_WORKMODE_HEARTBEAT) //Ô­¼´Ê±Í¨Ñ¶»úÖÆÐÄÌø
                                              
                                              memset(paramTX_temp, 0, sizeof(u8) * dataLen_zigbDatsTrans); //Çå»º´æ
                                              
                                              paramTX_temp[11] = devActionPush_IF.dats_Push; //ÍÆËÍÐÅÏ¢Ìî×°
              
              #if(DEBUG_LOGOUT_EN == 1)
                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
                                                      u8 xdata log_buf[64];
                                                      
                                                      sprintf(log_buf, "swData push:%02X.\n", (int)devActionPush_IF.dats_Push);
                                                      PrintString1_logOut(log_buf);
                                              }                       
              #endif  
                                              datsTX_Len = dtasTX_loadBasic_CUST(dataFromRemote_IF,
                                                                                                                 paramTX_temp,
                                                                                                                 33,
                                                                                                                 FRAME_TYPE_StoM_RCVsuccess,
                                                                                                                 FRAME_MtoZIGBCMD_cmdControl,
                                                                                                                 specialCmd_IF);
                                      
                                              datsSend_request.nwkAddr = 0; //½ö¶ÔÍø¹Ø·¢ËÍ£¬½øÐÐÊý¾Ý×ª·¢
                                              datsSend_request.portPoint = ZIGB_ENDPOINT_CTRLNORMAL; //³£¹æÊý¾Ý×ª·¢×¨ÓÃ¶Ë¿Ú
                                              memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
                                              memcpy(datsSend_request.datsTrans.dats, paramTX_temp, datsTX_Len);
                                              datsSend_request.datsTrans.datsLen = datsTX_Len;
                                              datsRcv_respond.datsTrans.datsLen = 0; //ÎÞÐèÔ¶¶ËÓ¦´ð
                                              devRunning_Status = status_dataTransRequestDatsSend; //Ö±½ÓÇÐ»»£¨²»×öÔ¤±¸¶¯×÷£©
                                              
              #elif(ZIGB_DATATRANS_WORKMODE == DATATRANS_WORKMODE_KEEPACESS) //ÖÜÆÚÑ¯·Ã»úÖÆÎÞÐèÍÆËÍ£¬Ö»Ðè´¥·¢Ö÷¶¯Ê±Ð§ÃüÁ
             -î¼´¿É
2639   4                                      
2640   4                                      dev_currentDataPoint.devStatus_Reference.statusRef_swPush = (devActionPush_IF.dats_Push & 0xE0) >> 5; 
             -//ÊôÐÔÖµÌî×°
2641   4                                      dev_agingCmd_sndInitative.agingCmd_swOpreat = 1; //¶ÔÓ¦Ö÷¶¯ÉÏ´«Ê±Ð§Õ¼Î»ÖÃÒ»
2642   4                                      dtModeKeepAcess_currentCmd = DTMODEKEEPACESS_FRAMECMD_PST;
2643   4                                      
2644   4                                      heartBeatPeriod = PERIOD_HEARTBEAT_PST; //Ö÷¶¯Ñ¯·ÃÇÐ»»£¬ÐÄÌøÖÜÆÚ¸ÄÎªÖ÷¶¯
2645   4                                      heartBeatCount  = heartBeatPeriod; 
2646   4      #endif
2647   4      
2648   4                                      return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£³Ö£¬
             -µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
2649   4                              }
2650   3                              
2651   3                              //--------------------------------Ö÷×´Ì¬£º»¥¿ØÍ¬²½---------------------------------------------------//
2652   3                              if(EACHCTRL_realesFLG){ //¹ã²¥»¥¿ØÖµ
2653   4                              
2654   4                                      if(devRunning_Status == status_passiveDataRcv){
2655   5                                      
2656   5                                              u8 idata loop;
2657   5                                              
2658   5                                              for(loop = 0; loop < clusterNum_usr; loop ++){ //Èý¸ö¿ª¹ØÎ»·Ö±ðÅÐ¶¨
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 46  

2659   6                                              
2660   6                                                      if(EACHCTRL_realesFLG & (1 << loop)){ //»¥¿ØÓÐÐ§Î»ÅÐ¶Ï
2661   7                                                      
2662   7                                                              EACHCTRL_realesFLG &= ~(1 << loop); //»¥¿ØÓÐÐ§Î»ÇåÁã
2663   7                                                              
2664   7                                                              paramTX_temp[0] = (status_Relay >> loop) & 0x01; //¿ª¹Ø×´Ì¬Ìî×°
2665   7                                                              
2666   7                                                              if((CTRLEATHER_PORT[loop] > CTRLEATHER_PORT_NUMSTART) && CTRLEATHER_PORT[loop] < CTRLEATHER_PORT_NU
             -MTAIL){ //ÊÇ·ñÎªÓÐÐ§»¥¿Ø¶Ë¿Ú
2667   8                                                                      
2668   8                                                                      (paramTX_temp[0])?(colonyCtrlGet_statusLocalEaCtrl[loop] = STATUSLOCALEACTRL_VALMASKRESERVE_ON):(c
             -olonyCtrlGet_statusLocalEaCtrl[loop] = STATUSLOCALEACTRL_VALMASKRESERVE_OFF); //±¾µØ»¥¿Ø×´Ì¬¸üÐÂ
2669   8                                                                      colonyCtrlGet_queryCounter = COLONYCTRLGET_QUERYPERIOD; //¼¯ÈºÐÅÏ¢²éÑ¯Ö÷¶¯ÖÍºó£¬ÒÔ·ÀÓëÖ÷»ú¼¯ÈºÐÅÏ¢
             -Î´¸üÐÂ£¬µ¼ÖÂÓë±¾µØÐÅÏ¢³åÍ»
2670   8                                                              
2671   8                                                                      datsSend_request.nwkAddr = 0xffff; //¼ä½Ó×é²¥£¨¶Ô»¥¿Ø×¨ÓÃ¶Ë¿Ú½øÐÐ¹ã²¥£©
2672   8                                                                      datsSend_request.portPoint = CTRLEATHER_PORT[loop]; //»¥¿ØÎ»¶ÔÓ¦°ó¶¨¶Ë¿Ú
2673   8                                                                      memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
2674   8                                                                      memcpy(datsSend_request.datsTrans.dats, paramTX_temp, 1);
2675   8                                                                      datsSend_request.datsTrans.datsLen = 1;
2676   8                                                                      datsRcv_respond.datsTrans.datsLen = 0; //ÎÞÐèÔ¶¶ËÓ¦´ð
2677   8                                                                      
2678   8                                                                      devRemoteDataReqMethod.keepTxUntilCmp_IF = 1; //ËÀ¿Ä
2679   8                                                                      devRemoteDataReqMethod.datsTxKeep_Period = REMOTE_DATAREQ_TIMEOUT / 8; //ËÀ¿ÄÖÜÆÚ£¬³ý´Î±È µ¥¸ö³¬Ê±
             -ÖÜÆÚÄÚ ·¢ 8´Î
2680   8                                                                      
2681   8                                                                      EACHCTRL_reportFLG = 1; //ÏòÍø¹Ø»ã±¨
2682   8                                                                      
2683   8                                                                      devRunning_Status = status_dataTransRequestDatsSend; //Ö±½ÓÇÐ»»£¨²»×öÔ¤±¸¶¯×÷£©
2684   8                                                                      
2685   8                                                                      return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£
             -³Ö£¬µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
2686   8                                                              }
2687   7                                                      }
2688   6                                              }
2689   5                                      }       
2690   4                              }
2691   3      
2692   3      #if(COLONYINFO_QUERYPERIOD_EN == ENABLE) /*ºêÅÐÍ·*///¼¯Èº¿ØÖÆÐÅÏ¢ÖÜÆÚ²éÑ¯Ê¹ÄÜ   
                                      if(EACHCTRL_reportFLG){ //ÏòÍø¹Øµ¥²¥µ±Ç°ËùÓÐ»¥¿Ø×éºÅ¶ÔÓ¦µÄ¿ª¹Ø×´Ì¬Öµ
                                      
                                              EACHCTRL_reportFLG = 0;
                                              
                                              /*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>frame reference<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
             -<<<<<<*/
                                              /*----------------------------------------------------------------------------------------------------
             -------*/
                                              /*      frame_data[0]           |       frame_data[1]           |       frame_data[2/4/6]       |               frame_data[3/5/7]                       |
                                              /*----------------------------------------------------------------------------------------------------
             -------*/
                                              /*      ÃüÁî                            |       Êý¾Ý³¤¶È                        |       ±¾µØ»¥¿Ø¶Ë¿ÚºÅ          |       ±¾µØ»¥¿Ø¶Ë¿ÚºÅ¶ÔÓ¦¿ª¹Ø×´Ì¬Öµ    |
                                              /*----------------------------------------------------------------------------------------------------
             -------*/
                                              {
                                                      u8 code remote_responseFrame[3] = {ZIGB_SYSCMD_EACHCTRL_REPORT, 0x01, 0x00}; //Ô¶¶ËÏìÓ¦Ö¡<È·±£Ö÷»úÊÕµ
             -½>
                                                      
              #if(DEBUG_LOGOUT_EN == 1)
                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
                                                              u8 xdata log_buf[64];
                                                              
                                                              sprintf(log_buf, "current eaCtrl insrt[2] is: %02X.\n", (int)colonyCtrlGet_statusLocalEaCtrl[1]);
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 47  

                                                              PrintString1_logOut(log_buf);
                                                      }                       
              #endif  
                                                      
                                                      memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
                                                      datsSend_request.datsTrans.dats[0]      = ZIGB_SYSCMD_EACHCTRL_REPORT;
                                                      datsSend_request.datsTrans.dats[1]      = 6;
                                                      datsSend_request.datsTrans.dats[2]      = CTRLEATHER_PORT[0];
                                                      datsSend_request.datsTrans.dats[3]      = colonyCtrlGet_statusLocalEaCtrl[0];
                                                      datsSend_request.datsTrans.dats[4]      = CTRLEATHER_PORT[1];
                                                      datsSend_request.datsTrans.dats[5]      = colonyCtrlGet_statusLocalEaCtrl[1];
                                                      datsSend_request.datsTrans.dats[6]      = CTRLEATHER_PORT[2];
                                                      datsSend_request.datsTrans.dats[7]      = colonyCtrlGet_statusLocalEaCtrl[2];
                                                      datsSend_request.datsTrans.datsLen      = 8;
                                                      datsSend_request.nwkAddr                        = 0;
                                                      datsSend_request.portPoint                      = ZIGB_ENDPOINT_CTRLSYSZIGB;
                                                      
                                                      memset(datsRcv_respond.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8)); //ÐèÒªÔ¶¶ËÏìÓ¦
                                                      memcpy(datsRcv_respond.datsTrans.dats, remote_responseFrame, 3); //Ô¶¶ËÏìÓ¦Ö¡¼ÓÔØ
                                                      datsRcv_respond.datsTrans.datsLen       = 3;
                                                      datsRcv_respond.nwkAddr                         = 0;
                                                      datsRcv_respond.portPoint                       = ZIGB_ENDPOINT_CTRLSYSZIGB;
                                                      
                                                      devRunning_Status = status_dataTransRequestDatsSend; //Ö±½ÓÇÐ»»£¨²»×öÔ¤±¸¶¯×÷£©
                                              }
                                              
                                              return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£³Ö£¬
             -µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
                                      }
              #endif /*ºêÅÐÎ²*///¼¯Èº¿ØÖÆÐÅÏ¢ÖÜÆÚ²éÑ¯Ê¹ÄÜ
2740   3                              
2741   3                              //--------------------------------Ö÷×´Ì¬£ºÊý¾Ý½âÎöÏìÓ¦-----------------------------------------------//
2742   3                              if(uartRX_toutFLG){ //Êý¾Ý½ÓÊÕ(Ö¡³¬Ê±)
2743   4                                      
2744   4                                      uartRX_toutFLG = 0;
2745   4                                      
2746   4      //                              if(datsRcv_ZIGB.rcvDats[0] != ZIGB_FRAME_HEAD){ //Ö¡Í·²»¶Ô£¬´òÓ¡Êä³ö
2747   4      //                              
2748   4      //#if(DEBUG_LOGOUT_EN == 1)
2749   4      //                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2750   4      //                                                      u8 xdata log_buf[64];
2751   4      //                                                      
2752   4      //                                                      sprintf(log_buf, "err frameHead:%02X.\n", (int)datsRcv_ZIGB.rcvDats[0]);
2753   4      //                                                      PrintString1_logOut(log_buf);
2754   4      //                                              }                       
2755   4      //#endif        
2756   4      //                              }
2757   4                                      
2758   4                                      /*ZigbeeÒ»¼¶Ð­ÒéºË¶Ô½âÎö*/
2759   4                                      if((datsRcv_ZIGB.rcvDats[0] == ZIGB_FRAME_HEAD) &&
2760   4                                              !memcmp(&datsRcv_ZIGB.rcvDats[2], cmd_datsComing, 2)){
2761   5                                              
2762   5                                              u16 idata datsFrom_addr = ((u16)(datsRcv_ZIGB.rcvDats[9]) << 8) | ((u16)(datsRcv_ZIGB.rcvDats[8]) << 
             -0); //Êý¾Ý·¢ËÍ·½ÍøÂçµØÖ·
2763   5                                              u8      idata srcPoint =  datsRcv_ZIGB.rcvDats[10];     //Ô´¶Ë
2764   5                                              u8      idata dstPoint =  datsRcv_ZIGB.rcvDats[11];     //Ô¶¶Ë
2765   5                                                      
2766   5                                              devTips_nwkZigb = nwkZigb_Normal; //zigbTips×´Ì¬ÏìÓ¦£¬Ö»Òª½ÓÊÕµ½zigbÊý¾Ý£¬tips×´Ì¬¾ÍÇÐ»»ÖÁÕý³£
2767   5                                              
2768   5                                              memset(paramRX_temp, 0, sizeof(u8) * dataLen_zigbDatsTrans);
2769   5                                              memcpy(paramRX_temp, &(datsRcv_ZIGB.rcvDats[21]), datsRcv_ZIGB.rcvDats[20]);
2770   5                                                      
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 48  

2771   5                                              if(srcPoint > CTRLEATHER_PORT_NUMSTART && srcPoint < CTRLEATHER_PORT_NUMTAIL){ /*»¥¿Ø¶Ë¿Ú*/
2772   6                                                      
2773   6                                                      u8 idata statusRelay_temp = status_Relay; //µ±Ç°¿ª¹Ø×´Ì¬»º´æ
2774   6                                                      
2775   6                                                      colonyCtrlGet_queryCounter = COLONYCTRLGET_QUERYPERIOD; //¼¯ÈºÐÅÏ¢²éÑ¯Ö÷¶¯ÖÍºó£¬ÒÔ·ÀÓëÖ÷»ú¼¯ÈºÐÅÏ¢Î´
             -¸üÐÂ£¬µ¼ÖÂÓë±¾µØÐÅÏ¢³åÍ»
2776   6                                                      
2777   6      #if(DEBUG_LOGOUT_EN == 1)
2778   6                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2779   7                                                              memset(log_buf, 0, LOGBUFF_LEN * sizeof(u8));
2780   7                                                              sprintf(log_buf, "ctrl eachOther cmd coming, cluster:%02d.\n", (int)srcPoint);
2781   7                                                              PrintString1_logOut(log_buf);
2782   7                                                      }                       
2783   6      #endif  
2784   6                                                      if((srcPoint == CTRLEATHER_PORT[0]) && (0 != CTRLEATHER_PORT[0])){ //¿ª¹ØÎ»1 »¥¿Ø°ó¶¨ÅÐ¶Ï
2785   7                                                      
2786   7                                                              swCommand_fromUsr.actMethod = relay_OnOff;
2787   7                                                              statusRelay_temp &= ~(1 << 0); //¶¯×÷Î»»º´æÇåÁã
2788   7                                                              swCommand_fromUsr.objRelay = statusRelay_temp | paramRX_temp[0] << 0; //bit0 ¿ª¹ØÎ»¶¯×÷ÏìÓ¦
2789   7                                                              (paramRX_temp[0])?(colonyCtrlGet_statusLocalEaCtrl[0] = STATUSLOCALEACTRL_VALMASKRESERVE_ON):(colon
             -yCtrlGet_statusLocalEaCtrl[0] = STATUSLOCALEACTRL_VALMASKRESERVE_OFF); //±¾µØ»¥¿ØÂÖÑ¯Öµ¸üÐÂ
2790   7                                                      }
2791   6                                                      else
2792   6                                                      if((srcPoint == CTRLEATHER_PORT[1]) && (0 != CTRLEATHER_PORT[1])){ //¿ª¹ØÎ»2 »¥¿Ø°ó¶¨ÅÐ¶Ï
2793   7                                                      
2794   7                                                              swCommand_fromUsr.actMethod = relay_OnOff;
2795   7                                                              statusRelay_temp &= ~(1 << 1); //¶¯×÷Î»»º´æÇåÁã
2796   7                                                              swCommand_fromUsr.objRelay = statusRelay_temp | paramRX_temp[0] << 1; //bit1 ¿ª¹ØÎ»¶¯×÷ÏìÓ¦
2797   7                                                              (paramRX_temp[0])?(colonyCtrlGet_statusLocalEaCtrl[1] = STATUSLOCALEACTRL_VALMASKRESERVE_ON):(colon
             -yCtrlGet_statusLocalEaCtrl[1] = STATUSLOCALEACTRL_VALMASKRESERVE_OFF); //±¾µØ»¥¿ØÂÖÑ¯Öµ¸üÐÂ
2798   7                                                      }
2799   6                                                      else
2800   6                                                      if((srcPoint == CTRLEATHER_PORT[2]) && (0 != CTRLEATHER_PORT[2])){ //¿ª¹ØÎ»3 »¥¿Ø°ó¶¨ÅÐ¶Ï
2801   7                                                      
2802   7                                                              swCommand_fromUsr.actMethod = relay_OnOff;
2803   7                                                              statusRelay_temp &= ~(1 << 2); //¶¯×÷Î»»º´æÇåÁã
2804   7                                                              swCommand_fromUsr.objRelay = statusRelay_temp | paramRX_temp[0] << 2; //bit2 ¿ª¹ØÎ»¶¯×÷ÏìÓ¦
2805   7                                                              (paramRX_temp[0])?(colonyCtrlGet_statusLocalEaCtrl[2] = STATUSLOCALEACTRL_VALMASKRESERVE_ON):(colon
             -yCtrlGet_statusLocalEaCtrl[2] = STATUSLOCALEACTRL_VALMASKRESERVE_OFF); //±¾µØ»¥¿ØÂÖÑ¯Öµ¸üÐÂ
2806   7                                                      }
2807   6                                                      
2808   6                                                      devActionPush_IF.push_IF = 1; //ÍÆËÍÊ¹ÄÜ
2809   6                                              
2810   6                                              }else{ /*·Ç»¥¿Ø¶Ë¿Ú*///Ê£ÏÂ¾ÍÊÇÏµÍ³×¨ÓÃµÄ15¸ö¶Ë¿Ú
2811   6                                              
2812   6                                                      switch(srcPoint){
2813   7                                                              
2814   7                                                              /*³¡¾°¼¯Èº¶Ë¿Ú*/
2815   7                                                              case ZIGB_ENDPOINT_CTRLSECENARIO:{      
2816   8                                                              
2817   8                                                                      dataParing_scenarioCtrl(paramRX_temp); //³¡¾°¼¯Èº¿ØÖÆ½âÎö
2818   8                                                                      
2819   8                                                              }break;
2820   7                                                      
2821   7                                                              /*³£¹æ¿ØÖÆ×ª·¢¶Ë¿Ú*/
2822   7                                                              case ZIGB_ENDPOINT_CTRLNORMAL:{ 
2823   8                                                              
2824   8                                                                      if(datsFrom_addr == ZIGB_NWKADDR_CORDINATER){ //À´×ÔÐ­µ÷Æ÷
2825   9                                                                      
2826   9                                                                              dataParing_Nomal(paramRX_temp, datsFrom_addr, srcPoint); //³£¹æ½âÎö
2827   9                                                                      }
2828   8                                                                      
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 49  

2829   8                                                              }break;
2830   7                                                              
2831   7                                                              /*zigbÏµÍ³½»»¥¶Ë¿Ú*/
2832   7                                                              case ZIGB_ENDPOINT_CTRLSYSZIGB:{        
2833   8                                                              
2834   8                                                                      dataParing_zigbSysCtrl(paramRX_temp); //ÏµÍ³¿ØÖÆ½âÎö
2835   8                                                                      
2836   8                                                              }break;
2837   7                                                                      
2838   7                                                              default:{
2839   8                                                              
2840   8                                                                      
2841   8                                                                      
2842   8                                                              }break;
2843   7                                                      }
2844   6                                              }
2845   5                                      }
2846   4                              }
2847   3                              
2848   3                      }break;
2849   2                      
2850   2                      case status_nwkREQ:{
2851   3                      
2852   3                              //--------------------------------Ð­×´Ì¬£ºÍøÂçÇëÇó-----------------------------------------------//
2853   3                              devTips_nwkZigb = nwkZigb_nwkREQ;
2854   3                              zigB_nwkJoinRequest(1); //·Ç×èÈûÖ÷¶¯¼ÓÈë¸½½ü¿ª·ÅÍøÂç
2855   3                              
2856   3                      }break;
2857   2                              
2858   2                      case status_nwkReconnect:{
2859   3                      
2860   3                              //--------------------------------Ð­×´Ì¬£ºµôÏß´¦Àí-----------------------------------------------//
2861   3                              devTips_nwkZigb = nwkZigb_reConfig;
2862   3                              zigB_nwkJoinRequest(0); //·Ç×èÈûÖØÁ¬
2863   3                              
2864   3                      }break;
2865   2                      
2866   2                      case status_dataTransRequestDatsSend:{
2867   3                              
2868   3                              //--------------------------------Ð­×´Ì¬£ºÊý¾ÝÇëÇó-----------------------------------------------//
2869   3                              dataTransRequest_datsSend(); //·Ç×èÈûÔ¶¶ËÊý¾Ý´«Êä
2870   3                      
2871   3                      }break;
2872   2                      
2873   2                      case status_devNwkHold:{
2874   3                      
2875   3                              //--------------------------------Ð­×´Ì¬£ºÍøÂç¹ÒÆð-----------------------------------------------//
2876   3                              devTips_nwkZigb = nwkZigb_hold;
2877   3                              function_devNwkHold();
2878   3                              
2879   3                      }break;
2880   2                              
2881   2                      default:{
2882   3                      
2883   3                              if(devStatus_switch.statusChange_IF){ //×´Ì¬Ç¿ÖÆÇÐ»»Ê±£¬½«µ±Ç°×Ó×´Ì¬ÄÚ¾²Ì¬±äÁ¿³õÊ¼»¯ºóÔÙ½øÐÐÍâ²¿ÇÐ»»
2884   4                              
2885   4                                      devStatus_switch.statusChange_IF = 0;
2886   4                                      devRunning_Status = devStatus_switch.statusChange_standBy;
2887   4                                      
2888   4                                      break;
2889   4                              }
2890   3                      
C51 COMPILER V9.54   DATATRANS                                                             11/02/2018 15:47:41 PAGE 50  

2891   3                      }break;
2892   2              }
2893   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   9717    ----
   CONSTANT SIZE    =   3699    ----
   XDATA SIZE       =    361    1045
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9     143
   IDATA SIZE       =   ----       9
   BIT SIZE         =      8      17
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
