C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE DATATRANS
OBJECT MODULE PLACED IN .\Output\dataTrans.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE dataTrans\dataTrans.c OMF2 ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE INCDIR(
                    -.\Usr;.\Usr_lib;.\std_Lib;.\dataTrans;.\Actuator;.\Sensor;.\hwDriver) DEBUG PRINT(.\Listings\dataTrans.lst) OBJECT(.\Out
                    -put\dataTrans.obj)

line level    source

   1          #include "dataTrans.h"
   2          
   3          #include "string.h"
   4          #include "stdio.h"
   5          
   6          #include "eeprom.h"
   7          #include "USART.h"
   8          #include "delay.h"
   9          #include "Relay.h"
  10          
  11          #include "timerAct.h"
  12          #include "pars_Method.h"
  13          #include "dataManage.h"
  14          #include "Tips.h"
  15          
  16          /**********************±¾µØÎÄ¼þ±äÁ¿¶¨ÒåÇø************************/
  17          datsAttr_datsTrans xdata datsSend_request;//Ô¶¶ËÊý¾Ý´«ÊäÇëÇó»º´æ
  18          datsAttr_datsTrans xdata datsRcv_respond;//Ô¶¶ËÊý¾Ý´«ÊäÇëÇóµÈ´ýÏìÓ¦»º´æ»º´æ
  19          
  20          //zigbeeÔËÐÐ×´Ì¬ÇÐ»»±êÖ¾
  21          stt_statusChange xdata devStatus_switch = {0, status_NULL};
  22          //Êý¾ÝÇëÇóÍê³ÉºóÊÇ·ñÐèÒªÖØÆôÍøÂç
  23          bit reConnectAfterDatsReq_IF = 0; //ÓÃÓÚ»¥¿ØÍ¨Ñ¶´Ø¼´¿Ì×¢²áÌØÊâÇé¿öÏÂÊ¹ÓÃ
  24          
  25          bit coordinatorOnline_IF = 0; //Ð­µ÷Æ÷ÔÚÏß±êÖ¾
  26          
  27          //zigbÍøÂç¶¯×÷×¨ÓÃÊ±¼ä¼ÆÊý
  28          u16 xdata zigbNwkAction_counter = 0;
  29          
  30          //zigbÉè±¸ÍøÂç¹ÒÆðÊôÐÔ²ÎÊý
  31          attr_devNwkHold xdata devNwkHoldTime_Param = {0};
  32          
  33          //ÐÄÌø
  34          bit heartBeatCycle_FLG = 0;     //ÐÄÌøÖÜÆÚ´¥·¢
  35          u8      heartBeatCount     = 0; //ÐÄÌøÖÜÆÚ¼ÆÊý
  36          
  37          //¼¯ÈºÊÜ¿ØÖÜÆÚÂÖÑ¯-<°üÀ¨ÓÐ»¥¿ØºÍ³¡¾°>
  38          u8      xdata colonyCtrlGet_queryCounter = COLONYCTRLGET_QUERYPERIOD; //¼¯ÈºÊÜ¿Ø×´Ì¬ÖÜÆÚÐÔÂÖÑ¯¼ÆÊ±¼ÆÊýÖµ 
  39          u8      xdata colonyCtrlGet_statusLocalEaCtrl[clusterNum_usr] = {0}; //¼¯Èº¿ØÖÆ-±¾µØ»¥¿Ø×´Ì¬Î»¼ÇÂ¼
  40          u8      xdata colonyCtrlGet_statusLocalScene = 0; //¼¯Èº¿ØÖÆ-±¾µØ³¡¾°×´Ì¬Î»¼ÇÂ¼
  41          
  42          //´®¿Ú½ÓÊÕ³¬Ê±±êÖ¾
  43          bit uartRX_toutFLG      = 0;
  44          //´®¿Ú½ÓÊÕ³¬Ê±¼ÆÊý
  45          bit rxTout_count_EN = 0;
  46          u8  rxTout_count        = 0;
  47          //´®¿ÚÊý¾Ý»º´æ
  48          u8      datsRcv_length  = 0;
  49          uartTout_datsRcv xdata datsRcv_ZIGB = {{0}, 0};
  50          
  51          //zigbeeÍ¨ÐÅÏß³Ìµ±Ç°ÔËÐÐ×´Ì¬±êÖ¾
  52          threadRunning_Status devRunning_Status = status_NULL;
  53          
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 2   

  54          void zigbUart_pinInit(void){
  55   1      
  56   1              //TXÍÆÍìÊä³ö
  57   1              P3M1 &= 0xFD;   
  58   1              P3M0 |= 0x02;   
  59   1              
  60   1              //RX¸ß×èÊäÈë
  61   1              P3M1 |= 0x01;
  62   1              P3M0 &= 0xFE;
  63   1              
  64   1              //TXÍÆÍìÊä³ö
  65   1              P2M1 &= ~0x08;
  66   1              P2M0 |= 0x08;
  67   1      }
  68                  
  69          /*--------------------------------------------------------------*/
  70          void uartObjZigb_Init(void){
  71   1      
  72   1              EA = 0;
  73   1      
  74   1              PS = 1;
  75   1              SCON = (SCON & 0x3f) | UART_8bit_BRTx;
  76   1      
  77   1      {
  78   2              u32 j = (MAIN_Fosc / 4) / ZIGB_BAUND;   //°´1T¼ÆËã
  79   2                      j = 65536UL - j;
  80   2              
  81   2              TH2 = (u8)(j>>8);
  82   2              TL2 = (u8)j;
  83   2      }
  84   1              AUXR &= ~(1<<4);        //Timer stop
  85   1              AUXR |= 0x01;           //S1 BRT Use Timer2;
  86   1              AUXR &= ~(1<<3);        //Timer2 set As Timer
  87   1              AUXR |=  (1<<2);        //Timer2 set as 1T mode
  88   1      
  89   1              IE2  &= ~(1<<2);        //½ûÖ¹ÖÐ¶Ï
  90   1              AUXR &= ~(1<<3);        //¶¨Ê±
  91   1              AUXR |=  (1<<4);        //Timer run enable
  92   1      
  93   1              ES        = 1;
  94   1              REN   = 1;
  95   1              P_SW1 = (P_SW1 & 0x3f) | (UART1_SW_P30_P31 & 0xc0);
  96   1              
  97   1              memset(TX1_Buffer, 0, sizeof(char) * COM_TX1_Lenth);
  98   1      
  99   1              EA = 1;
 100   1      
 101   1              PrintString1("i'm UART1 for wifi data translate !!!\n");
 102   1              PrintString1_logOut("i'm UART1 for datsLog !!!\n");
 103   1      }
 104          
 105          ///*----------------------------
 106          //·¢ËÍ´®¿ÚÊý¾Ý
 107          //----------------------------*/
 108          //void uartObjWIFI_Send_Byte(u8 dat)    //´®¿Ú1
 109          //{
 110          //      TX1_write2buff(dat);
 111          //}
 112          
 113          //void uartObjWIFI_Send_String(char *s,unsigned char ucLength){  //´®¿Ú1
 114          //      
 115          //      uart1_datsSend(s, ucLength);
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 3   

 116          //}
 117          
 118          //void rxBuff_WIFI_Clr(void){
 119          
 120          //      memset(rxBuff_WIFI, 0xff, sizeof(char) * COM_RX1_Lenth);
 121          //      COM1.RX_Cnt = 0;
 122          //}
 123          
 124          /********************* UART1(WIIF)ÖÐ¶Ïº¯Êý_×Ô¶¨ÒåÖØ¹¹************************/
 125          void UART1_Rountine (void) interrupt UART1_VECTOR
 126          {
 127   1              
 128   1              if(RI)
 129   1              {
 130   2                      RI = 0;
 131   2                      if(COM1.B_RX_OK == 0)
 132   2                      {
 133   3                              
 134   3      //                      if(COM1.RX_Cnt >= COM_RX1_Lenth)        COM1.RX_Cnt = 0;
 135   3      //                      RX1_Buffer[COM1.RX_Cnt++] = SBUF;
 136   3      //                      COM1.RX_TimeOut = TimeOutSet1;
 137   3                              
 138   3                              if(!rxTout_count_EN){
 139   4                              
 140   4                                      rxTout_count_EN = 1;
 141   4                                      rxTout_count    = 0;
 142   4                                      datsRcv_length  = 0;
 143   4                                      
 144   4                                      memset(RX1_Buffer, 0xff, sizeof(char) * COM_RX1_Lenth);
 145   4                              }
 146   3                              
 147   3                              
 148   3                              RX1_Buffer[datsRcv_length ++]   = SBUF;
 149   3                              rxTout_count = 0;
 150   3                      }
 151   2              }
 152   1      
 153   1              if(TI)
 154   1              {
 155   2                      TI = 0;
 156   2                      if(COM1.TX_read != COM1.TX_write)
 157   2                      {
 158   3                              SBUF = TX1_Buffer[COM1.TX_read];
 159   3                              if(++COM1.TX_read >= COM_TX1_Lenth)             COM1.TX_read = 0;
 160   3                      }
 161   2                      else    COM1.B_TX_busy = 0;
 162   2              }
 163   1      }
 164          
 165          /* ×Ô¶¨ÒåÐ£Ñé*///×Ô¼Ò²úÆ·Ð­Òé²ã
 166          static 
 167          unsigned char frame_Check(unsigned char frame_temp[], u8 check_num){
 168   1        
 169   1              unsigned char loop              = 0;
 170   1              unsigned char val_Check = 0;
 171   1              
 172   1              for(loop = 0; loop < check_num; loop ++){
 173   2              
 174   2                      val_Check += frame_temp[loop];
 175   2              }
 176   1              
 177   1              val_Check  = ~val_Check;
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 4   

 178   1              val_Check ^= 0xa7;
 179   1              
 180   1              return val_Check;
 181   1      }
 182          
 183          /*´ËÊý¾Ý·â×°±ØÐëÔÚÊý¾Ý°ü·¢ËÍÇ°×îºóµ÷ÓÃ£¬×Ô¶¨Òå¶ÔÏó½øÐÐÊý¾Ý·â×°*///±ÜÃâÐ£Ñé±»ÌáÇ°¶ø³ö´í
 184          static 
 185          u8 dtasTX_loadBasic_CUST(bit ifRemoteDats,
 186                                                       u8 dats_Tx[],
 187                                                       u8 datsLen_TX,
 188                                                       u8 frame_Type,
 189                                                       u8 frame_CMD,
 190                                                       bit ifSpecial_CMD){
 191   1                                                         
 192   1              dats_Tx[2]      = frame_Type;
 193   1              dats_Tx[3]      = frame_CMD;
 194   1              
 195   1              if(!ifSpecial_CMD)dats_Tx[10] = SWITCH_TYPE;    //¿ª¹ØÀàÐÍÌî³ä
 196   1              
 197   1              memcpy(&dats_Tx[5], &MAC_ID[1], 5);     //MACÌî³ä
 198   1                                                        
 199   1              dats_Tx[4]      = frame_Check(&dats_Tx[5], 28);
 200   1                                                                 
 201   1              if(ifRemoteDats){
 202   2                      
 203   2                      u8 xdata dats_Temp[64] = {0};
 204   2              
 205   2                      dats_Tx[0] = ZIGB_FRAMEHEAD_CTRLREMOTE;
 206   2                      dats_Tx[1]      = datsLen_TX + 12;
 207   2                      
 208   2                      memcpy(dats_Temp, &dats_Tx[1], datsLen_TX - 13);
 209   2                      memset(&dats_Tx[1], 0, datsLen_TX - 1);
 210   2                      memcpy(&dats_Tx[13], dats_Temp, datsLen_TX - 13);
 211   2                      memcpy(&dats_Tx[1], MAC_ID_DST, 6);
 212   2                      memcpy(&dats_Tx[8], &MAC_ID[1], 5);
 213   2                      
 214   2                      return 45;
 215   2                      
 216   2              }else{
 217   2              
 218   2                      dats_Tx[0]      = ZIGB_FRAMEHEAD_CTRLLOCAL;
 219   2                      dats_Tx[1]      = datsLen_TX;
 220   2                      
 221   2                      return 33;
 222   2              }
 223   1      }
 224          
 225          /*Êý¾ÝÒì»òÐ£Ñé*///ZNPÐ­Òé²ã
 226          static 
 227          u8 XORNUM_CHECK(u8 buf[], u8 length){
 228   1      
 229   1              u8 loop = 0;
 230   1              u8 valXOR = buf[0];
 231   1              
 232   1              for(loop = 1;loop < length;loop ++)valXOR ^= buf[loop];
 233   1              
 234   1              return valXOR;
 235   1      }
 236          
 237          /*zigbeeÊý¾ÝÖ¡¼ÓÔØ*/
 238          static 
 239          u8 ZigB_TXFrameLoad(u8 frame[],u8 cmd[],u8 cmdLen,u8 dats[],u8 datsLen){                
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 5   

 240   1      
 241   1              const u8 frameHead = ZIGB_FRAME_HEAD;   //ZNP,SOFÖ¡Í·
 242   1              u8 xor_check = datsLen;                                 //Òì»òÐ£Ñé£¬Ö¡Î²
 243   1              u8 loop = 0;
 244   1              u8 ptr = 0;
 245   1              
 246   1              frame[ptr ++] = frameHead;
 247   1              frame[ptr ++] = datsLen;
 248   1              
 249   1              memcpy(&frame[ptr],cmd,cmdLen);
 250   1              ptr += cmdLen;
 251   1              for(loop = 0;loop < cmdLen;loop ++)xor_check ^= cmd[loop];
 252   1      
 253   1              memcpy(&frame[ptr],dats,datsLen);
 254   1              ptr += datsLen;
 255   1              for(loop = 0;loop < datsLen;loop ++)xor_check ^= dats[loop];    
 256   1              
 257   1              frame[ptr ++] = xor_check;
 258   1              
 259   1              return ptr;
 260   1      }
 261          
 262          /*zigbeeµ¥Ö¸ÁîÊý¾ÝÇëÇó£¬·µ»ØÓ¦´ðÊý¾Ý³¤¶È*/
 263          static 
 264          u8 zigb_datsRequest( u8 frameREQ[],             //ÇëÇóÖ¡
 265                                                   u8 frameREQ_Len,       //ÇëÇóÖ¡³¤
 266                                                   u8 resp_cmd[2],        //ËùÐèÓ¦´ðÖ¸Áî
 267                                                   u8 resp_dats[],        //Ó¦´ðÊý¾Ý»º´æ
 268                                                   u8 loopReapt,u16 timeWait){    //Ñ­»·´ÎÊý£¬µ¥´ÎµÈ´ýÊ±¼ä
 269   1                                                
 270   1              u16 Local_Delay = timeWait;             
 271   1              u8      loop = 0;
 272   1                                                       
 273   1              for(loop = 0;loop < loopReapt;loop ++){
 274   2              
 275   2                      uartRX_toutFLG = 0;
 276   2                      zigbNwkAction_counter = timeWait;       
 277   2                  uartZigB_datsSend(frameREQ, frameREQ_Len);
 278   2                      
 279   2                      while(zigbNwkAction_counter){ //¶¨Ê±Æ÷ÖÐ¶ÏÄÚ½øÐÐµ¹¼ÆÊ±
 280   3      
 281   3                              if(uartRX_toutFLG){
 282   4                              
 283   4                                      uartRX_toutFLG = 0;
 284   4                                      
 285   4                                      if(!memcmp(&(datsRcv_ZIGB.rcvDats[2]), resp_cmd, 2)){
 286   5                                      
 287   5                                              memcpy(resp_dats, datsRcv_ZIGB.rcvDats, datsRcv_ZIGB.rcvDatsLen);
 288   5                                              return datsRcv_ZIGB.rcvDatsLen;
 289   5                                              
 290   5                                      }
 291   4                              }
 292   3                      }
 293   2              }       
 294   1      
 295   1              return 0;
 296   1      }
 297          
 298          /*zigbeeµ¥Ö¸ÁîÏÂ·¢¼°ÏìÓ¦ÑéÖ¤*///×èÈû
 299          bit zigb_VALIDA_INPUT(u8 REQ_CMD[2],            //Ö¸Áî
 300                                                    u8 REQ_DATS[],                //Êý¾Ý
 301                                                    u8 REQdatsLen,                //Êý¾Ý³¤¶È
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 6   

 302                                                    u8 ANSR_frame[],              //ÏìÓ¦Ö¡
 303                                                    u8 ANSRdatsLen,               //ÏìÓ¦Ö¡³¤¶È
 304                                                    u8 times,u16 timeDelay){      //Ñ­»·´ÎÊý£¬µ¥´ÎµÈ´ýÊ±¼ä
 305   1                                                 
 306   1      #define dataLen_validaInput     96
 307   1              u8 xdata dataTXBUF[dataLen_validaInput] = {0};
 308   1              u8      loop = 0;
 309   1              u8      datsTX_Len;
 310   1      
 311   1              datsTX_Len = ZigB_TXFrameLoad(dataTXBUF,REQ_CMD, 2, REQ_DATS, REQdatsLen);
 312   1      
 313   1              for(loop = 0;loop < times;loop ++){
 314   2              
 315   2                      uartRX_toutFLG = 0;
 316   2                      zigbNwkAction_counter = timeDelay;
 317   2                      uartZigB_datsSend(dataTXBUF, datsTX_Len);
 318   2                      
 319   2                      while(zigbNwkAction_counter){ //¶¨Ê±Æ÷ÖÐ¶ÏÄÚ½øÐÐµ¹¼ÆÊ±
 320   3                              
 321   3                              if(uartRX_toutFLG){
 322   4                              
 323   4                                      uartRX_toutFLG = 0;
 324   4                                      
 325   4                                      if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, ANSR_frame, ANSRdatsLen)){
 326   5                                      
 327   5                                              delayMs(2);
 328   5                                              return 1;
 329   5                                      }
 330   4                              }
 331   3                      }
 332   2              }
 333   1              
 334   1              return 0;
 335   1      }
 336          
 337          ///*zigbeeÍ¨ÐÅ´ØÉèÖÃ*///×èÈû
 338          //bit zigb_clusterSet(u16 deviveID, u8 endPoint){
 339          
 340          //      datsAttr_ZigbInit code default_param = {{0x24,0x00},{0x0E,0x0D,0x00,0x0D,0x00,0x0D,0x00,0x01,0x00,0x00,
             -0x01,0x00,0x00},0x0D,{0xFE,0x01,0x64,0x00,0x00,0x65},0x06,300};       //Êý¾Ý´Ø×¢²á,Ä¬ÈÏ²ÎÊý
 341          //      u8 code frameResponse_Subs[6] = {0xFE,0x01,0x64,0x00,0xB8,0xDD}; //ÏìÓ¦Ö¡Ìæ²¹£¬ÈôÊý¾Ý´ØÒÑ¾­×¢²á
 342          //              
 343          //#define       dataLen_zigbClusterSet  64
 344          //      u8 xdata paramTX_temp[dataLen_zigbClusterSet] = {0};
 345          //      
 346          //      bit setResult = 0;
 347          //      
 348          //      memcpy(paramTX_temp, default_param.zigbInit_reqDAT, default_param.reqDAT_num);
 349          //      paramTX_temp[0] = endPoint;
 350          //      paramTX_temp[3] = (u8)((deviveID & 0x00ff) >> 0);
 351          //      paramTX_temp[4] = (u8)((deviveID & 0xff00) >> 8);
 352          //      
 353          //      setResult =  zigb_VALIDA_INPUT( (u8 *)default_param.zigbInit_reqCMD,
 354          //                                                                      (u8 *)paramTX_temp,
 355          //                                                                      default_param.reqDAT_num,
 356          //                                                                      (u8 *)default_param.zigbInit_REPLY,
 357          //                                                                      default_param.REPLY_num,
 358          //                                                                      2,              //2´ÎÒÔÄÚÃ»ÓÐÕýÈ·ÏìÓ¦¾ÍÊ§°Ü
 359          //                                                                      default_param.timeTab_waitAnsr);
 360          //      
 361          //      if(setResult)return setResult;
 362          //      else{
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 7   

 363          //      
 364          //              return zigb_VALIDA_INPUT((u8 *)default_param.zigbInit_reqCMD,
 365          //                                                               (u8 *)paramTX_temp,
 366          //                                                               default_param.reqDAT_num,
 367          //                                                               (u8 *)frameResponse_Subs,
 368          //                                                               6,
 369          //                                                               2,             //2´ÎÒÔÄÚÃ»ÓÐÕýÈ·ÏìÓ¦¾ÍÊ§°Ü
 370          //                                                               default_param.timeTab_waitAnsr);
 371          //      }
 372          //}
 373          
 374          ///*zigbeeÖØÐÂÈëÍø*///×èÈûº¯Êý£¬½ö¹©²âÊÔÊ¹ÓÃ
 375          //bit ZigB_NwkJoin(u16 PANID, u8 CHANNELS){
 376          
 377          //#define       cmdNum_zigbNwkJoin      8       
 378          //      
 379          //#define        loop_PANID             5
 380          //#define        loop_CHANNELS  6
 381          
 382          //      datsAttr_ZigbInit code ZigbInit_dats[cmdNum_zigbNwkJoin] = {
 383          //              
 384          //              {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      
             -//¸´Î»
 385          //              {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      
             -//¸´Î»
 386          //              {       {0x26,0x05},    {0x03,0x01,0x03},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //¼Ä´æÆ÷³
             -õÊ¼»¯£¬È«²¿Çå¿Õ
 387          //              {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      
             -//¶þ´Î¸´Î»
 388          //              
 389          ////            {       {0x26,0x05},    {0x87,0x01,0x00},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«É
             -èÖÃ£¨Ð­µ÷Æ÷£©
 390          //              {       {0x26,0x05},    {0x87,0x01,0x01},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«ÉèÖ
             -Ã£¨Â·ÓÉÆ÷£©
 391          ////            {       {0x26,0x05},    {0x87,0x01,0x02},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«É
             -èÖÃ£¨ÖÕ¶Ë£©
 392          //              
 393          //              {       {0x27,0x02},    {0x34,0x12},                    0x02,   {0xFE,0x01,0x67,0x02,0x00,0x64},                                                        0x06,   500             },      //PAN_ID¼Ä´æÆ
             -÷ÉèÖÃ
 394          //              {       {0x27,0x03},    {0x00,0x80,0x00,0x00},  0x04,   {0xFE,0x01,0x67,0x03,0x00,0x65},                                                        0x06,   500             },      //ÐÅµ
             -À¼Ä´æÆ÷ÅäÖÃ
 395          ////            {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x09,0x8D},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È
             -¶¨½ÇÉ«Ð­µ÷Æ÷£¨Ð­µ÷Æ÷ÏìÓ¦£©
 396          //              {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x07,0x83},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È¶¨
             -½ÇÉ«Ð­µ÷Æ÷£¨Â·ÓÉÆ÷ÏìÓ¦£©
 397          ////            {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x06,0x82},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È
             -¶¨½ÇÉ«Ð­µ÷Æ÷£¨ÖÕ¶ËÏìÓ¦£©
 398          //      };
 399          //      
 400          //#define       dataLen_zigbNwkJoin 64
 401          //      u8 xdata paramTX_temp[dataLen_zigbNwkJoin] = {0};
 402          //      
 403          //      u8  loop;
 404          //      u32 chnl_temp = 0x00000800UL << CHANNELS;
 405          //      
 406          //      for(loop = 1; loop < cmdNum_zigbNwkJoin; loop ++){
 407          //              
 408          //              memset(paramTX_temp, 0, dataLen_zigbNwkJoin * sizeof(u8));
 409          //              
 410          //              switch(loop){   //×ÔÑ¡²ÎÊý&Ä¬ÈÏ²ÎÊý
 411          //              
 412          //                      case loop_PANID:{
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 8   

 413          //                      
 414          //                              paramTX_temp[0] = (u8)((PANID & 0x00ff) >> 0);
 415          //                              paramTX_temp[1] = (u8)((PANID & 0xff00) >> 8);
 416          //                              
 417          //                      }break;
 418          //                      
 419          //                      case loop_CHANNELS:{
 420          //                      
 421          //                              paramTX_temp[0] = (u8)((chnl_temp & 0x000000ff) >>  0);
 422          //                              paramTX_temp[1] = (u8)((chnl_temp & 0x0000ff00) >>  8);
 423          //                              paramTX_temp[2] = (u8)((chnl_temp & 0x00ff0000) >> 16);
 424          //                              paramTX_temp[3] = (u8)((chnl_temp & 0xff000000) >> 24);
 425          //                              
 426          //                      }break;
 427          //                      
 428          //                      default:{
 429          //                      
 430          //                              memcpy(paramTX_temp,ZigbInit_dats[loop].zigbInit_reqDAT,ZigbInit_dats[loop].reqDAT_num);
 431          //                              
 432          //                      }break;
 433          //              }
 434          //      
 435          //              delayMs(100);
 436          //              if(0 == zigb_VALIDA_INPUT((u8 *)ZigbInit_dats[loop].zigbInit_reqCMD,
 437          //                                                                (u8 *)paramTX_temp,
 438          //                                                                ZigbInit_dats[loop].reqDAT_num,
 439          //                                                                (u8 *)ZigbInit_dats[loop].zigbInit_REPLY,
 440          //                                                                ZigbInit_dats[loop].REPLY_num,
 441          //                                                                3,
 442          //                                                                ZigbInit_dats[loop].timeTab_waitAnsr)
 443          //                                                               )loop = 0;
 444          //      }
 445          //      
 446          //      return zigb_clusterSet(13, 13); //Éè±¸ID 13£¬ÖÕ¶Ëµã 13£»
 447          //}
 448          
 449          /*zigbee Ö÷¶¯¿ª·ÅÍøÂç*///×èÈû
 450          bit ZigB_nwkOpen(bit openIF, u8 openTime){
 451   1      
 452   1              datsAttr_ZigbInit code default_param = {{0x26,0x08}, {0xFC,0xFF,0x00}, 0x03, {0xFE,0x01,0x66,0x08,0x00,0x
             -6F}, 0x06, 150}; //zigbeeÖ¸ÁîÏÂ´ïÄ¬ÈÏ²ÎÊý
 453   1              
 454   1              bit resultSet = 0;
 455   1              
 456   1              u8 openTime_temp = 0;
 457   1              
 458   1      #define paramLen_zigbNwkOpen 3
 459   1              u8 xdata paramTX_temp[paramLen_zigbNwkOpen] = {0xFC,0xFF,0x00};
 460   1              
 461   1              (openIF)?(paramTX_temp[2] = openTime):(paramTX_temp[2] = 0);
 462   1              
 463   1              resultSet = zigb_VALIDA_INPUT((u8 *)default_param.zigbInit_reqCMD,
 464   1                                                                        (u8 *)paramTX_temp,
 465   1                                                                        default_param.reqDAT_num,
 466   1                                                                        (u8 *)default_param.zigbInit_REPLY,
 467   1                                                                        default_param.REPLY_num,
 468   1                                                                        2,    //2´ÎÎÞ»Ø¸´ÎªÊ§°Ü
 469   1                                                                        default_param.timeTab_waitAnsr);
 470   1      
 471   1      #if(DEBUG_LOGOUT_EN == 1)       
 472   1      //      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
 473   1      //              u8 xdata log_buf[64];
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 9   

 474   1      //              
 475   1      //              sprintf(log_buf, "nwkOpen result:%d.\n", (int)resultSet);
 476   1      //              PrintString1_logOut(log_buf);
 477   1      //      }
 478   1      #endif
 479   1              
 480   1              return resultSet;
 481   1      }
 482          
 483          /*zigbee PANID»ñÈ¡*///×èÈû
 484          static u16 ZigB_getPanIDCurrent(void){
 485   1      
 486   1              u16 PANID_temp = 0;
 487   1              
 488   1      #define paramLen_zigbPanIDGet 32
 489   1              u8 xdata paramTX_temp[paramLen_zigbPanIDGet] = {0};
 490   1              
 491   1              u8 code frameREQ_zigbPanIDGet[6] = {0xFE, 0x01, 0x26, 0x06, 0x06, 0x27};        //zigb PANID»ñÈ¡Ö¸ÁîÖ¡
 492   1              u8 code cmdResp_zigbPanIDGet[2]  = {0x66, 0x06};        //zigb PANID»ñÈ¡Ô¤ÆÚÏìÓ¦Ö¸Áî
 493   1              u8 datsResp_Len = 0;
 494   1      
 495   1              datsResp_Len = zigb_datsRequest(frameREQ_zigbPanIDGet, 6, cmdResp_zigbPanIDGet, paramTX_temp, 2, 300);
 496   1      
 497   1              if(datsResp_Len){
 498   2      
 499   2                      PANID_temp |= (((u16)(paramTX_temp[5]) << 0) & 0x00FF);
 500   2                      PANID_temp |= (((u16)(paramTX_temp[6]) << 8) & 0xFF00);
 501   2      
 502   2      //              printf_datsHtoA("[Tips_uartZigb]: resultDats:", local_datsParam->frameResp, local_datsParam->frameResp
             -Len);
 503   2              }
 504   1      
 505   1              return PANID_temp;
 506   1      }
 507          
 508          /*zigbeeÏµÍ³Ê±¼ä»ñÈ¡²¢¸üÐÂ*///×èÈû
 509          static bit getSystemTime_reales(void){
 510   1              
 511   1              bit resultOpreat = 0;
 512   1      
 513   1      #define paramLen_zigbSystimeGet 32
 514   1              u8 xdata paramTX_temp[paramLen_zigbSystimeGet] = {0};
 515   1              
 516   1              u8 code frameREQ_zigbSystimeGet[5] = {0xFE, 0x00, 0x21, 0x11, 0x30};    //zigb PANID»ñÈ¡Ö¸ÁîÖ¡
 517   1              u8 code cmdResp_zigbSystimeGet[2]  = {0x61, 0x11};      //zigb PANID»ñÈ¡Ô¤ÆÚÏìÓ¦Ö¸Áî
 518   1              u8 datsResp_Len = 0;
 519   1      
 520   1              datsResp_Len = zigb_datsRequest(frameREQ_zigbSystimeGet, 5, cmdResp_zigbSystimeGet, paramTX_temp, 2, 300)
             -;
 521   1              
 522   1              if(!datsResp_Len)resultOpreat = 0;
 523   1              else{
 524   2                      
 525   2                      u16 Y_temp16 = ((u16)paramTX_temp[13] << 0) | ((u16)paramTX_temp[14] << 8);
 526   2                      u8  Y_temp8 = 0;
 527   2                      u8  M_temp8 = 0;
 528   2                      
 529   2                      u8 Y = (u8)(Y_temp16 % 2000);
 530   2                      u8 M = paramTX_temp[11];
 531   2                      u8 D = paramTX_temp[12];
 532   2                      u8 W = 0;
 533   2                      
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 10  

 534   2                      /*¼ÆËã»º´æ¸³Öµ*/
 535   2                      Y_temp8 = Y;
 536   2                      if(M == 1 || M == 2){ //Ò»ÔÂºÍ¶þÔÂµ±×÷ÉÏÒ»ÄêÊ®ÈýÔÂºÍÊ®ËÄÔÂ
 537   3                      
 538   3                              M_temp8 = M + 12;
 539   3                              Y_temp8 --;
 540   3                      }
 541   2                      else M_temp8 = M;
 542   2                      
 543   2                      /*¿ªÊ¼¼ÆËã*/
 544   2                      W =      Y_temp8 + (Y_temp8 / 4) + 5 - 40 + (26 * (M_temp8 + 1) / 10) + D - 1;  //²ÌÀÕ¹«Ê½
 545   2                      W %= 7; 
 546   2                      
 547   2                      /*¼ÆËã½á¹û¸³Öµ*/
 548   2                      W?(systemTime_current.time_Week = W):(systemTime_current.time_Week = 7);
 549   2                      
 550   2                      systemTime_current.time_Month =         M;
 551   2                      systemTime_current.time_Day =           D;
 552   2                      systemTime_current.time_Year =          Y;
 553   2                      
 554   2                      systemTime_current.time_Hour =          paramTX_temp[8];
 555   2                      systemTime_current.time_Minute =        paramTX_temp[9];
 556   2                      systemTime_current.time_Second =        paramTX_temp[10];
 557   2                      
 558   2                      /*±¾µØÊ±¼äÎ¬³Ö¼ÆÊýÖµÐ£×¼¸üÐÂ*/
 559   2                      sysTimeKeep_counter = systemTime_current.time_Minute * 60 + systemTime_current.time_Second; //ÏµÍ³Ê±¼äÎ¬
             -³Ö¼ÆÊýÖµ¸üÐÂ
 560   2                      
 561   2                      resultOpreat = 1;
 562   2              }
 563   1              
 564   1      #if(DEBUG_LOGOUT_EN == 1)       
 565   1      //      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
 566   1      //              u8 xdata log_buf[64];
 567   1      //              
 568   1      //              sprintf(log_buf, "sysTime reales result:%d.\n", (int)resultOpreat);
 569   1      //              PrintString1_logOut(log_buf);
 570   1      //      }
 571   1      #endif
 572   1              
 573   1              return resultOpreat;
 574   1      }
 575          
 576          /*zigbeeÏµÍ³Ê±¼äÉèÖÃ*///×èÈû
 577          static
 578          bit zigB_sysTimeSet(u32 timeStamp, bit timeZoneAdjust_IF){
 579   1      
 580   1              datsAttr_ZigbInit code default_param = {{0x21,0x10},{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x
             -00},0x0B,{0xFE,0x01,0x61,0x10,0x00},0x05,100}; //zigbeeÖ¸ÁîÏÂ´ïÄ¬ÈÏ²ÎÊý
 581   1              u8 xdata timeStampArray[0x0B] = {0};
 582   1              bit resultSet = 0;
 583   1              u32 timeStamp_temp = timeStamp;
 584   1              
 585   1              if(timeZoneAdjust_IF){ //ÊÇ·ñÐèÒªÊ±Çøµ÷Õû
 586   2              
 587   2                      if(sysTimeZone_H <= 12){
 588   3                      
 589   3                              timeStamp_temp += (3600UL * (long)sysTimeZone_H + 60UL * (long)sysTimeZone_M); //Ê±ÇøÕý
 590   3                              
 591   3                      }else
 592   2                      if(sysTimeZone_H > 12 && sysTimeZone_H <= 24){
 593   3                      
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 11  

 594   3                              timeStamp_temp -= (3600UL * (long)(sysTimeZone_H - 12) + 60UL * (long)sysTimeZone_M); //Ê±Çø¸º
 595   3                              
 596   3                      }else
 597   2                      if(sysTimeZone_H >= 30){
 598   3                      
 599   3                              timeStamp_temp += (3600UL * (long)(sysTimeZone_H - 17) + 60UL * (long)sysTimeZone_M); //Ê±ÇøÌØÊâ
 600   3                      }
 601   2              }
 602   1      
 603   1              timeStampArray[0] = (u8)((timeStamp_temp & 0x000000ff) >> 0);
 604   1              timeStampArray[1] = (u8)((timeStamp_temp & 0x0000ff00) >> 8);
 605   1              timeStampArray[2] = (u8)((timeStamp_temp & 0x00ff0000) >> 16);
 606   1              timeStampArray[3] = (u8)((timeStamp_temp & 0xff000000) >> 24);
 607   1              
 608   1              resultSet = zigb_VALIDA_INPUT((u8 *)default_param.zigbInit_reqCMD,
 609   1                                                                        (u8 *)timeStampArray,
 610   1                                                                        default_param.reqDAT_num,
 611   1                                                                        (u8 *)default_param.zigbInit_REPLY,
 612   1                                                                        default_param.REPLY_num,
 613   1                                                                        2,    //2´ÎÎÞ»Ø¸´ÎªÊ§°Ü
 614   1                                                                        default_param.timeTab_waitAnsr);
 615   1              
 616   1      #if(DEBUG_LOGOUT_EN == 1)       
 617   1      //      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
 618   1      //              u8 xdata log_buf[64];
 619   1      //              
 620   1      //              sprintf(log_buf, "sysTime set result:%d.\n", (int)resultSet);
 621   1      //              PrintString1_logOut(log_buf);
 622   1      //      }
 623   1      #endif
 624   1              
 625   1              return resultSet;
 626   1      }
 627          
 628          ///*zigbeeÓ²¼þ¸´Î»³õÊ¼»¯*///×èÈû
 629          //bit ZigB_resetInit(void){
 630          
 631          //#define zigbInit_loopTry              3
 632          //#define zigbInit_onceWait     5000
 633          
 634          //      u8 code initCmp_Frame[11] = {0xFE, 0x06, 0x41, 0x80, 0x01, 0x02, 0x00, 0x02, 0x06, 0x03, 0xC3};
 635          //      
 636          //      u8      loop = 0;
 637          //      u16 timeWait = 0;
 638          //      
 639          //      for(loop = 0; loop < zigbInit_loopTry; loop ++){
 640          //      
 641          //              zigbPin_RESET = 0;
 642          //              delayMs(100);
 643          //              zigbPin_RESET = 1;
 644          //              
 645          //              timeWait = zigbInit_onceWait;
 646          //              while(timeWait --){
 647          //              
 648          //                      delayMs(2);     //±ØÐëÑÓÊ±
 649          //                      if(uartRX_toutFLG){
 650          //                      
 651          //                              uartRX_toutFLG = 0;
 652          //                              
 653          //                              if(!memcmp(datsRcv_ZIGB.rcvDats, initCmp_Frame, 11)){
 654          //                              
 655          //                                      return 1;
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 12  

 656          //                                      
 657          //                              }else{
 658          //                                      
 659          //                                      delayMs(1);     //±ØÐëÑÓÊ±
 660          //                              }
 661          //                      }
 662          //              }
 663          //      }
 664          //      
 665          //      return 0;
 666          //}
 667          
 668          ///*zigbee³õÊ¼»¯×Ô¼ì*///×èÈû
 669          //bit ZigB_inspectionSelf(void){        
 670          //      
 671          //#define       paramLen_zigbInspection 64
 672          //      u8 xdata paramTX_temp[paramLen_zigbInspection] = {0};
 673          //      
 674          ////    bit REQResult = 0;
 675          //      
 676          ////    u8 code frameREQ_zigbStatusCheck[5] = {0xFE, 0x00, 0x27, 0x00, 0x27};   //zigb×´Ì¬²éÑ¯Ö¸ÁîÖ¡
 677          ////    u8 code cmdResp_zigbStatusCheck[2]      = {0x67, 0x00}; //zigb×´Ì¬²éÑ¯ÏìÓ¦Ö¸Áî
 678          //      u8 code frameREQ_zigbJoinNWK[5]         = {0xFE, 0x00, 0x26, 0x00, 0x26};       //zigb¼¤»îÍøÂçÖ¸ÁîÖ¡
 679          //      u8 code cmdResp_zigbJoinNWK[2]          = {0x45, 0xC0}; //zigb¼¤»îÍøÂçÏìÓ¦Ö¸Áî
 680          //      u8 datsResp_Len = 0;
 681          //      
 682          ////    datsResp_Len = zigb_datsRequest(frameREQ_zigbStatusCheck, 5, cmdResp_zigbStatusCheck, paramTX_temp, 2
             -, 500);
 683          ////    if(paramTX_temp[16] == 0x07)REQResult
 684          //      
 685          //      datsResp_Len = zigb_datsRequest(frameREQ_zigbJoinNWK, 5, cmdResp_zigbJoinNWK, paramTX_temp, 2, 5000);
 686          //      if(paramTX_temp[4] == 0x07)return (zigb_clusterSet(13, 13) & zigb_clusterSet(13, 14));  //Éè±¸ID 13£¬ÖÕ¶
             -Ëµã 13£»        
 687          //      else{
 688          //      
 689          //              return 0;
 690          //      }
 691          //}
 692          
 693          /*zigbee·Ç×èÈûÈëÍøÇëÇó×´Ì¬»ú*///·Ç×èÈû ---ÐÅµÀÄ¬ÈÏµÚËÄÐÅµÀ
 694          static 
 695          void zigB_nwkJoinRequest(bit reJoin_IF){
 696   1      
 697   1      #define cmdNum_zigbNwkREQ       9       
 698   1      
 699   1              datsAttr_ZigbInit code ZigbInit_dats[cmdNum_zigbNwkREQ] = {
 700   1      
 701   1                      {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      //
             -¸´Î»(Ó²¼þ)
 702   1      //              {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x00,0x02,0x00,0x02,0x06,0x03,0xC2},       0x0B,   4000    },      
             -//¸´Î»(Ìæ²¹)
 703   1                      {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      //
             -¸´Î»(Èí¼þ)
 704   1                      {       {0x26,0x05},    {0x03,0x01,0x03},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //¼Ä´æÆ÷³õÊ
             -¼»¯£¬È«²¿Çå¿Õ
 705   1                      {       {0x46,0x09},    {0},                                    0x00,   {0xFE,0x06,0x41,0x80,0x01,0x02,0x00,0x02,0x06,0x03,0xC3},       0x0B,   4000    },      //
             -¶þ´Î¸´Î»(Èí¼þ)
 706   1                      
 707   1      //              {       {0x26,0x05},    {0x87,0x01,0x00},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«ÉèÖ
             -Ã£¨Ð­µ÷Æ÷£©
 708   1                      {       {0x26,0x05},    {0x87,0x01,0x01},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«ÉèÖÃ£
             -¨Â·ÓÉÆ÷£©
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 13  

 709   1      //              {       {0x26,0x05},    {0x87,0x01,0x02},               0x03,   {0xFE,0x01,0x66,0x05,0x00,0x62},                                                        0x06,   500             },      //½ÇÉ«ÉèÖ
             -Ã£¨ÖÕ¶Ë£©
 710   1                      
 711   1                      {       {0x27,0x02},    {0xFF,0xFF},                    0x02,   {0xFE,0x01,0x67,0x02,0x00,0x64},                                                        0x06,   500             },      //PAN_ID¼Ä´æÆ÷É
             -èÖÃ
 712   1                      {       {0x27,0x03},    {0x00,0x80,0x00,0x00},  0x04,   {0xFE,0x01,0x67,0x03,0x00,0x65},                                                        0x06,   500             },      //ÐÅµÀ¼
             -Ä´æÆ÷ÅäÖÃ
 713   1      //              {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x09,0x8D},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È¶¨
             -½ÇÉ«Ð­µ÷Æ÷£¨Ð­µ÷Æ÷ÏìÓ¦£©
 714   1                      {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x07,0x83},                                                        0x06,   8000    },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È¶¨½ÇÉ
             -«Ð­µ÷Æ÷£¨Â·ÓÉÆ÷ÏìÓ¦£©
 715   1      //              {       {0x26,0x00},    {0},                                    0x00,   {0xFE,0x01,0x45,0xC0,0x06,0x82},                                                        0x06,   12000   },      //¿ªÊ¼ÈëÍø£¬ÒÔ¼È¶¨
             -½ÇÉ«Ð­µ÷Æ÷£¨ÖÕ¶ËÏìÓ¦£©
 716   1                      {       {0x26,0x08},    {0xFC,0xFF,0x00},               0x03,   {0xFE,0x01,0x66,0x08,0x00,0x6F},                                                        0x06,   150             },  //¹Ø±Õ
             -ÍøÂç
 717   1              };
 718   1              
 719   1              datsAttr_ZigbInit code defaultParam_clusterRegister = {{0x24,0x00},{0x0E,0x0D,0x00,0x0D,0x00,0x0D,0x00,0x
             -01,0x00,0x00,0x01,0x00,0x00},0x0D,{0xFE,0x01,0x64,0x00,0x00,0x65},0x06,500};  //Êý¾Ý´Ø×¢²á,Ä¬ÈÏ²ÎÊý
 720   1              u8 code frameResponseSubs_clusterRegister[6] = {0xFE,0x01,0x64,0x00,0xB8,0xDD}; //ÏìÓ¦Ö¡Ìæ²¹£¬ÈôÊý¾Ý´ØÒÑ¾
             -­×¢²á
 721   1              
 722   1      #define clusterNum_default 3
 723   1              datsAttr_clusterREG code cluster_Default[clusterNum_default] = {
 724   1              
 725   1                      {ZIGB_ENDPOINT_CTRLSECENARIO, zigbDatsDefault_ClustID}, 
 726   1                      {ZIGB_ENDPOINT_CTRLNORMAL, zigbDatsDefault_ClustID}, 
 727   1                      {ZIGB_ENDPOINT_CTRLSYSZIGB, zigbDatsDefault_ClustID}
 728   1              };
 729   1              
 730   1      #define dataLen_zigbNwkREQ 64
 731   1              u8 xdata paramTX_temp[dataLen_zigbNwkREQ] = {0};
 732   1              
 733   1              static u8 step_CortexA = 0,
 734   1                                step_CortexB = 0;
 735   1              static u8 reactionLoop = 0;
 736   1              
 737   1              u8 datsTX_Len = 0;
 738   1              
 739   1              if(devStatus_switch.statusChange_IF){ //×´Ì¬Ç¿ÖÆÇÐ»»Ê±£¬½«µ±Ç°×Ó×´Ì¬ÄÚ¾²Ì¬±äÁ¿³õÊ¼»¯ºóÔÙ½øÐÐÍâ²¿ÇÐ»»
 740   2              
 741   2                      devStatus_switch.statusChange_IF = 0;
 742   2                      devRunning_Status = devStatus_switch.statusChange_standBy;
 743   2                      
 744   2                      step_CortexA = 0;
 745   2                      step_CortexB = 0;
 746   2                      reactionLoop = 0;
 747   2                      zigbPin_RESET = 1;
 748   2                      
 749   2                      return;
 750   2              }
 751   1              
 752   1              if(step_CortexA > (cmdNum_zigbNwkREQ + clusterNum_usr + clusterNum_default)){ //ÄÚ²¿×´Ì¬Íê³É
 753   2              
 754   2                      step_CortexA = 0;
 755   2                      step_CortexB = 0;
 756   2                      reactionLoop = 0;
 757   2                      zigbPin_RESET = 1;
 758   2                      
 759   2                      sysTimeReales_counter = PERIOD_SYSTIMEREALES; //systime¸üÐÂÖÜÆÚÖØÖÃ£¬·ÀÖ¹¶àÖ¸Áî¶ÂÈû³åÍ»
 760   2                      
 761   2                      devRunning_Status = status_passiveDataRcv; //Íâ²¿×´Ì¬ÇÐ»»
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 14  

 762   2                      devTips_status = status_Normal; //Éè±¸ÏµÍ³tips×´Ì¬ÇÐ»»
 763   2                      
 764   2                      return;
 765   2              }
 766   1              
 767   1              if(!reJoin_IF)if(step_CortexA == 0)step_CortexA = 7; //ÊÇ·ñÎªÖØÐÂÖ÷¶¯¼ÓÈëÐÂÍøÂç£¬·ñÔò²»½øÐÐÓ²¼þ¸´Î»(Ó²¼þ¸
             -´Î»½«µ¼ÖÂ±¾µØÊ±¼ä±»ÖØÖÃ)
 768   1              if((step_CortexA == 7) || (step_CortexA == 0))sysTimeReales_counter     = PERIOD_SYSTIMEREALES; //·Ç×èÈû¹Ø¼üÖ
             -¸Áî²»ÄÜ±»×èÈûÖ¸Áî´ò¶Ï£¨Ó²¼þ¸´Î» ºÍ ÈëÍøÊ± ÖÐ¶Ï×èÈûÖ¸ÁîÏÂ´ï£©
 769   1              if(step_CortexA == 0){ //ÌØÊâÖ¸Áî_Ó²¼þ¸´Î»:<0>
 770   2              
 771   2                      switch(step_CortexA){
 772   3                      
 773   3                              case 0:{ //Ê×ÌõÖ¸Áî£¬Ó²¼þ¸´Î»
 774   4                              
 775   4                                      switch(step_CortexB){
 776   5                                      
 777   5                                              case 0:{ //²½ÖèÒ»£ºÓ²¼þÀ­µÍ100ms
 778   6                                              
 779   6                                                      zigbPin_RESET = 0;
 780   6                                                      zigbNwkAction_counter = 200;
 781   6                                                      step_CortexB = 1;
 782   6                                              
 783   6                                              }break;
 784   5                                      
 785   5                                              case 1:{ //²½Öè¶þ£ºÓ²¼þÀ­µÍÍê±ÏºóÈ·ÈÏÓ¦´ðÖ¡Ê±³¤
 786   6                                              
 787   6                                                      if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ý
 788   7                                                      
 789   7                                                              zigbPin_RESET = 1;
 790   7                                                              zigbNwkAction_counter = 6000;
 791   7                                                              step_CortexB = 2;
 792   7                                                      }
 793   6                                                      
 794   6                                              }break;
 795   5                                              
 796   5                                              case 2:{ //²½Öè¶þ£ºÈ·ÈÏÓ¦´ðÖ¡
 797   6                                                      
 798   6                                                      if(!zigbNwkAction_counter)step_CortexB = 0; //·Ç×èÈûµÈ´ýÏìÓ¦
 799   6                                              
 800   6                                                      if(uartRX_toutFLG){
 801   7                                                      
 802   7                                                              uartRX_toutFLG = 0;
 803   7                                                              
 804   7                                                              if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, ZigbInit_dats[0].zigbInit_REPLY, ZigbInit_dats[0].RE
             -PLY_num)){
 805   8                              
 806   8                                                                      step_CortexB = 0;
 807   8                                                                      reactionLoop = 0;
 808   8                                                                      step_CortexA ++;
 809   8                                                              }
 810   7                                                      }
 811   6                                                      
 812   6                                              }break;
 813   5                                      }
 814   4                                      
 815   4                              }break;
 816   3                      }
 817   2              }else
 818   1              if(step_CortexA > 0 && step_CortexA < cmdNum_zigbNwkREQ){ //³£¹æÖ¸Áî:<1 - 9>
 819   2                      
 820   2      //              if(!reJoin_IF)if(step_CortexA == 2)step_CortexA = 7;    //ÊÇ·ñÎªÖØÐÂÖ÷¶¯¼ÓÈëÐÂÍøÂç£¬·ñÔòÖ»½øÐÐ±»¶¯ÍøÂç¼¤»
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 15  

             -î
 821   2      
 822   2                      switch(step_CortexB){
 823   3                      
 824   3                              case 0:{
 825   4                                      
 826   4                                      if(reactionLoop > 2){
 827   5                                              
 828   5                                              reactionLoop = 0;
 829   5                                              step_CortexA = 0;
 830   5                                              break;
 831   5                                      }
 832   4                                      
 833   4                                      datsTX_Len = ZigB_TXFrameLoad(paramTX_temp, 
 834   4                                                                                                ZigbInit_dats[step_CortexA].zigbInit_reqCMD, 
 835   4                                                                                                2, 
 836   4                                                                                                ZigbInit_dats[step_CortexA].zigbInit_reqDAT, 
 837   4                                                                                                ZigbInit_dats[step_CortexA].reqDAT_num);
 838   4                                      
 839   4                                      uartZigB_datsSend(paramTX_temp, datsTX_Len);
 840   4                                      
 841   4                                      zigbNwkAction_counter = ZigbInit_dats[step_CortexA].timeTab_waitAnsr;
 842   4                                      step_CortexB = 1;
 843   4                                      
 844   4                              }break;
 845   3                                      
 846   3                              case 1:{
 847   4                                      
 848   4                                      if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ýÏìÓ¦
 849   5                                      
 850   5                                              reactionLoop ++;
 851   5                                              step_CortexB = 0;
 852   5                                      }
 853   4                                      else
 854   4                                      if(uartRX_toutFLG){
 855   5                                      
 856   5                                              uartRX_toutFLG = 0;
 857   5                                              
 858   5                                              if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, ZigbInit_dats[step_CortexA].zigbInit_REPLY, ZigbInit_d
             -ats[step_CortexA].REPLY_num)){
 859   6                                              
 860   6                                                      step_CortexB = 0;
 861   6                                                      reactionLoop = 0;
 862   6                                                      step_CortexA ++;
 863   6                                              }
 864   5                                      }
 865   4                                      
 866   4                              }break;
 867   3                      }
 868   2                      
 869   2              }else
 870   1              if(step_CortexA >= cmdNum_zigbNwkREQ){ //ÌØÊâÖ¸Áî_³£¹æÍ¨ÐÅ´Ø×¢²á:<10 - n>
 871   2                      
 872   2                      u8 datsREG_cluster[16] = {0};
 873   2                      memcpy(datsREG_cluster, defaultParam_clusterRegister.zigbInit_reqDAT, defaultParam_clusterRegister.reqDA
             -T_num);
 874   2                      if(step_CortexA < (cmdNum_zigbNwkREQ + clusterNum_default)){ //Ä¬ÈÏ×¨ÓÃÍ¨ÐÅ´Ø²ÎÊýÌî×°
 875   3                      
 876   3                              datsREG_cluster[0] = cluster_Default[step_CortexA - cmdNum_zigbNwkREQ].endpoint;
 877   3                              datsREG_cluster[3] = (u8)((cluster_Default[step_CortexA - cmdNum_zigbNwkREQ].devID & 0x00ff) >> 0);
 878   3                              datsREG_cluster[4] = (u8)((cluster_Default[step_CortexA - cmdNum_zigbNwkREQ].devID & 0xff00) >> 8);
 879   3                              
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 16  

 880   3                      }else{  //ÓÃ»§Í¨ÐÅ´Ø£¨»¥¿Ø£©×¢²á²ÎÊýÌî×°
 881   3                      
 882   3                              if((CTRLEATHER_PORT[step_CortexA - cmdNum_zigbNwkREQ - clusterNum_usr] >= 0x10) && (CTRLEATHER_PORT[ste
             -p_CortexA - cmdNum_zigbNwkREQ - clusterNum_usr] < 255)){ //Í¨ÐÅ´Ø¶Ë¿ÚºÏ·¨ÐÔÅÐ¶Ï
 883   4                              
 884   4                                      datsREG_cluster[0] = CTRLEATHER_PORT[step_CortexA - cmdNum_zigbNwkREQ - clusterNum_usr];
 885   4                                      datsREG_cluster[3] = zigbDatsDefault_ClustID; //Ä¬ÈÏ´ØID <LSB>
 886   4                                      datsREG_cluster[4] = 0; //Ä¬ÈÏ´ØID <MSB>
 887   4                                      
 888   4                              }else{
 889   4                              
 890   4                                      step_CortexA ++;
 891   4                                      return;
 892   4                              }
 893   3                      }
 894   2              
 895   2                      switch(step_CortexB){
 896   3                      
 897   3                              case 0:{
 898   4                                      
 899   4                                      if(reactionLoop > 2){
 900   5                                              
 901   5                                              reactionLoop = 0;
 902   5                                              step_CortexA = 0;
 903   5                                              break;
 904   5                                      }
 905   4                                      
 906   4                                      datsTX_Len = ZigB_TXFrameLoad(paramTX_temp, 
 907   4                                                                                                defaultParam_clusterRegister.zigbInit_reqCMD, 
 908   4                                                                                                2, 
 909   4                                                                                                datsREG_cluster, 
 910   4                                                                                                defaultParam_clusterRegister.reqDAT_num);
 911   4                                      
 912   4                                      uartZigB_datsSend(paramTX_temp, datsTX_Len);
 913   4                                      
 914   4                                      zigbNwkAction_counter = defaultParam_clusterRegister.timeTab_waitAnsr;
 915   4                                      step_CortexB = 1;
 916   4                                      
 917   4                              }break;
 918   3                                      
 919   3                              case 1:{
 920   4                                      
 921   4                                      if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ýÏìÓ¦
 922   5                                      
 923   5                                              reactionLoop ++;
 924   5                                              step_CortexB = 0;
 925   5                                      }
 926   4                                      else
 927   4                                      if(uartRX_toutFLG){
 928   5                                      
 929   5                                              uartRX_toutFLG = 0;
 930   5                                              
 931   5                                              if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, defaultParam_clusterRegister.zigbInit_REPLY, defaultPa
             -ram_clusterRegister.REPLY_num) || //Ô¤ÆÚÏìÓ¦
 932   5                                                 memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, frameResponseSubs_clusterRegister, 6)){ //Ìæ²¹ÏìÓ¦
 933   6                                              
 934   6                                                      step_CortexB = 0;
 935   6                                                      reactionLoop = 0;
 936   6                                                      step_CortexA ++;
 937   6                                              }
 938   5                                      }
 939   4                                      
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 17  

 940   4                              }break;
 941   3                      }
 942   2              }
 943   1      }
 944          
 945          /*zigbeeÍøÂçÊý¾Ý·¢ËÍ¸ñÊ½»¯Ìî×°*/
 946          static 
 947          u8 zigb_datsLoad_datsSend(u8  frame_Temp[NORMALDATS_DEFAULT_LENGTH],
 948                                                            u16 DstAddr,
 949                                                            u8  portPoint,
 950                                                            u8  dats[],
 951                                                            u8  datsLen){
 952   1              
 953   1              u8 code zigbCMD_DatsSend[2] = {0x24, 0x01};
 954   1              
 955   1      #define zigbDatsSend_datsTransLen       72
 956   1              u8 xdata buf_datsLOAD[zigbDatsSend_datsTransLen] = {0};
 957   1              u8 datsTX_Len = 0;
 958   1                                                                
 959   1              memset(frame_Temp, 0, NORMALDATS_DEFAULT_LENGTH * sizeof(u8));  
 960   1      
 961   1              //·¢ËÍÖ¡Ìî×°
 962   1              buf_datsLOAD[0] = (u8)((DstAddr & 0x00ff) >> 0);
 963   1              buf_datsLOAD[1] = (u8)((DstAddr & 0xff00) >> 8);
 964   1              buf_datsLOAD[2] = portPoint;
 965   1              buf_datsLOAD[3] = portPoint;
 966   1              buf_datsLOAD[4] = zigbDatsDefault_ClustID;
 967   1              buf_datsLOAD[6] = zigbDatsDefault_TransID;
 968   1              buf_datsLOAD[7] = zigbDatsDefault_Option;
 969   1              buf_datsLOAD[8] = zigbDatsDefault_Radius;
 970   1              buf_datsLOAD[9] = datsLen;
 971   1              memcpy(&buf_datsLOAD[10], dats, datsLen);       
 972   1              
 973   1              return ZigB_TXFrameLoad(frame_Temp, (u8 *)zigbCMD_DatsSend, 2, buf_datsLOAD, datsLen + 10);
 974   1      }
 975          
 976          /*zigbeeÎÞÊÓÏìÓ¦»Ø¸´Ö±½Ó·¢ËÍÊý¾Ý*///×èÈû
 977          static
 978          void dataSendRemote_straightforward( u16 DstAddr, //Ô¶¶ËÍøÂç¶ÌµØÖ·
 979                                                                                    u8 port,       //¶Ëµã¿Ú
 980                                                                                    u8 dats[], //Êý¾Ý
 981                                                                                    u8 datsLen ){ //Êý¾Ý³¤¶È
 982   1                                                                                                                                                
 983   1              u8 xdata buf_datsTX[NORMALDATS_DEFAULT_LENGTH] = {0};
 984   1              u8 datsTX_Len = 0;
 985   1              
 986   1              datsTX_Len = zigb_datsLoad_datsSend(buf_datsTX, DstAddr, port, dats, datsLen);
 987   1              
 988   1              uartZigB_datsSend(buf_datsTX, datsTX_Len);
 989   1      }
 990          
 991          /*zigbeeÍøÂçÊý¾Ý·¢ËÍÇëÇó×´Ì¬»ú*///·Ç×èÈû
 992          static
 993          void dataTransRequest_datsSend(void){
 994   1      
 995   1              u8 xdata buf_datsTX[NORMALDATS_DEFAULT_LENGTH] = {0};
 996   1              u8 datsTX_Len = 0;
 997   1              
 998   1      #define zigbDatsSend_datsRespLen        64
 999   1              u8 xdata buf_datsRX[zigbDatsSend_datsRespLen] = {0};
1000   1              u8 datsRX_Len = 0;
1001   1              
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 18  

1002   1      #define zigbDatsSend_ASR_datsLen        3
1003   1              u8              ASR_dats[zigbDatsSend_ASR_datsLen] = {0};
1004   1              u8 code ASR_cmd[2] = {0x44,0x80};       //±¾µØZNPÐ­Òé²ãÈ·ÈÏ·¢ËÍÏìÓ¦
1005   1              
1006   1      #define resCODE_datsSend_NOROUTER 0xCD  //Êý¾Ý·¢ËÍÐ­Òé²ãÏìÓ¦´úÂë-Â·ÓÉÊ§Áª£¬Í¨Ñ¶Ã½½é¶ªÊ§
1007   1      #define resCODE_datsSend_NOREMOTE 0xE9  //Êý¾Ý·¢ËÍÐ­Òé²ãÏìÓ¦´úÂë-¶Ô·½²»ÔÚÏß£¬Ä¿±êµØÖ·½ÚµãÉè±¸²»´æÔÚ
1008   1      #define resCODE_datsSend_TIMEOUT  0x01  //Êý¾Ý·¢ËÍÐ­Òé²ãÏìÓ¦´úÂë-·¢ËÍ³¬Ê±
1009   1      #define resCODE_datsSend_SUCCESS  0x00  //Êý¾Ý·¢ËÍÐ­Òé²ãÏìÓ¦´úÂë-·¢ËÍ³É¹¦
1010   1              static u8 datsTrans_respondCode = 0; //·¢ËÍÍê³ÉÏìÓ¦Âë
1011   1              
1012   1              static u8 step = 0;
1013   1              static u8 reactionLoop = 0;
1014   1              
1015   1              if(devStatus_switch.statusChange_IF){   //×´Ì¬Ç¿ÖÆÇÐ»»Ê±£¬½«µ±Ç°×Ó×´Ì¬ÄÚ¾²Ì¬±äÁ¿³õÊ¼»¯ºóÔÙ½øÐÐÍâ²¿ÇÐ»»
1016   2              
1017   2                      devStatus_switch.statusChange_IF = 0;
1018   2                      devRunning_Status = devStatus_switch.statusChange_standBy;
1019   2                      
1020   2                      step = 0;
1021   2                      reactionLoop = 0;
1022   2                      
1023   2                      return;
1024   2              }
1025   1              
1026   1              //½ÓÊÕÖ¡Ìî×°_±¾µØ
1027   1              ASR_dats[0] = resCODE_datsSend_SUCCESS; //·¢ËÍ³É¹¦ÏìÓ¦´úÂë
1028   1              ASR_dats[1] = datsSend_request.portPoint;
1029   1              ASR_dats[2] = zigbDatsDefault_TransID;
1030   1              datsRX_Len = ZigB_TXFrameLoad(buf_datsRX, (u8 *)ASR_cmd, 2, ASR_dats, zigbDatsSend_ASR_datsLen);
1031   1              
1032   1              datsTX_Len = zigb_datsLoad_datsSend(buf_datsTX, datsSend_request.nwkAddr, datsSend_request.portPoint, dat
             -sSend_request.datsTrans.dats, datsSend_request.datsTrans.datsLen);
1033   1              
1034   1              switch(step){
1035   2              
1036   2                      case 0:{ //ÏìÓ¦½ÓÊÕ¾ÍÐ÷£¬ÉèÖÃÏìÓ¦Ê±¼ä
1037   3                              
1038   3                              if(reactionLoop > 3){ //ÖØ·¢´ÎÊýÒÑ³¬³ö
1039   4                                      
1040   4                                      datsTrans_respondCode = resCODE_datsSend_TIMEOUT; //ÏìÓ¦Âë¸ÄÎª³¬Ê±
1041   4                                      
1042   4                                      reactionLoop = 0;
1043   4                                      step = 4;
1044   4                                      
1045   4                                      break;
1046   4                              }
1047   3                      
1048   3                              zigbPin_RESET = 1; //±£ÏÕÆð¼û£¬¸´Î»À­¸ß
1049   3                              uartZigB_datsSend(buf_datsTX, datsTX_Len);
1050   3                              zigbNwkAction_counter = 1000; //Ä¬ÈÏÐ­Òé²ãÏìÓ¦Ê±¼ä<Ê±¼äÌ«¶ÌÎÞ·¨ÊÕµ½ºóÃæµÄ½ÓÊÕ×´Ì¬ÏìÓ¦Ö¸Áî£¬Ö»ÄÜÊÕµ½ÏµÍ³
             -ÏìÓ¦>
1051   3                              step = 1;
1052   3                              
1053   3                      }break;
1054   2                      
1055   2                      case 1:{ //·Ç×èÈûµÈ´ýÏµÍ³ÏìÓ¦
1056   3                      
1057   3                              if(!zigbNwkAction_counter){
1058   4                              
1059   4                                      reactionLoop ++;
1060   4                                      step = 0;
1061   4                              }
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 19  

1062   3                              else{
1063   4                                      
1064   4                                      if(uartRX_toutFLG){
1065   5                                      
1066   5                                              uartRX_toutFLG = 0;
1067   5      
1068   5                                              if(memmem(datsRcv_ZIGB.rcvDats, COM_RX1_Lenth, buf_datsRX, datsRX_Len)){ //Ó¦´ðÖ¸ÁîºÍÓ¦´ðÂë¶¼ÕýÈ·
1069   6                                              
1070   6                                                      if(datsRcv_respond.datsTrans.datsLen == 0){
1071   7                                                      
1072   7                                                              step = 3;
1073   7                                                              
1074   7                                                      }else{
1075   7                                                      
1076   7                                                              step = 2;
1077   7                                                              zigbNwkAction_counter = 500; //Ä¬ÈÏÔ¶¶ËÏìÓ¦Ê±¼ä<¶Ô·½½ÚµãÏìÓ¦>
1078   7                                                      }
1079   6                                                      
1080   6                                              }else{  
1081   6                                                      
1082   6                                                      if(!memcmp(&datsRcv_ZIGB.rcvDats[2], ASR_cmd, 2)){ //Ó¦´ðÖ¸ÁîÕýÈ·£¬µ«Ó¦´ðÂë´íÎó£¬ÔòÈ¡³ö´íÎóÂë
1083   7                                                      
1084   7                                                              datsTrans_respondCode = datsRcv_ZIGB.rcvDats[4]; //´íÎóÏìÓ¦Âë×°ÔØ
1085   7                                                              step = 4; //ÓÐÓ¦´ðÖ¸Áî£¬µ«Ó¦´ðÊý¾Ý´íÎó£¬ÌøÖÁÊ§°Ü²½Öè
1086   7                                                      }
1087   6                                                      
1088   6      //#if(DEBUG_LOGOUT_EN == 1)
1089   6      //                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1090   6      //                                                      u8 xdata log_buf[64]; //Êý¾Ý´«ÊäÊ§°ÜÐ­Òé²ãÏìÓ¦´úÂë´òÓ¡
1091   6      //                                                      
1092   6      //                                                      sprintf(log_buf, "dats_TX fail code: %02X %02X %02X.\n", (int)datsRcv_ZIGB.rcvDats[2], (int)datsR
             -cv_ZIGB.rcvDats[3], (int)datsRcv_ZIGB.rcvDats[4]);
1093   6      //                                                      PrintString1_logOut(log_buf);
1094   6      //                                              }       
1095   6      //#endif                                
1096   6                                              }
1097   5                                      }
1098   4                              }
1099   3                              
1100   3                      }break;
1101   2                      
1102   2                      case 2:{ //·Ç×èÈûµÈ´ýÔ¶¶ËÏìÓ¦
1103   3      
1104   3                              if(!zigbNwkAction_counter){
1105   4                              
1106   4                                      reactionLoop ++;
1107   4                                      step = 0;
1108   4                              }
1109   3                              else{
1110   4                                      
1111   4                                      if(uartRX_toutFLG){
1112   5                                              
1113   5                                              u16 idata datsFrom_addr = ((u16)(datsRcv_ZIGB.rcvDats[9]) << 8) | ((u16)(datsRcv_ZIGB.rcvDats[8]) << 
             -0); //Êý¾Ý·¢ËÍ·½ÍøÂçµØÖ·
1114   5                                              u8      idata dstPoint =  datsRcv_ZIGB.rcvDats[11];     //Ô¶¶Ë  
1115   5                                              
1116   5                                              uartRX_toutFLG = 0;
1117   5      
1118   5                                              if(!memcmp(&(datsRcv_ZIGB.rcvDats[21]), datsRcv_respond.datsTrans.dats, datsRcv_respond.datsTrans.dat
             -sLen) && 
1119   5                                                 (datsRcv_respond.nwkAddr == datsFrom_addr) &&
1120   5                                                      (datsRcv_respond.portPoint == dstPoint)){
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 20  

1121   6                                              
1122   6                                                      step = 3;
1123   6                                                              
1124   6                                              }else{
1125   6                                              
1126   6      #if(DEBUG_LOGOUT_EN == 1)
1127   6                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1128   7                                                              u8 xdata log_buf[64]; //Êý¾Ý´«ÊäÊ§°ÜÐ­Òé²ãÏìÓ¦´úÂë´òÓ¡
1129   7                                                              
1130   7      //                                                      sprintf(log_buf, "data remoteRcv is %02X %02X %02X.\n", (int)datsRcv_ZIGB.rcvDats[21], (int)datsR
             -cv_ZIGB.rcvDats[22], (int)datsRcv_ZIGB.rcvDats[23]);
1131   7                                                              sprintf(log_buf, "rcvPort is %02X, rcvNwkAddr is %04X.\n", (int)dstPoint, (int)datsFrom_addr);
1132   7      //                                                      sprintf(log_buf, "rcvPort is %02X, rcvNwkAddr is %04X.\n", (int)datsRcv_respond.portPoint, (int)d
             -atsRcv_respond.nwkAddr);
1133   7                                                              PrintString1_logOut(log_buf);
1134   7                                                      }       
1135   6      #endif  
1136   6                                              }
1137   5                                      }
1138   4                              }
1139   3                              
1140   3                      }break;
1141   2                      
1142   2                      case 3:{ //ÏìÓ¦³É¹¦
1143   3                      
1144   3                              if(reConnectAfterDatsReq_IF){ //Õë¶Ô¼´¿Ì×¢²á»¥¿ØÌØÊâÇé¿ö ×´Ì¬ÇÐ»»
1145   4                              
1146   4                                      reConnectAfterDatsReq_IF = 0;
1147   4                                      devRunning_Status = status_nwkReconnect;
1148   4                                      
1149   4                              }else{ 
1150   4                              
1151   4                                      devRunning_Status = status_passiveDataRcv;
1152   4                              }
1153   3                              
1154   3                              reactionLoop = 0;
1155   3                              step = 0;
1156   3                              
1157   3                      }break;
1158   2                      
1159   2                      case 4:{ //ÏìÓ¦Ê§°Ü
1160   3                      
1161   3                              if(reConnectAfterDatsReq_IF){ //Õë¶Ô¼´¿Ì×¢²á»¥¿ØÌØÊâÇé¿ö ×´Ì¬ÇÐ»»
1162   4                              
1163   4                                      reConnectAfterDatsReq_IF = 0;
1164   4                                      devRunning_Status = status_nwkReconnect;
1165   4                                      
1166   4                              }else{ 
1167   4                              
1168   4                                      devRunning_Status = status_passiveDataRcv;
1169   4                              }
1170   3                              
1171   3                              //Õë¶ÔÊý¾Ý´«ÊäÊ§°ÜÏìÓ¦´úÂëÇé¿ö½øÐÐÑ¡ÔñÐÔÖØÁ¬£¬·ñÔò½öÊ±ÇøÐ­µ÷Æ÷Éè±¸¾Ígg
1172   3                              if(datsTrans_respondCode){ 
1173   4                                      
1174   4      #if(DEBUG_LOGOUT_EN == 1)                               
1175   4                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1176   5                                              u8 xdata log_buf[64];
1177   5                                              
1178   5                                              sprintf(log_buf, "remote dataRequest fail, code:[0x%02X].\n", (int)datsTrans_respondCode);
1179   5                                              PrintString1_logOut(log_buf);
1180   5                                      }
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 21  

1181   4      #endif  
1182   4                                      
1183   4                                      switch(datsTrans_respondCode){ //ÏìÓ¦Ê§°ÜÂë·ÖÎö
1184   5                                      
1185   5                                              case resCODE_datsSend_NOROUTER:
1186   5                                              case resCODE_datsSend_NOREMOTE:
1187   5                                              case resCODE_datsSend_SUCCESS:{
1188   6                                              
1189   6                                                      devTips_nwkZigb = nwkZigb_outLine; //ÔÝÊ±Ö»×öÊ§°ÜÌáÊ¾£¬²»×öÆäËû¶¯×÷
1190   6                                                      
1191   6                                              }break;
1192   5                                              
1193   5                                              default:{
1194   6                                              
1195   6                                                      devTips_nwkZigb = nwkZigb_outLine; //ÔÝÊ±Ö»×öÊ§°ÜÌáÊ¾£¬²»×öÆäËû¶¯×÷
1196   6                                                      
1197   6                                              }break;
1198   5                                      }
1199   4                                      
1200   4                                      datsTrans_respondCode = 0;
1201   4                              }
1202   3                              
1203   3                              reactionLoop = 0;
1204   3                              step = 0;
1205   3                              
1206   3                      }break;
1207   2                              
1208   2                      default:{
1209   3                      
1210   3                              step = 4;
1211   3                              
1212   3                      }break;
1213   2              }
1214   1      }
1215          
1216          /*Éè±¸Êý¾Ý´«ÊäÖ÷×´Ì¬ÇÐ»»ÖÁÍøÂç¹ÒÆð*/
1217          void devStatusChangeTo_devHold(bit zigbNwkSysNote_IF){ //Éè±¸ÍøÂç¹ÒÆð
1218   1      
1219   1              devNwkHoldTime_Param.devHoldTime_counter = DEVHOLD_TIME_DEFAULT;
1220   1              if(zigbNwkSysNote_IF)devNwkHoldTime_Param.zigbNwkSystemNote_IF = 1;
1221   1              
1222   1              devStatus_switch.statusChange_standBy = status_devNwkHold; //Êý¾Ý´«Êä×´Ì¬»ú¸ü±ä
1223   1              devStatus_switch.statusChange_IF = 1;
1224   1              
1225   1              devTips_status = status_devHold; //tips¸ü±ä
1226   1              
1227   1      #if(DEBUG_LOGOUT_EN == 1)                               
1228   1              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1229   2                      u8 xdata log_buf[64];
1230   2                      
1231   2                      sprintf(log_buf, "devHold start right now.\n");
1232   2                      PrintString1_logOut(log_buf);
1233   2              }
1234   1      #endif  
1235   1      }
1236          
1237          /*Éè±¸ÍøÂç¹ÒÆðÍ£Ö¹£¬Ê¹ÌáÇ°½áÊø*/
1238          void devHoldStop_makeInAdvance(void){ //Í£Ö¹Éè±¸ÍøÂç¹ÒÆð£¨ÌáÇ°£©
1239   1      
1240   1              if(devNwkHoldTime_Param.devHoldTime_counter)devNwkHoldTime_Param.devHoldTime_counter = 0;
1241   1      }
1242          
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 22  

1243          /*zigbeeÉè±¸ÍøÂç¹ÒÆð×´Ì¬»ú*///·Ç×èÈû
1244          static 
1245          void function_devNwkHold(void){
1246   1              
1247   1              static status_Step = 0; //µ±Ç°×´Ì¬»ú²½Öè×´Ì¬Ö¸Ê¾
1248   1              
1249   1              if(devNwkHoldTime_Param.devHoldTime_counter){ //Ö±µ½¹ÒÆðÊ±¼ä½áÊø
1250   2              
1251   2                      if(devNwkHoldTime_Param.zigbNwkSystemNote_IF){ //Í¨Öªµ±Ç°ÍøÂçÄÚ×ÓÉè±¸¹ÒÆð,±¨Ò»´Î
1252   3                              
1253   3                              u8 xdata dats_Note[3] = {ZIGB_SYSCMD_DEVHOLD, 1, 0}; //ÃüÁî¡¢Êý¾Ý³¤¶È¡¢Êý¾Ý
1254   3                      
1255   3                              devNwkHoldTime_Param.zigbNwkSystemNote_IF = 0; //Í¨ÖªÊ¹ÄÜ¸´Î»
1256   3                              
1257   3                              dataSendRemote_straightforward( 0xFFFF, //¹ã²¥Í¨ÖªÍøÄÚËùÓÐ×ÓÉè±¸¹ÒÆð
1258   3                                                                                              ZIGB_ENDPOINT_CTRLSYSZIGB,
1259   3                                                                                              dats_Note,
1260   3                                                                                              3 );
1261   3                              
1262   3                              delayMs(50); //±ØÐèÑÓÊ±£¬·ñÔòÊý¾Ý»¹Ã»·¢ËÍ³öÈ¥£¬¾ÍÅÜµ½ÏÂÒ»²½¸´Î»ÁË
1263   3                      }
1264   2                      
1265   2                      { //Éè±¸¹ÒÆð,Ñ­»·¸´Î»
1266   3                              
1267   3                              switch(status_Step){
1268   4                              
1269   4                                      case 0:{ //¸´Î»200ms
1270   5                                      
1271   5                                              zigbPin_RESET = 0;
1272   5                                              zigbNwkAction_counter = 200;
1273   5                                              status_Step = 1;
1274   5                                      
1275   5                                      }break;
1276   4                                              
1277   4                                      case 1:{ //Ã¿6s¸´Î»Ò»´Î
1278   5                                      
1279   5                                              if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ý
1280   6                                              
1281   6                                                      zigbPin_RESET = 1;
1282   6                                                      zigbNwkAction_counter = 6000;
1283   6                                                      status_Step = 2;
1284   6                                              }
1285   5                                      
1286   5                                      }break;
1287   4                                      
1288   4                                      case 2:{
1289   5                                      
1290   5                                              if(!zigbNwkAction_counter){ //·Ç×èÈûµÈ´ý
1291   6                                              
1292   6                                                      status_Step = 0;
1293   6                                                      
1294   6      #if(DEBUG_LOGOUT_EN == 1)                               
1295   6                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1296   7                                                              u8 xdata log_buf[64];
1297   7                                                              
1298   7                                                              sprintf(log_buf, "devHold time count remind: %02d s.\n", (int)devNwkHoldTime_Param.devHoldTime_coun
             -ter);
1299   7                                                              PrintString1_logOut(log_buf);
1300   7                                                      }
1301   6      #endif
1302   6                                              }
1303   5                                      
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 23  

1304   5                                      }break;
1305   4                                      
1306   4                                      default:{
1307   5                                              
1308   5                                              status_Step = 0;
1309   5                                              
1310   5                                      }break;
1311   4                              }
1312   3                      }
1313   2      
1314   2              }else{
1315   2              
1316   2                      //¹ÒÆðÊ±¼ä½áÊø,Ö÷×´Ì¬»Ö¸´ÖÁÖØÁ¬£¬±¾µØ×´Ì¬»Ö¸´
1317   2                      status_Step = 0;
1318   2                      zigbPin_RESET = 1;
1319   2                      
1320   2                      devRunning_Status = status_nwkReconnect; //Ö±½Ó½«Ö÷×´Ì¬ÇÐ»»ÖÁÍøÂçÖØÁ¬,²»×ßstandbyÁ÷³Ì
1321   2                      devTips_status = status_Normal; //tips¸ü±ä
1322   2              
1323   2      #if(DEBUG_LOGOUT_EN == 1)                               
1324   2                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1325   3                              u8 xdata log_buf[64];
1326   3                              
1327   3                              sprintf(log_buf, "devHold stop.\n");
1328   3                              PrintString1_logOut(log_buf);
1329   3                      }
1330   2      #endif  
1331   2              }
1332   1      }
1333          
1334          /*zigbee¼¯Èº¿ØÖÆÊý¾Ý½âÎö*/
1335          static 
1336          void dataParing_scenarioCtrl(u8 datsFrame[]){
1337   1      
1338   1              swCommand_fromUsr.objRelay = datsFrame[0]; //¼ÌµçÆ÷ÏìÓ¦¼´¿É
1339   1              swCommand_fromUsr.actMethod = relay_OnOff;
1340   1              
1341   1              colonyCtrlGet_statusLocalScene = datsFrame[0]; //±¾µØ³¡¾°¿ØÖÆÂÖÑ¯Öµ¸üÐÂ(³¡¾°¿ØÖÆ½öÀ´×ÔÓÚÊÖ»ú¿ØÖÆ)
1342   1              
1343   1      #if(DEBUG_LOGOUT_EN == 1)
1344   1              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1345   2                      u8 xdata log_buf[64];
1346   2                      
1347   2                      sprintf(log_buf, "cmdScenarioCtrl comming, statusData:%02X.\n", (int)datsFrame[0]);
1348   2                      PrintString1_logOut(log_buf);
1349   2              }                       
1350   1      #endif          
1351   1      }
1352          
1353          /*zigbeeÏµÍ³½»»¥Êý¾Ý½âÎö*/
1354          static 
1355          void dataParing_zigbSysCtrl(u8 datsFrame[]){
1356   1      
1357   1              /*>>>>>>>>>>>>>>frame reference<<<<<<<<<<<<<<<<<*/
1358   1              /*----------------------------------------------*/
1359   1              /*  frame_CMD   |       frame_dataLen|  frame_data      |
1360   1              /*----------------------------------------------*/
1361   1              /*      1byte           |       1byte            |      < 256byte       |       
1362   1              /*----------------------------------------------*/
1363   1              
1364   1              frame_zigbSysCtrl xdata dats = {0};
1365   1              
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 24  

1366   1              dats.command = datsFrame[0];
1367   1              memcpy(dats.dats, &datsFrame[2], datsFrame[1]);
1368   1              dats.datsLen = datsFrame[1];
1369   1              
1370   1              switch(dats.command){
1371   2              
1372   2                      case ZIGB_SYSCMD_NWKOPEN:{ //ÍøÂç¿ª·Å
1373   3                              
1374   3                              bit resultSet = 0;
1375   3                              
1376   3                              resultSet = ZigB_nwkOpen(1, dats.dats[0]); //¹¦ÄÜ´¥·¢
1377   3                              tips_statusChangeToZigbNwkOpen(ZIGBNWK_OPNETIME_DEFAULT); //tips´¥·¢
1378   3                              
1379   3      #if(DEBUG_LOGOUT_EN == 1)
1380   3                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1381   4                                      u8 xdata log_buf[64];
1382   4                                      
1383   4                                      sprintf(log_buf, "master cmdComing:nwkOpen:%02ds.\n", (int)dats.dats[0]);
1384   4                                      PrintString1_logOut(log_buf);
1385   4                              }                       
1386   3      #endif          
1387   3                              
1388   3                      }break;
1389   2                      
1390   2                      case ZIGB_SYSCMD_TIMESET:{ //ÏµÍ³Ê±¼äÉè¶¨
1391   3                      
1392   3                              bit resultSet = 0;
1393   3                              bit timeZoneAdjust_needIF = 0;
1394   3                              u32 time_Temp = 0UL;
1395   3                              
1396   3                              time_Temp |= (u32)dats.dats[0] << 0;
1397   3                              time_Temp |= (u32)dats.dats[1] << 8;
1398   3                              time_Temp |= (u32)dats.dats[2] << 16;
1399   3                              time_Temp |= (u32)dats.dats[3] << 24;
1400   3                              if((sysTimeZone_H != dats.dats[4]) || (sysTimeZone_M != dats.dats[5])){ //Ê±ÇøÍ¬²½
1401   4                              
1402   4                                      sysTimeZone_H = dats.dats[4];
1403   4                                      sysTimeZone_M = dats.dats[5];
1404   4                                      coverEEPROM_write_n(EEPROM_ADDR_timeZone_H, &sysTimeZone_H, 1);
1405   4                                      coverEEPROM_write_n(EEPROM_ADDR_timeZone_M, &sysTimeZone_M, 1);
1406   4                              }
1407   3                              
1408   3                              if(dats.dats[6])timeZoneAdjust_needIF = 1; //Ê±Çø²¹³¥Ê¹ÄÜÅÐ¶Ï
1409   3                              if(time_Temp > ZIGB_UTCTIME_START)resultSet = zigB_sysTimeSet(time_Temp - ZIGB_UTCTIME_START, timeZoneA
             -djust_needIF); //zigbee ±¾µØÏµÍ³Ê±¼äÉèÖÃ<UTC¸º²¹³¥>
1410   3                              
1411   3      #if(DEBUG_LOGOUT_EN == 1)
1412   3                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1413   4                                      u8 xdata log_buf[64];
1414   4                                      
1415   4                                      sprintf(log_buf, "master UTC coming:[0x%02X%02X%02X%02X].\n", (int)dats.dats[3], (int)dats.dats[2], (i
             -nt)dats.dats[1], (int)dats.dats[0]);
1416   4                                      PrintString1_logOut(log_buf);
1417   4                              }                       
1418   3      #endif  
1419   3                      }break;
1420   2                      
1421   2                      case ZIGB_SYSCMD_DEVHOLD:{ //ÍøÂç¿ª·Å£¨ÓÃ×÷Íø¹ØÇÐ»»£©
1422   3                              
1423   3      #if(DEBUG_LOGOUT_EN == 1)
1424   3                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1425   4                                      u8 xdata log_buf[64];
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 25  

1426   4                                      
1427   4                                      sprintf(log_buf, "node cmdComing:devNwk hold.\n");
1428   4                                      PrintString1_logOut(log_buf);
1429   4                              }                       
1430   3      #endif  
1431   3                              devStatusChangeTo_devHold(0); //Éè±¸ÍøÂç±»¶¯¹ÒÆð,²»½øÐÐÍøÂçÍ¨Öª
1432   3                              
1433   3                      }break;
1434   2                      
1435   2                      case ZIGB_SYSCMD_COLONYPARAM_REQPERIOD:{
1436   3                      
1437   3                              /*>>>>>>>>>>>>>>>>>>>frame_data reference<<<<<<<<<<<<<<<*/
1438   3                              /*------------------------------------------------------*/
1439   3                              /*  frame_data[0]                       |       frame_data[1...3]               |
1440   3                              /*------------------------------------------------------*/
1441   3                              /*      ×î½üÒ»´Î³¡¾°¿ØÖÆ×´Ì¬Öµ  |       ×î½üÒ»´Î»¥¿Ø¸üÐÂ×´Ì¬Öµ  |
1442   3                              /*------------------------------------------------------*/
1443   3                              
1444   3                              u8 idata statusRelay_temp = status_Relay; //¿ª¹Ø¶¯×÷Ö´ÐÐ»º´æ
1445   3                              
1446   3      //#if(DEBUG_LOGOUT_EN == 1)
1447   3      //                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1448   3      //                                      u8 xdata log_buf[64];
1449   3      //                                      
1450   3      //                                      sprintf(log_buf, "curRealy_Val:%02X, dataQuery result:%02X %02X %02X %02X.\n",
1451   3      //                                                                       (int)status_Relay,
1452   3      //                                                                       (int)dats.dats[0],
1453   3      //                                                                       (int)dats.dats[1],
1454   3      //                                                                       (int)dats.dats[2],
1455   3      //                                                                       (int)dats.dats[3]);
1456   3      //                                      PrintString1_logOut(log_buf);
1457   3      //                              }                       
1458   3      //#endif                
1459   3                              if(dats.dats[0] != colonyCtrlGet_statusLocalScene){ //³¡¾°×´Ì¬ÖµÂÖÑ¯¸üÐÂ
1460   4                              
1461   4      #if(DEBUG_LOGOUT_EN == 1)
1462   4                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1463   5                                              u8 xdata log_buf[64];
1464   5                                              
1465   5                                              sprintf(log_buf, "differ scene detect from poling.\n");
1466   5                                              PrintString1_logOut(log_buf);
1467   5                                      }                       
1468   4      #endif  
1469   4                                      
1470   4                                      //ÉÏÒ»´Î³¡¾°¿ØÖÆÈôÃ»ÓÐÊÕµ½£¬Ôò½øÐÐ²¹³¥²Ù×÷
1471   4                                      colonyCtrlGet_statusLocalScene = dats.dats[0];
1472   4                                      
1473   4                                      if(colonyCtrlGet_statusLocalScene <= 0x07){ //3bitÒÔÄÚ²Ù×÷ÎªÓÐÐ§Öµ£¬±ãÓÚ³õÊ¼»¯²Ù×÷Å×ÆúÎÞÐ§Öµ
1474   5                                      
1475   5                                              swCommand_fromUsr.actMethod = relay_OnOff;
1476   5                                              swCommand_fromUsr.objRelay = colonyCtrlGet_statusLocalScene;
1477   5                                      }
1478   4                              }
1479   3                              
1480   3                              if(memcmp(&dats.dats[1], colonyCtrlGet_statusLocalEaCtrl, clusterNum_usr)){ //»¥¿Ø×´Ì¬ÖµÖµÂÖÑ¯¸üÐÂ
1481   4                                      
1482   4                                      u8 idata loop;
1483   4                                      
1484   4      #if(DEBUG_LOGOUT_EN == 1)
1485   4                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1486   5                                              u8 xdata log_buf[64];
1487   5                                              
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 26  

1488   5                                              sprintf(log_buf, "differ eachCtrl detect from poling, currentVal is: %02X %02X %02X.\n", (int)colonyC
             -trlGet_statusLocalEaCtrl[0],
1489   5                                                                                                                                                                                                                               (int)colonyCtrlGet_statusLocalEaCtrl[1],
1490   5                                                                                                                                                                                                                               (int)colonyCtrlGet_statusLocalEaCtrl[2]);
1491   5                                              PrintString1_logOut(log_buf);
1492   5                                      }                       
1493   4      #endif
1494   4                                      //ÉÏÒ»´Î»¥¿ØÈôÃ»ÓÐÊÕµ½£¬Ôò½øÐÐ²¹³¥²Ù×÷
1495   4                                      memcpy(colonyCtrlGet_statusLocalEaCtrl, &dats.dats[1], clusterNum_usr);
1496   4                                      
1497   4                                      for(loop = 0; loop < clusterNum_usr; loop ++){ //ÑÚÂëÅÐ¶Ï²Ù×÷Î»£¬±ãÓÚ³õÊ¼»¯²Ù×÷Å×ÆúÎÞÐ§Öµ
1498   5                                      
1499   5                                              if(colonyCtrlGet_statusLocalEaCtrl[loop] == STATUSLOCALEACTRL_VALMASKRESERVE_ON)statusRelay_temp |= (
             -1 << loop);
1500   5                                              if(colonyCtrlGet_statusLocalEaCtrl[loop] == STATUSLOCALEACTRL_VALMASKRESERVE_OFF)statusRelay_temp &= 
             -~(1 << loop);
1501   5                                              
1502   5                                              swCommand_fromUsr.actMethod = relay_OnOff;
1503   5                                              swCommand_fromUsr.objRelay = statusRelay_temp;
1504   5                                      }
1505   4                              }
1506   3                              
1507   3                      }break;
1508   2                              
1509   2                      default:break;
1510   2              }
1511   1      }
1512          
1513          /*zigbee³£¹æ¿ØÖÆ×ª·¢Êý¾Ý½âÎö*/
1514          static 
1515          void dataParing_Nomal(u8 datsParam[], u16 nwkAddr_from, u8 port_from){
1516   1              
1517   1      #define dataLen_dataParingNomal 96
1518   1              u8 xdata paramTX_temp[dataLen_dataParingNomal] = {0};
1519   1              
1520   1              bit dataFromRemote_IF = 0;      //ÊÇ·ñÎª·þÎñÆ÷¶ËÊý¾Ý±êÖ¾
1521   1      
1522   1              /*²úÆ·¶þ¼¶Ð­ÒéºË¶Ô_³£¹æ¿ØÖÆ*///¿ØÖÆÏÂ´ï
1523   1              switch(datsParam[0]){
1524   2              
1525   2                      /*Ô¶¶Ë*/
1526   2                      case ZIGB_FRAMEHEAD_CTRLREMOTE:{
1527   3                              
1528   3                              dataFromRemote_IF = 1;
1529   3                              
1530   3                              memcpy(MAC_ID_DST, &datsParam[7], 6);
1531   3                              memcpy(&datsParam[1], &datsParam[13], datsRcv_ZIGB.rcvDats[20] - 13);
1532   3                      }
1533   2                      
1534   2                      /*±¾µØ*/
1535   2                      case ZIGB_FRAMEHEAD_CTRLLOCAL:{
1536   3                              
1537   3                              bit frameCheck_Done = 0; //Êý¾Ý¼ì²âºÏ¸ñ±êÖ¾
1538   3                              
1539   3                              {
1540   4                                      bit frameCodeCheck_PASS = 0; //Ð£ÑéÂë¼ì²éÍ¨¹ý±êÖ¾
1541   4                                      bit frameMacCheck_PASS  = 0; //macµØÖ·´ý¼ì²éÍ¨¹ý±êÖ¾
1542   4                                      
1543   4                                      if(datsParam[4] == frame_Check(&datsParam[5], 28))frameCodeCheck_PASS = 1; //Ð£ÑéÂë¼ì²â
1544   4                                      if(!memcmp(&datsParam[5], &MAC_ID[1], 5))frameMacCheck_PASS = 1; //MAC¼ì²â
1545   4      
1546   4                                      if(datsParam[3] == FRAME_MtoZIGBCMD_cmdConfigSearch){ //ÌØÊâÖ¸Áî²»×öMAC¼ì²â
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 27  

1547   5                                      
1548   5                                              frameMacCheck_PASS = 1;
1549   5                                              
1550   5                                      }else
1551   4                                      if((datsParam[3] == FRAME_MtoZIGBCMD_cmdCfg_swTim) || //ÌØÊâÖ¸Áî²»×öÐ£ÑéÂë¼ì²â
1552   4                                         (datsParam[3] == FRAME_MtoZIGBCMD_cmdswTimQuery)){
1553   5                                         
1554   5                                              frameCodeCheck_PASS = 1;
1555   5                                      }
1556   4                                         
1557   4                                      if(frameCodeCheck_PASS && frameCodeCheck_PASS)frameCheck_Done = 1;
1558   4                              }
1559   3                                 
1560   3                              if(frameCheck_Done){ //Ö¡¼ì²éÍ¨¹ý£¬¿ªÊ¼½âÎö¡¢¶¯×÷¼°ÏìÓ¦
1561   4                                      
1562   4                                      bit respond_IF          = 0;    //ÊÇ·ñ»Ø¸´
1563   4                                      bit specialCmd_IF       = 0;    //ÊÇ·ñÎªÌØÊâÖ¸Áî£¨ÌØÊâÖ¸ÁîÕ¼ÓÃ¿ª¹ØÀàÐÍÄÇÒ»¸ö×Ö½Ú£©
1564   4                                      
1565   4      #if(DEBUG_LOGOUT_EN == 1)
1566   4                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
1567   5                                              u8 xdata log_buf[64];
1568   5                                              
1569   5                                              sprintf(log_buf, "cmdComing:%02X.\n", (int)datsParam[3]);
1570   5                                              PrintString1_logOut(log_buf);
1571   5                                      }                       
1572   4      #endif          
1573   4                                      memset(paramTX_temp, 0, sizeof(u8) * dataLen_dataParingNomal);
1574   4                              
1575   4                                      switch(datsParam[3]){
1576   5                                      
1577   5                                              case FRAME_MtoZIGBCMD_cmdConfigSearch:{
1578   6                                                      
1579   6                                                      if(!deviceLock_flag){ //Éè±¸ÊÇ·ñÉÏËø
1580   7                                                              
1581   7                                                              u16 xdata panid_Temp = ZigB_getPanIDCurrent(); //ÅäÖÃ»Ø¸´Ìí¼ÓPANID
1582   7                                                              
1583   7                                                              paramTX_temp[14] = (u8)((panid_Temp & 0xFF00) >> 8);
1584   7                                                              paramTX_temp[15] = (u8)((panid_Temp & 0x00FF) >> 0);
1585   7                                                              
1586   7                                                              sysTimeZone_H = datsParam[12];
1587   7                                                              sysTimeZone_M = datsParam[13];
1588   7                                                              coverEEPROM_write_n(EEPROM_ADDR_timeZone_H, &sysTimeZone_H, 1);
1589   7                                                              coverEEPROM_write_n(EEPROM_ADDR_timeZone_M, &sysTimeZone_M, 1);
1590   7                                                      
1591   7                                                              respond_IF              = 1; //ÏìÓ¦»Ø¸´
1592   7                                                              specialCmd_IF   = 0;
1593   7                                                              
1594   7                                                      }else{
1595   7                                                      
1596   7                                                              
1597   7                                                      }
1598   6                                                      
1599   6                                              }break;
1600   5                                              
1601   5                                              case FRAME_MtoZIGBCMD_cmdControl:{
1602   6      
1603   6                                                      paramTX_temp[11] = 0;
1604   6                                                      paramTX_temp[11] |= (datsParam[11] & 0x07);     //×´Ì¬Î»Ìî×°
1605   6                                                      if(             (datsParam[11] & 0x01) != (status_Relay & 0x01))paramTX_temp[11] |= 0x20; //¸ü¸ÄÖµÌî×°<¸ßÈýÎ»>µ
             -ÚÒ»Î»
1606   6                                                      else if((datsParam[11] & 0x02) != (status_Relay & 0x02))paramTX_temp[11] |= 0x40; //¸ü¸ÄÖµÌî×°<¸ßÈýÎ
             -»>µÚ¶þÎ»
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 28  

1607   6                                                      else if((datsParam[11] & 0x04) != (status_Relay & 0x04))paramTX_temp[11] |= 0x80; //¸ü¸ÄÖµÌî×°<¸ßÈýÎ
             -»>µÚÈýÎ»
1608   6                                                      
1609   6                                                      swCommand_fromUsr.objRelay = datsParam[11];
1610   6                                                      swCommand_fromUsr.actMethod = relay_OnOff;
1611   6      
1612   6                                                      respond_IF              = 1; //ÏìÓ¦»Ø¸´
1613   6                                                      specialCmd_IF   = 0;                                                    
1614   6                                                      
1615   6                                              }break;
1616   5                                                      
1617   5                                              case FRAME_MtoZIGBCMD_cmdQuery:{}break;
1618   5                                                      
1619   5                                              case FRAME_MtoZIGBCMD_cmdInterface:{}break;
1620   5                                                      
1621   5                                              case FRAME_MtoZIGBCMD_cmdReset:{}break;
1622   5                                                      
1623   5                                              case FRAME_MtoZIGBCMD_cmdDevLockON:{
1624   6                                              
1625   6                                                      //Êý¾Ý´¦Àí¼°¶¯×÷ÏìÓ¦
1626   6                                                      {
1627   7                                                              u8 deviceLock_IF = 1;
1628   7                                                              
1629   7                                                              deviceLock_flag  = 1;
1630   7                                                              coverEEPROM_write_n(EEPROM_ADDR_deviceLockFLAG, &deviceLock_IF, 1);
1631   7                                                      }               
1632   6                                                      
1633   6                                              }break;
1634   5                                                      
1635   5                                              case FRAME_MtoZIGBCMD_cmdDevLockOFF:{
1636   6                                              
1637   6                                                      //Êý¾Ý´¦Àí¼°¶¯×÷ÏìÓ¦
1638   6                                                      {
1639   7                                                              u8 deviceLock_IF = 0;
1640   7                                                              
1641   7                                                              deviceLock_flag  = 0;
1642   7                                                              coverEEPROM_write_n(EEPROM_ADDR_deviceLockFLAG, &deviceLock_IF, 1);
1643   7                                                      }       
1644   6                                              
1645   6                                              }break;
1646   5                                                      
1647   5                                              case FRAME_MtoZIGBCMD_cmdswTimQuery:{
1648   6                                              
1649   6                                                      //·ÖÀà»Ø¸´
1650   6                                                      switch(datsParam[13]){ //×ÓÃüÁî½âÎö
1651   7                                                      
1652   7                                                              case 0: /*ÉÏÎ»»úÔÚ¶¨Ê±µÄÊ±ºò¸ø0£¬´ýÐ­ÉÌ*/
1653   7                                                              case cmdConfigTim_normalSwConfig:{
1654   8                                                              
1655   8                                                                      u8 loop = 0;
1656   8                                                              
1657   8                                                                      //Êý¾ÝÏìÓ¦¼°»Ø¸´
1658   8                                                                      EEPROM_read_n(EEPROM_ADDR_swTimeTab, &paramTX_temp[14], 12);    //¶¨Ê±±í»Ø¸´Ìî×°
1659   8                                                                      
1660   8                                                                      //»Ø¸´Êý¾Ý¶þ´Î´¦Àí£¨Õë¶ÔÒ»´ÎÐÔ¶¨Ê±Êý¾Ý£©
1661   8                                                                      for(loop = 0; loop < 4; loop ++){
1662   9                                                                      
1663   9                                                                              if(swTim_onShoot_FLAG & (1 << loop)){
1664  10                                                                                      
1665  10                                                                                      paramTX_temp[14 + loop * 3] &= 0x80;
1666  10                                                                              }
1667   9                                                                      }
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 29  

1668   8                                                                                      
1669   8                                                                      specialCmd_IF = 1; //ÌØÊâÕ¼Î»Ö¸Áî
1670   8                                                                      
1671   8                                                              }break;
1672   7                                                              
1673   7                                                              case cmdConfigTim_onoffDelaySwConfig:{
1674   8                                                              
1675   8                                                                      if(!delayCnt_onoff)paramTX_temp[14] = 0;
1676   8                                                                      else paramTX_temp[14] = delayPeriod_onoff - (u8)(delayCnt_onoff / 60);
1677   8                                                                      paramTX_temp[15] = delayUp_act;
1678   8                                                                      
1679   8                                                              }break;
1680   7                                                              
1681   7                                                              case cmdConfigTim_closeLoopSwConfig:{
1682   8                                                              
1683   8                                                                      paramTX_temp[14] = delayPeriod_closeLoop;
1684   8                                                                      
1685   8                                                              }break;
1686   7                                                              
1687   7                                                              case cmdConfigTim_nightModeSwConfig:{  
1688   8                                                              
1689   8                                                                      EEPROM_read_n(EEPROM_ADDR_TimeTabNightMode, &paramTX_temp[14], 6);      //Ò¹¼äÄ£Ê½¶¨Ê±±í»Ø¸´Ìî×°
1690   8                                                                      
1691   8                                                                      (deviceLock_flag)?(paramTX_temp[12] |= 0x01):(paramTX_temp[12] &= ~0x01);
1692   8                                                                      (ifNightMode_sw_running_FLAG)?(paramTX_temp[12] |= 0x02):(paramTX_temp[12] &= ~0x02);
1693   8                                                                      
1694   8                                                              }break;
1695   7                                                              
1696   7                                                              default:break;
1697   7                                                      }
1698   6                                                      
1699   6                                                      paramTX_temp[13] = datsParam[13]; //¶¨Ê±×ÓÃüÁîÍ¬²½»Ø¸´
1700   6                                                      
1701   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1702   6                                                      
1703   6                                              }break;
1704   5                                                      
1705   5                                              case FRAME_MtoZIGBCMD_cmdConfigAP:{}break;
1706   5                                                      
1707   5                                              case FRAME_MtoZIGBCMD_cmdBeepsON:{ //Ò¹¼äÄ£Ê½¹Ø
1708   6                                              
1709   6                                                      u8 datsTemp = 0;
1710   6                                                      
1711   6                                                      EEPROM_read_n(EEPROM_ADDR_TimeTabNightMode, &datsTemp, 1);
1712   6                                                      datsTemp &= ~0x7f; //Ò¹¼äÄ£Ê½¶¨Ê±±í´æ´¢,È¡ÏûÍ·×Ö½ÚÈ«Õ¼Âú,Ê§ÄÜÈ«Ìì
1713   6                                                      coverEEPROM_write_n(EEPROM_ADDR_TimeTabNightMode, &datsTemp, 1);
1714   6                                                      
1715   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1716   6                                                      
1717   6                                              }break;
1718   5                                                      
1719   5                                              case FRAME_MtoZIGBCMD_cmdBeepsOFF:{ //Ò¹¼äÄ£Ê½¿ª
1720   6                                              
1721   6                                                      u8 datsTemp = 0;
1722   6                                                      
1723   6                                                      EEPROM_read_n(EEPROM_ADDR_TimeTabNightMode, &datsTemp, 1);
1724   6                                                      datsTemp |= 0x7f; //Ò¹¼äÄ£Ê½¶¨Ê±±í´æ´¢,Í·×Ö½ÚÈ«Õ¼Âú,Ç¿ÖÆÈ«Ìì
1725   6                                                      coverEEPROM_write_n(EEPROM_ADDR_TimeTabNightMode, &datsTemp, 1);        
1726   6                                                      
1727   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1728   6                                                      
1729   6                                              }break;
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 30  

1730   5                                                      
1731   5                                              case FRAME_MtoZIGBCMD_cmdftRecoverRQ:{
1732   6                                              
1733   6                                                      respond_IF = 1;
1734   6                                                      
1735   6                                              }break;
1736   5                                                      
1737   5                                              case FRAME_MtoZIGBCMD_cmdRecoverFactory:{
1738   6                                              
1739   6                                                      Factory_recover();
1740   6                                              
1741   6                                              }break;
1742   5                                                      
1743   5                                              case FRAME_MtoZIGBCMD_cmdCfg_swTim:{
1744   6                                                      
1745   6                                                      u8 loop = 0;
1746   6                                                      
1747   6                                                      switch(datsParam[13]){ //¶¨Ê±Êý¾Ý´¦Àí¼°¸üÐÂ,·ÖÀà´¦Àí
1748   7                                                      
1749   7                                                              case cmdConfigTim_normalSwConfig:{      /*ÆÕÍ¨¶¨Ê±*/
1750   8                                                                      
1751   8                                                                      for(loop = 0; loop < 4; loop ++){
1752   9                                                                      
1753   9                                                                              if(datsParam[14 + loop * 3] == 0x80){   /*Ò»´ÎÐÔ¶¨Ê±ÅÐ¶Ï*///ÖÜÕ¼Î»Îª¿Õ£¬¶ø¶¨Ê±Æ÷±»´ò¿ª£¬ËµÃ÷ÊÇÒ»´ÎÐ
             -Ô
1754  10                                                                              
1755  10                                                                                      swTim_onShoot_FLAG      |= (1 << loop); //Ò»´ÎÐÔ¶¨Ê±±êÖ¾¿ªÆô
1756  10                                                                                      datsParam[14 + loop * 3] |= (1 << (systemTime_current.time_Week - 1)); //Ç¿ÐÐ½øÐÐµ±Ç°ÖÜÕ¼Î»£¬µ±´
             -ÎÖ´ÐÐÍê±ÏºóÇå³ý
1757  10                                                                              }
1758   9                                                                      }
1759   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_swTimeTab, &datsParam[14], 12); //¶¨Ê±±í
1760   8      
1761   8                                                              }break;
1762   7                                                              
1763   7                                                              case cmdConfigTim_onoffDelaySwConfig:{  /*¿ª¹ØÑÓÊ±*/
1764   8                                                              
1765   8                                                                      if(datsParam[14]){
1766   9                                                                      
1767   9                                                                              ifDelay_sw_running_FLAG |= (1 << 1);
1768   9                                                                              delayPeriod_onoff               = datsParam[14];
1769   9                                                                              
1770   9                                                                              delayUp_act                             = datsParam[15];
1771   9                                                                              
1772   9                                                                              delayCnt_onoff                  = 0;
1773   9                                                                              
1774   9                                                                      }else{
1775   9                                                                      
1776   9                                                                              ifDelay_sw_running_FLAG &= ~(1 << 1);
1777   9                                                                              delayPeriod_onoff               = 0;
1778   9                                                                              delayCnt_onoff                  = 0;
1779   9                                                                      }
1780   8                                                                      
1781   8                                                              }break;
1782   7                                                              
1783   7                                                              case cmdConfigTim_closeLoopSwConfig:{   /*ÂÌÉ«¹¦ÄÜ(×Ô¶¯Ñ­»·¹Ø±Õ)*/
1784   8                                                              
1785   8                                                                      if(datsParam[14]){
1786   9                                                                      
1787   9                                                                              ifDelay_sw_running_FLAG |= (1 << 0);
1788   9                                                                              delayPeriod_closeLoop   = datsParam[14];
1789   9                                                                              delayCnt_closeLoop              = 0;
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 31  

1790   9                                                                      }else{
1791   9                                                                      
1792   9                                                                              ifDelay_sw_running_FLAG &= ~(1 << 0);
1793   9                                                                              delayPeriod_closeLoop   = 0;
1794   9                                                                              delayCnt_closeLoop              = 0;
1795   9                                                                      }
1796   8                                                                      
1797   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_swDelayFLAG, &ifDelay_sw_running_FLAG, 1);
1798   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_periodCloseLoop, &delayPeriod_closeLoop, 1);
1799   8                                                                      
1800   8                                                              }break;         
1801   7      
1802   7                                                              case cmdConfigTim_nightModeSwConfig:{  /*Ò¹¼äÄ£Ê½ ±³¹â°ëÁÁ*/
1803   8                                                              
1804   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_TimeTabNightMode, &datsParam[14], 6);   //Ò¹¼äÄ£Ê½¶¨Ê±±í´æ´¢
1805   8                                                                      
1806   8                                                              }break;
1807   7                                                              
1808   7                                                              default:break;
1809   7                                                      }
1810   6                                                      
1811   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1812   6                                                      
1813   6                                              }break;
1814   5                                              
1815   5                                              case FRAME_MtoZIGBCMD_cmdCfg_ctrlEachO:{
1816   6                                              
1817   6                                                      u8 loop = 0;
1818   6                                                      u8 effective_oprate = datsParam[12]; //ÓÐÐ§²Ù×÷Êý¾ÝÕ¼Î»»ñÈ¡
1819   6                                                      
1820   6                                                      for(loop = 0; loop < clusterNum_usr; loop ++){
1821   7                                                      
1822   7                                                              if((effective_oprate >> loop) & 0x01){ //ÓÐÐ§Êý¾ÝÅÐ¶Ï
1823   8                                                              
1824   8                                                                      coverEEPROM_write_n(EEPROM_ADDR_portCtrlEachOther + loop, &datsParam[14 + loop], 1);
1825   8                                                                      CTRLEATHER_PORT[loop] = datsParam[14 + loop];
1826   8                                                                      reConnectAfterDatsReq_IF = 1; //¼´¿Ì×¢²á»¥¿ØÍ¨Ñ¶´Ø¶Ë¿Ú
1827   8                                                              }
1828   7                                                      }
1829   6                                                      
1830   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1831   6                                              
1832   6                                              }break;
1833   5                                              
1834   5                                              case FRAME_MtoZIGBCMD_cmdQue_ctrlEachO:{
1835   6                                              
1836   6                                                      u8 loop = 0;
1837   6                                                      
1838   6                                                      for(loop = 0; loop < clusterNum_usr; loop ++){
1839   7                                                      
1840   7                                                              EEPROM_read_n(EEPROM_ADDR_portCtrlEachOther + loop, &paramTX_temp[14 + loop], 1);
1841   7                                                      }
1842   6                                                      
1843   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1844   6                                              
1845   6                                              }break;
1846   5                                                      
1847   5                                              case FRAME_MtoZIGBCMD_cmdCfg_ledBackSet:{
1848   6                                              
1849   6                                                      coverEEPROM_write_n(EEPROM_ADDR_ledSWBackGround, &datsParam[14], 1);
1850   6                                                      coverEEPROM_write_n(EEPROM_ADDR_ledSWBackGround + 1, &datsParam[15], 1);
1851   6                                                      tipsInsert_swLedBKG_ON  = datsParam[14];
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 32  

1852   6                                                      tipsInsert_swLedBKG_OFF = datsParam[15];
1853   6                                                      
1854   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1855   6                                              
1856   6                                              }break;
1857   5                                              
1858   5                                              case FRAME_MtoZIGBCMD_cmdQue_ledBackSet:{
1859   6                                              
1860   6                                                      EEPROM_read_n(EEPROM_ADDR_ledSWBackGround, &paramTX_temp[14], 1);
1861   6                                                      EEPROM_read_n(EEPROM_ADDR_ledSWBackGround + 1, &paramTX_temp[15], 1);
1862   6                                                      
1863   6                                                      respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1864   6                                              
1865   6                                              }break;
1866   5                                              
1867   5      //                                      case FRAME_MtoZIGBCMD_cmdCfg_scenarioSet:{
1868   5      //                                              
1869   5      //                                              u16 xdata panid_Temp = ZigB_getPanIDCurrent(); //ÅäÖÃ»Ø¸´Ìí¼ÓPANID
1870   5      //                                      
1871   5      //                                              bit opt_result = swScenario_oprateSave(datsParam[12], datsParam[14]);
1872   5      //                                              if(opt_result)paramTX_temp[12] = 0;
1873   5      //                                              else paramTX_temp[12] = 0x0A; //³¡¾°ÉèÖÃÎÞÐ§»Ø¸´£¨³¡¾°´æ´¢ÒÑÂú£©
1874   5      //                                              
1875   5      //                                              paramTX_temp[14] = (u8)((panid_Temp & 0xFF00) >> 8);
1876   5      //                                              paramTX_temp[15] = (u8)((panid_Temp & 0x00FF) >> 0);
1877   5      //                                              
1878   5      //                                              respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ£¨±¾µØ´æ´¢ÒÑ±»Õ¼Âú£©
1879   5      //                                      
1880   5      //                                      }break;
1881   5      //                                      
1882   5      //                                      case FRAME_MtoZIGBCMD_cmdCfg_scenarioCtl:{
1883   5      //                                              
1884   5      //                                              u8 sw_Act = swScenario_oprateCheck(datsParam[12]);
1885   5      //                                              if(sw_Act != SW_SCENCRAIO_ACTINVALID){ //ÈôË÷Òýµ½ÓÐÐ§²Ù×÷Î»
1886   5      //                                                      
1887   5      //                                                      swCommand_fromUsr.actMethod = relay_OnOff;
1888   5      //                                                      swCommand_fromUsr.objRelay = sw_Act;
1889   5      //                                              
1890   5      //                                                      paramTX_temp[12] = 0;
1891   5      //                                                      
1892   5      //                                              }else{ //ÈôÎÞ·¨Ë÷Òýµ½ÓÐÐ§²Ù×÷Î»
1893   5      //                                              
1894   5      //                                                      paramTX_temp[12] = 0x0A; //³¡¾°¿ØÖÆÎÞÐ§»Ø¸´£¨³¡¾°ºÅÎÞ·¨±»Ë÷Òý£©
1895   5      //                                              }
1896   5      //                                      
1897   5      //                                              respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1898   5      //                                      
1899   5      //                                      }break;
1900   5      //                                      
1901   5      //                                      case FRAME_MtoZIGBCMD_cmdCfg_scenarioDel:{
1902   5      //                                              
1903   5      //                                              swScenario_oprateDele(datsParam[12]);
1904   5      //                                              paramTX_temp[12] = 0;
1905   5      //                                      
1906   5      //                                              respond_IF = 1; //ÏìÓ¦»Ø¸´Ê¹ÄÜ
1907   5      //                                      
1908   5      //                                      }break;
1909   5                                              
1910   5                                              default:{
1911   6                                              
1912   6                                                      respond_IF = 0;
1913   6                                              
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 33  

1914   6                                              }break;
1915   5                                      }
1916   4                                      
1917   4                                      /*»Ø¸´ÏìÓ¦*/
1918   4                                      if(respond_IF){ //Êý¾Ý°ü»Ø¸´ÏìÓ¦¶¯×÷
1919   5                                      
1920   5                                              u8 datsTX_Len = 0;
1921   5                                              
1922   5                                              respond_IF = 0;
1923   5                                              
1924   5                                              datsTX_Len = dtasTX_loadBasic_CUST(dataFromRemote_IF,
1925   5                                                                                                                 paramTX_temp,
1926   5                                                                                                                 33,
1927   5                                                                                                                 FRAME_TYPE_StoM_RCVsuccess,
1928   5                                                                                                                 datsParam[3],
1929   5                                                                                                                 specialCmd_IF);
1930   5                                              
1931   5                                              heartBeatCount = 1; //»Ø¸´ÏìÓ¦µÖÏûÒ»´ÎÐÄÌø
1932   5                                              
1933   5                                              datsSend_request.nwkAddr = nwkAddr_from;
1934   5                                              datsSend_request.portPoint = port_from;
1935   5                                              memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
1936   5                                              memcpy(datsSend_request.datsTrans.dats, paramTX_temp, datsTX_Len);
1937   5                                              datsSend_request.datsTrans.datsLen = datsTX_Len;
1938   5                                              datsRcv_respond.datsTrans.datsLen = 0;
1939   5                                              devRunning_Status = status_dataTransRequestDatsSend;
1940   5                                      }
1941   4                              }
1942   3                      }break;
1943   2                      
1944   2                      /*ÐÄÌø_Íø¹ØÔÚÏß*/
1945   2                      case ZIGB_FRAMEHEAD_HEARTBEAT:{
1946   3                      
1947   3                              
1948   3                              
1949   3                      }break;
1950   2                      
1951   2                      /*ÐÄÌø_Íø¹ØÀëÏß*///internetÀëÏß£¬²»ÊÇzigbÍøÂçÀëÏß
1952   2                      case ZIGB_FRAMEHEAD_HBOFFLINE:{
1953   3                      
1954   3                              
1955   3                              
1956   3                      }break;
1957   2                      
1958   2                      default:{}break;
1959   2              }
1960   1      }
1961          
1962          /*zigbeeÖ÷Ïß³Ì*///¶¯×÷×èÈû´óÓÚ200msµÄº¯Êý¶¼ÉèÎª×´Ì¬»úÔËÐÐ£¬ÆäËüÐ¡ÓÚ200msº¯Êý£¬×èÈûÎ¬³Ö£¬·ñÔò×´Ì¬»ú¸´ÔÓ¶È¼Ó
             -´ó
1963          void thread_dataTrans(void){
1964   1              
1965   1              u8 code cmd_datsComing[2] = {0x44, 0x81};
1966   1      
1967   1      #define dataLen_zigbDatsTrans 96
1968   1              u8 xdata paramTX_temp[dataLen_zigbDatsTrans] = {0};
1969   1              u8 xdata paramRX_temp[dataLen_zigbDatsTrans] = {0};
1970   1              
1971   1              static bit heartBeat_cmdFLG = 0; //ÐÄÌøÆæÅ¼±êÖ¾
1972   1              
1973   1              /*zigbÖ÷Ïß³ÌÏµÍ³Ê±¼ä¸üÐÂ*/
1974   1              if(!sysTimeReales_counter){ 
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 34  

1975   2              
1976   2                      sysTimeReales_counter = PERIOD_SYSTIMEREALES;
1977   2                      getSystemTime_reales();
1978   2              }
1979   1              
1980   1              /*zigbÖ÷Ïß³Ì×´Ì¬»ú£º¸ù¾Ý×´Ì¬±êÖ¾ÔËÐÐ*/
1981   1              switch(devRunning_Status){
1982   2              
1983   2                      case status_passiveDataRcv:{
1984   3                              
1985   3                              if(devStatus_switch.statusChange_IF){ //×´Ì¬Ç¿ÖÆÇÐ»»Ê±£¬½«µ±Ç°×Ó×´Ì¬ÄÚ¾²Ì¬±äÁ¿³õÊ¼»¯ºóÔÙ½øÐÐÍâ²¿ÇÐ»»
1986   4                              
1987   4                                      devStatus_switch.statusChange_IF = 0;
1988   4                                      devRunning_Status = devStatus_switch.statusChange_standBy;
1989   4                                      
1990   4                                      break;
1991   4                              }
1992   3                              
1993   3                              {/*³õÊ¼»¯Ê±¼ä¸³Öµ*///½ö¿ª»ú¸³ÖµÒ»´Î£¬²»×öÊ±Çøµ÷Õû
1994   4                                      static bit FLG_timeSetInit = 1;
1995   4                                      
1996   4                                      if(FLG_timeSetInit){
1997   5                                      
1998   5                                              FLG_timeSetInit = 0;
1999   5                                              zigB_sysTimeSet(1533810700UL - 946713600UL, 0); //zigbeeÊ±¼ä´Á´Óunix¼ÍÔª946713600<2000/01/01 00:00:00
             ->¿ªÊ¼¼ÆËã
2000   5                                      }
2001   4                              }
2002   3                              
2003   3                              if(devTips_status == status_tipsNwkFind)tips_statusChangeToNormal(); //tips¸´Ô­(ÍøÂçÒÑ¼ÓÈë£¬»Ö¸´Õý³£tip
             -s)
2004   3              
2005   3                              //--------------------------------Ö÷×´Ì¬£ºÐÄÌø--------------------------------------------------------/
             -/
2006   3                              if(heartBeatCycle_FLG){
2007   4                              
2008   4                                      heartBeatCycle_FLG = 0;
2009   4                                      heartBeat_cmdFLG = !heartBeat_cmdFLG;
2010   4                                      
2011   4                                      memset(paramTX_temp, 0, sizeof(u8) * dataLen_zigbDatsTrans); //Çå»º´æ
2012   4                                      
2013   4                                      paramTX_temp[0] = ZIGB_FRAMEHEAD_HEARTBEAT;
2014   4                                      paramTX_temp[1] = 14;
2015   4                                      (heartBeat_cmdFLG)?(paramTX_temp[2] = FRAME_HEARTBEAT_cmdOdd):(paramTX_temp[2] = FRAME_HEARTBEAT_cmdEv
             -en);
2016   4                                      memcpy(&paramTX_temp[4], &MAC_ID[1], 5);
2017   4                                      
2018   4                                      if(heartBeat_cmdFLG){ //Ææ°ü
2019   5                                      
2020   5                                              
2021   5                                      
2022   5                                      }else{ //Å¼°ü
2023   5                                      
2024   5                                              
2025   5                                      }
2026   4                                      
2027   4                                      datsSend_request.nwkAddr = 0; //½ö¶ÔÍø¹Ø·¢ËÍ£¬½øÐÐÊý¾Ý×ª·¢
2028   4                                      datsSend_request.portPoint = ZIGB_ENDPOINT_CTRLNORMAL; //³£¹æÊý¾Ý×ª·¢×¨ÓÃ¶Ë¿Ú
2029   4                                      memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
2030   4                                      memcpy(datsSend_request.datsTrans.dats, paramTX_temp, 14);
2031   4                                      datsSend_request.datsTrans.datsLen = 14;
2032   4                                      datsRcv_respond.datsTrans.datsLen = 0;
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 35  

2033   4                                      devRunning_Status = status_dataTransRequestDatsSend;
2034   4                                      
2035   4                                      return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£³Ö£¬
             -µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
2036   4                              }
2037   3                              
2038   3                              //------------------------------Ö÷×´Ì¬£º±¾µØ¿ª¹ØÊÜ¼¯Èº¿ØÖÆ×´Ì¬Î»ÖÜÆÚÐÔÂÖÑ¯<°üÀ¨ÓÐ»¥¿ØºÍ³¡¾°>---------//
2039   3                              if(!colonyCtrlGet_queryCounter){
2040   4                              
2041   4                                      colonyCtrlGet_queryCounter = COLONYCTRLGET_QUERYPERIOD;
2042   4                                      
2043   4                                      /*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>frame reference<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
             -<<<<<<<<<<<<<<<<<<<<<<*/
2044   4                                      /*----------------------------------------------------------------------------------------------------
             -----------------------*/
2045   4                                      /*      frame_data[0]           |       frame_data[1]           |       frame_data[2...6]       |       frame_data[7]                   |       frame_data[8...10]      |
2046   4                                      /*----------------------------------------------------------------------------------------------------
             -----------------------*/
2047   4                                      /*      ÃüÁî                            |       Êý¾Ý³¤¶È                        |       ±¾»úMACµØÖ·                     |       ³¡¾°ËµÃ÷(ÔÝÎÞËµÃ÷)              |       »¥¿ØËµÃ÷(µ±Ç°×éºÅ)      |               
2048   4                                      /*----------------------------------------------------------------------------------------------------
             -----------------------*/
2049   4                                      memset(paramTX_temp, 0, sizeof(u8) * dataLen_zigbDatsTrans); //Çå»º´æ
2050   4                                      paramTX_temp[0] = ZIGB_SYSCMD_COLONYPARAM_REQPERIOD; //ÃüÁî
2051   4                                      paramTX_temp[1] = clusterNum_usr + 5 + 1; //Êý¾Ý³¤¶ÈËµÃ÷
2052   4                                      memcpy(&paramTX_temp[2], &MAC_ID[1], 5); //MACµØÖ·Ìî×°
2053   4                                      paramTX_temp[7] = 0; //³¡¾°ËµÃ÷×°ÔØ(ÎÞËµÃ÷£¬0Ìî³ä)
2054   4                                      memcpy(&paramTX_temp[8], CTRLEATHER_PORT, clusterNum_usr); //»¥¿ØËµÃ÷×°ÔØ(ËµÃ÷¶Ë¿ÚºÅ)
2055   4                                      
2056   4                                      datsSend_request.nwkAddr = 0; //½ö¶ÔÍø¹Ø·¢ËÍ
2057   4                                      datsSend_request.portPoint = ZIGB_ENDPOINT_CTRLSYSZIGB; //zigbÏµÍ³½»»¥×¨ÓÃ¶Ë¿Ú
2058   4                                      memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
2059   4                                      memcpy(datsSend_request.datsTrans.dats, paramTX_temp, paramTX_temp[1] + 2); 
2060   4                                      datsSend_request.datsTrans.datsLen = paramTX_temp[1] + 2;
2061   4                                      datsRcv_respond.datsTrans.datsLen = 0; //²»ÐèÒªÔ¶¶ËÓ¦´ð
2062   4                                      devRunning_Status = status_dataTransRequestDatsSend;
2063   4                                      
2064   4                                      return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£³Ö£¬
             -µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
2065   4                              }
2066   3                              
2067   3                              //--------------------------------Ö÷×´Ì¬£ºÊý¾ÝÍÆËÍ---------------------------------------------------//
             -        
2068   3                              if(devActionPush_IF.push_IF){
2069   4                                      
2070   4                                      const bit dataFromRemote_IF = 1; //Ô¶³ÌÍÆËÍ
2071   4                                      const bit specialCmd_IF = 0; //·ÇÌØÊâÕ¼Î»
2072   4                                      
2073   4                                      u8 xdata datsTX_Len = 0;
2074   4                                      
2075   4                                      devActionPush_IF.push_IF = 0;
2076   4                                      
2077   4                                      memset(paramTX_temp, 0, sizeof(u8) * dataLen_zigbDatsTrans); //Çå»º´æ
2078   4                                      
2079   4                                      paramTX_temp[11] = devActionPush_IF.dats_Push; //ÍÆËÍÐÅÏ¢Ìî×°
2080   4      
2081   4      #if(DEBUG_LOGOUT_EN == 1)
2082   4                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2083   5                                              u8 xdata log_buf[64];
2084   5                                              
2085   5                                              sprintf(log_buf, "swData push:%02X.\n", (int)devActionPush_IF.dats_Push);
2086   5                                              PrintString1_logOut(log_buf);
2087   5                                      }                       
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 36  

2088   4      #endif  
2089   4                                      datsTX_Len = dtasTX_loadBasic_CUST(dataFromRemote_IF,
2090   4                                                                                                         paramTX_temp,
2091   4                                                                                                         33,
2092   4                                                                                                         FRAME_TYPE_StoM_RCVsuccess,
2093   4                                                                                                         FRAME_MtoZIGBCMD_cmdControl,
2094   4                                                                                                         specialCmd_IF);
2095   4                              
2096   4                                      datsSend_request.nwkAddr = 0; //½ö¶ÔÍø¹Ø·¢ËÍ£¬½øÐÐÊý¾Ý×ª·¢
2097   4                                      datsSend_request.portPoint = ZIGB_ENDPOINT_CTRLNORMAL; //³£¹æÊý¾Ý×ª·¢×¨ÓÃ¶Ë¿Ú
2098   4                                      memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
2099   4                                      memcpy(datsSend_request.datsTrans.dats, paramTX_temp, datsTX_Len);
2100   4                                      datsSend_request.datsTrans.datsLen = datsTX_Len;
2101   4                                      datsRcv_respond.datsTrans.datsLen = 0; //ÎÞÐèÔ¶¶ËÓ¦´ð
2102   4                                      devRunning_Status = status_dataTransRequestDatsSend; //Ö±½ÓÇÐ»»£¨²»×öÔ¤±¸¶¯×÷£©
2103   4      
2104   4                                      return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£³Ö£¬
             -µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
2105   4                              }
2106   3                              
2107   3                              //--------------------------------Ö÷×´Ì¬£º»¥¿ØÍ¬²½---------------------------------------------------//
2108   3                              if(EACHCTRL_realesFLG){ //¹ã²¥»¥¿ØÖµ
2109   4                              
2110   4                                      if(devRunning_Status == status_passiveDataRcv){
2111   5                                      
2112   5                                              u8 idata loop;
2113   5                                              
2114   5                                              for(loop = 0; loop < clusterNum_usr; loop ++){ //Èý¸ö¿ª¹ØÎ»·Ö±ðÅÐ¶¨
2115   6                                              
2116   6                                                      if(EACHCTRL_realesFLG & (1 << loop)){ //»¥¿ØÓÐÐ§Î»ÅÐ¶Ï
2117   7                                                      
2118   7                                                              EACHCTRL_realesFLG &= ~(1 << loop); //»¥¿ØÓÐÐ§Î»ÇåÁã
2119   7                                                              
2120   7                                                              paramTX_temp[0] = (status_Relay >> loop) & 0x01; //¿ª¹Ø×´Ì¬Ìî×°
2121   7                                                              
2122   7                                                              if((CTRLEATHER_PORT[loop] > CTRLEATHER_PORT_NUMSTART) && CTRLEATHER_PORT[loop] < CTRLEATHER_PORT_NU
             -MTAIL){ //ÊÇ·ñÎªÓÐÐ§»¥¿Ø¶Ë¿Ú
2123   8                                                                      
2124   8                                                                      (paramTX_temp[0])?(colonyCtrlGet_statusLocalEaCtrl[loop] = STATUSLOCALEACTRL_VALMASKRESERVE_ON):(c
             -olonyCtrlGet_statusLocalEaCtrl[loop] = STATUSLOCALEACTRL_VALMASKRESERVE_OFF); //±¾µØ»¥¿Ø×´Ì¬¸üÐÂ
2125   8                                                                      colonyCtrlGet_queryCounter = COLONYCTRLGET_QUERYPERIOD; //¼¯ÈºÐÅÏ¢²éÑ¯Ö÷¶¯ÖÍºó£¬ÒÔ·ÀÓëÖ÷»ú¼¯ÈºÐÅÏ¢
             -Î´¸üÐÂ£¬µ¼ÖÂÓë±¾µØÐÅÏ¢³åÍ»
2126   8                                                              
2127   8                                                                      datsSend_request.nwkAddr = 0xffff; //¼ä½Ó×é²¥£¨¶Ô»¥¿Ø×¨ÓÃ¶Ë¿Ú½øÐÐ¹ã²¥£©
2128   8                                                                      datsSend_request.portPoint = CTRLEATHER_PORT[loop]; //»¥¿ØÎ»¶ÔÓ¦°ó¶¨¶Ë¿Ú
2129   8                                                                      memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
2130   8                                                                      memcpy(datsSend_request.datsTrans.dats, paramTX_temp, 1);
2131   8                                                                      datsSend_request.datsTrans.datsLen = 1;
2132   8                                                                      datsRcv_respond.datsTrans.datsLen = 0; //ÎÞÐèÔ¶¶ËÓ¦´ð
2133   8                                                                      
2134   8                                                                      devRunning_Status = status_dataTransRequestDatsSend; //Ö±½ÓÇÐ»»£¨²»×öÔ¤±¸¶¯×÷£©
2135   8                                                                      
2136   8                                                                      EACHCTRL_reportFLG = 1; //ÏòÍø¹Ø»ã±¨
2137   8                                                                      
2138   8                                                                      return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£
             -³Ö£¬µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
2139   8                                                              }
2140   7                                                      }
2141   6                                              }
2142   5                                      }       
2143   4                              }
2144   3                              
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 37  

2145   3                              if(EACHCTRL_reportFLG){ //ÏòÍø¹Øµ¥²¥µ±Ç°ËùÓÐ»¥¿Ø×éºÅ¶ÔÓ¦µÄ¿ª¹Ø×´Ì¬Öµ
2146   4                              
2147   4                                      EACHCTRL_reportFLG = 0;
2148   4                                      
2149   4                                      /*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>frame reference<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
             -<<<<<<*/
2150   4                                      /*----------------------------------------------------------------------------------------------------
             -------*/
2151   4                                      /*      frame_data[0]           |       frame_data[1]           |       frame_data[2/4/6]       |               frame_data[3/5/7]                       |
2152   4                                      /*----------------------------------------------------------------------------------------------------
             -------*/
2153   4                                      /*      ÃüÁî                            |       Êý¾Ý³¤¶È                        |       ±¾µØ»¥¿Ø¶Ë¿ÚºÅ          |       ±¾µØ»¥¿Ø¶Ë¿ÚºÅ¶ÔÓ¦¿ª¹Ø×´Ì¬Öµ    |
2154   4                                      /*----------------------------------------------------------------------------------------------------
             -------*/
2155   4                                      {
2156   5                                              u8 code remote_responseFrame[3] = {ZIGB_SYSCMD_EACHCTRL_REPORT, 0x01, 0x00}; //Ô¶¶ËÏìÓ¦Ö¡<È·±£Ö÷»úÊÕµ
             -½>
2157   5                                              
2158   5      #if(DEBUG_LOGOUT_EN == 1)
2159   5                                              { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2160   6                                                      u8 xdata log_buf[64];
2161   6                                                      
2162   6                                                      sprintf(log_buf, "current eaCtrl insrt[2] is: %02X.\n", (int)colonyCtrlGet_statusLocalEaCtrl[1]);
2163   6                                                      PrintString1_logOut(log_buf);
2164   6                                              }                       
2165   5      #endif  
2166   5                                              
2167   5                                              memset(datsSend_request.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8));
2168   5                                              datsSend_request.datsTrans.dats[0]      = ZIGB_SYSCMD_EACHCTRL_REPORT;
2169   5                                              datsSend_request.datsTrans.dats[1]      = 6;
2170   5                                              datsSend_request.datsTrans.dats[2]      = CTRLEATHER_PORT[0];
2171   5                                              datsSend_request.datsTrans.dats[3]      = colonyCtrlGet_statusLocalEaCtrl[0];
2172   5                                              datsSend_request.datsTrans.dats[4]      = CTRLEATHER_PORT[1];
2173   5                                              datsSend_request.datsTrans.dats[5]      = colonyCtrlGet_statusLocalEaCtrl[1];
2174   5                                              datsSend_request.datsTrans.dats[6]      = CTRLEATHER_PORT[2];
2175   5                                              datsSend_request.datsTrans.dats[7]      = colonyCtrlGet_statusLocalEaCtrl[2];
2176   5                                              datsSend_request.datsTrans.datsLen      = 8;
2177   5                                              datsSend_request.nwkAddr                        = 0;
2178   5                                              datsSend_request.portPoint                      = ZIGB_ENDPOINT_CTRLSYSZIGB;
2179   5                                              
2180   5                                              memset(datsRcv_respond.datsTrans.dats, 0, DATBASE_LENGTH * sizeof(u8)); //ÐèÒªÔ¶¶ËÏìÓ¦
2181   5                                              memcpy(datsRcv_respond.datsTrans.dats, remote_responseFrame, 3); //Ô¶¶ËÏìÓ¦Ö¡¼ÓÔØ
2182   5                                              datsRcv_respond.datsTrans.datsLen       = 3;
2183   5                                              datsRcv_respond.nwkAddr                         = 0;
2184   5                                              datsRcv_respond.portPoint                       = ZIGB_ENDPOINT_CTRLSYSZIGB;
2185   5                                              
2186   5                                              devRunning_Status = status_dataTransRequestDatsSend; //Ö±½ÓÇÐ»»£¨²»×öÔ¤±¸¶¯×÷£©
2187   5                                      }
2188   4                                      
2189   4                                      return; //Ô½¹ý±¾´Îµ÷¶È£¬Õ¼ÓÃÊý¾Ý·¢ËÍ×´Ì¬¸ü¸ÄÈ¨£¬ÏÈµ½ÏÈµÃ£¬ÆäËüÐèÒª¸ü¸ÄÊý¾Ý·¢ËÍÈ¨µÄÒµÎñ£¬·¢ËÍ×´Ì¬±£³Ö£¬
             -µÈ´ýÏÈÐÐÒµÎñÊý¾Ý·¢ËÍÍê±Ï
2190   4                              }
2191   3                              
2192   3                              //--------------------------------Ö÷×´Ì¬£ºÊý¾Ý½âÎöÏìÓ¦-----------------------------------------------//
2193   3                              if(uartRX_toutFLG){ //Êý¾Ý½ÓÊÕ(Ö¡³¬Ê±)
2194   4                                      
2195   4                                      uartRX_toutFLG = 0;
2196   4                                      
2197   4                                      /*ZigbeeÒ»¼¶Ð­ÒéºË¶Ô½âÎö*/
2198   4                                      if((datsRcv_ZIGB.rcvDats[0] == ZIGB_FRAME_HEAD) &&
2199   4                                              !memcmp(&datsRcv_ZIGB.rcvDats[2], cmd_datsComing, 2)){
2200   5                                              
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 38  

2201   5                                              u16 idata datsFrom_addr = ((u16)(datsRcv_ZIGB.rcvDats[9]) << 8) | ((u16)(datsRcv_ZIGB.rcvDats[8]) << 
             -0); //Êý¾Ý·¢ËÍ·½ÍøÂçµØÖ·
2202   5                                              u8      idata srcPoint =  datsRcv_ZIGB.rcvDats[10];     //Ô´¶Ë
2203   5                                              u8      idata dstPoint =  datsRcv_ZIGB.rcvDats[11];     //Ô¶¶Ë
2204   5                                                      
2205   5                                              devTips_nwkZigb = nwkZigb_Normal; //zigbTips×´Ì¬ÏìÓ¦£¬Ö»Òª½ÓÊÕµ½zigbÊý¾Ý£¬tips×´Ì¬¾ÍÇÐ»»ÖÁÕý³£
2206   5                                              
2207   5                                              memset(paramRX_temp, 0, sizeof(u8) * dataLen_zigbDatsTrans);
2208   5                                              memcpy(paramRX_temp, &(datsRcv_ZIGB.rcvDats[21]), datsRcv_ZIGB.rcvDats[20]);
2209   5                                                      
2210   5                                              if(srcPoint > CTRLEATHER_PORT_NUMSTART && srcPoint < CTRLEATHER_PORT_NUMTAIL){ /*»¥¿Ø¶Ë¿Ú*/
2211   6                                                      
2212   6                                                      u8 idata statusRelay_temp = status_Relay; //µ±Ç°¿ª¹Ø×´Ì¬»º´æ
2213   6                                                      
2214   6                                                      colonyCtrlGet_queryCounter = COLONYCTRLGET_QUERYPERIOD; //¼¯ÈºÐÅÏ¢²éÑ¯Ö÷¶¯ÖÍºó£¬ÒÔ·ÀÓëÖ÷»ú¼¯ÈºÐÅÏ¢Î´
             -¸üÐÂ£¬µ¼ÖÂÓë±¾µØÐÅÏ¢³åÍ»
2215   6                                                      
2216   6      #if(DEBUG_LOGOUT_EN == 1)
2217   6                                                      { //Êä³ö´òÓ¡£¬½÷¼Ç ÓÃºó×¢ÊÍ£¬·ñÔòÕ¼ÓÃ´óÁ¿´úÂë¿Õ¼ä
2218   7                                                              u8 xdata log_buf[64];
2219   7                                                              
2220   7                                                              sprintf(log_buf, "ctrl eachOther cmd coming, cluster:%02d.\n", (int)srcPoint);
2221   7                                                              PrintString1_logOut(log_buf);
2222   7                                                      }                       
2223   6      #endif  
2224   6                                                      if((srcPoint == CTRLEATHER_PORT[0]) && (0 != CTRLEATHER_PORT[0])){ //¿ª¹ØÎ»1 »¥¿Ø°ó¶¨ÅÐ¶Ï
2225   7                                                      
2226   7                                                              swCommand_fromUsr.actMethod = relay_OnOff;
2227   7                                                              statusRelay_temp &= ~(1 << 0); //¶¯×÷Î»»º´æÇåÁã
2228   7                                                              swCommand_fromUsr.objRelay = statusRelay_temp | paramRX_temp[0] << 0; //bit0 ¿ª¹ØÎ»¶¯×÷ÏìÓ¦
2229   7                                                              (paramRX_temp[0])?(colonyCtrlGet_statusLocalEaCtrl[0] = STATUSLOCALEACTRL_VALMASKRESERVE_ON):(colon
             -yCtrlGet_statusLocalEaCtrl[0] = STATUSLOCALEACTRL_VALMASKRESERVE_OFF); //±¾µØ»¥¿ØÂÖÑ¯Öµ¸üÐÂ
2230   7                                                      }
2231   6                                                      else
2232   6                                                      if((srcPoint == CTRLEATHER_PORT[1]) && (0 != CTRLEATHER_PORT[1])){ //¿ª¹ØÎ»2 »¥¿Ø°ó¶¨ÅÐ¶Ï
2233   7                                                      
2234   7                                                              swCommand_fromUsr.actMethod = relay_OnOff;
2235   7                                                              statusRelay_temp &= ~(1 << 1); //¶¯×÷Î»»º´æÇåÁã
2236   7                                                              swCommand_fromUsr.objRelay = statusRelay_temp | paramRX_temp[0] << 1; //bit1 ¿ª¹ØÎ»¶¯×÷ÏìÓ¦
2237   7                                                              (paramRX_temp[0])?(colonyCtrlGet_statusLocalEaCtrl[1] = STATUSLOCALEACTRL_VALMASKRESERVE_ON):(colon
             -yCtrlGet_statusLocalEaCtrl[1] = STATUSLOCALEACTRL_VALMASKRESERVE_OFF); //±¾µØ»¥¿ØÂÖÑ¯Öµ¸üÐÂ
2238   7                                                      }
2239   6                                                      else
2240   6                                                      if((srcPoint == CTRLEATHER_PORT[2]) && (0 != CTRLEATHER_PORT[2])){ //¿ª¹ØÎ»3 »¥¿Ø°ó¶¨ÅÐ¶Ï
2241   7                                                      
2242   7                                                              swCommand_fromUsr.actMethod = relay_OnOff;
2243   7                                                              statusRelay_temp &= ~(1 << 2); //¶¯×÷Î»»º´æÇåÁã
2244   7                                                              swCommand_fromUsr.objRelay = statusRelay_temp | paramRX_temp[0] << 2; //bit2 ¿ª¹ØÎ»¶¯×÷ÏìÓ¦
2245   7                                                              (paramRX_temp[0])?(colonyCtrlGet_statusLocalEaCtrl[2] = STATUSLOCALEACTRL_VALMASKRESERVE_ON):(colon
             -yCtrlGet_statusLocalEaCtrl[2] = STATUSLOCALEACTRL_VALMASKRESERVE_OFF); //±¾µØ»¥¿ØÂÖÑ¯Öµ¸üÐÂ
2246   7                                                      }
2247   6                                                      
2248   6                                                      devActionPush_IF.push_IF = 1; //ÍÆËÍÊ¹ÄÜ
2249   6                                              
2250   6                                              }else{ /*·Ç»¥¿Ø¶Ë¿Ú*///Ê£ÏÂ¾ÍÊÇÏµÍ³×¨ÓÃµÄ15¸ö¶Ë¿Ú
2251   6                                              
2252   6                                                      switch(srcPoint){
2253   7                                                              
2254   7                                                              /*³¡¾°¼¯Èº¶Ë¿Ú*/
2255   7                                                              case ZIGB_ENDPOINT_CTRLSECENARIO:{      
2256   8                                                              
2257   8                                                                      dataParing_scenarioCtrl(paramRX_temp); //³¡¾°¼¯Èº¿ØÖÆ½âÎö
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 39  

2258   8                                                                      
2259   8                                                              }break;
2260   7                                                      
2261   7                                                              /*³£¹æ¿ØÖÆ×ª·¢¶Ë¿Ú*/
2262   7                                                              case ZIGB_ENDPOINT_CTRLNORMAL:{ 
2263   8                                                              
2264   8                                                                      if(datsFrom_addr == ZIGB_NWKADDR_CORDINATER){ //À´×ÔÐ­µ÷Æ÷
2265   9                                                                      
2266   9                                                                              dataParing_Nomal(paramRX_temp, datsFrom_addr, srcPoint); //³£¹æ½âÎö
2267   9                                                                      }
2268   8                                                                      
2269   8                                                              }break;
2270   7                                                              
2271   7                                                              /*zigbÏµÍ³½»»¥¶Ë¿Ú*/
2272   7                                                              case ZIGB_ENDPOINT_CTRLSYSZIGB:{        
2273   8                                                              
2274   8                                                                      dataParing_zigbSysCtrl(paramRX_temp); //ÏµÍ³¿ØÖÆ½âÎö
2275   8                                                                      
2276   8                                                              }break;
2277   7                                                                      
2278   7                                                              default:{
2279   8                                                              
2280   8                                                                      
2281   8                                                                      
2282   8                                                              }break;
2283   7                                                      }
2284   6                                              }
2285   5                                      }
2286   4                              }
2287   3                              
2288   3                      }break;
2289   2                      
2290   2                      case status_nwkREQ:{
2291   3                      
2292   3                              //--------------------------------Ð­×´Ì¬£ºÍøÂçÇëÇó-----------------------------------------------//
2293   3                              devTips_nwkZigb = nwkZigb_nwkREQ;
2294   3                              zigB_nwkJoinRequest(1); //·Ç×èÈûÖ÷¶¯¼ÓÈë¸½½ü¿ª·ÅÍøÂç
2295   3                              
2296   3                      }break;
2297   2                              
2298   2                      case status_nwkReconnect:{
2299   3                      
2300   3                              //--------------------------------Ð­×´Ì¬£ºµôÏß´¦Àí-----------------------------------------------//
2301   3                              devTips_nwkZigb = nwkZigb_reConfig;
2302   3                              zigB_nwkJoinRequest(0); //·Ç×èÈûÖØÁ¬
2303   3                              
2304   3                      }break;
2305   2                      
2306   2                      case status_dataTransRequestDatsSend:{
2307   3                              
2308   3                              //--------------------------------Ð­×´Ì¬£ºÊý¾ÝÇëÇó-----------------------------------------------//
2309   3                              dataTransRequest_datsSend(); //·Ç×èÈûÔ¶¶ËÊý¾Ý´«Êä
2310   3                      
2311   3                      }break;
2312   2                      
2313   2                      case status_devNwkHold:{
2314   3                      
2315   3                              //--------------------------------Ð­×´Ì¬£ºÍøÂç¹ÒÆð-----------------------------------------------//
2316   3                              devTips_nwkZigb = nwkZigb_hold;
2317   3                              function_devNwkHold();
2318   3                              
2319   3                      }break;
C51 COMPILER V9.54   DATATRANS                                                             09/30/2018 16:43:38 PAGE 40  

2320   2                              
2321   2                      default:{
2322   3                      
2323   3                              if(devStatus_switch.statusChange_IF){ //×´Ì¬Ç¿ÖÆÇÐ»»Ê±£¬½«µ±Ç°×Ó×´Ì¬ÄÚ¾²Ì¬±äÁ¿³õÊ¼»¯ºóÔÙ½øÐÐÍâ²¿ÇÐ»»
2324   4                              
2325   4                                      devStatus_switch.statusChange_IF = 0;
2326   4                                      devRunning_Status = devStatus_switch.statusChange_standBy;
2327   4                                      
2328   4                                      break;
2329   4                              }
2330   3                      
2331   3                      }break;
2332   2              }
2333   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   7692    ----
   CONSTANT SIZE    =   3172    ----
   XDATA SIZE       =    292    1886
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12     139
   IDATA SIZE       =   ----      11
   BIT SIZE         =      7      17
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
